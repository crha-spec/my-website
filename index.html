<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; display:flex; height:100vh; }
    #sidebar { width:220px; background:#222; color:white; padding:20px; display:flex; flex-direction:column; }
    #sidebar h2 { font-size:18px; margin-bottom:12px; }
    #sidebar button { margin:6px 0; padding:10px; cursor:pointer; background:#444; color:white; border:none; border-radius:6px; text-align:left; transition: all 0.2s ease; }
    #sidebar button:hover { background:#666; }
    #sidebar button.active { background:#1976d2; }
    #content { flex:1; padding:20px; overflow:auto; background:#f6f7fb; }
    .panel { display:none; background:white; padding:16px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .panel.active { display:block; animation: fadeIn 0.3s ease; }
    input, file { padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    button.action { padding:10px 14px; margin-top:8px; cursor:pointer; background:#1976d2; color:white; border:none; border-radius:6px; }
    ul { list-style:none; padding:0; }
    li { padding:8px 0; border-bottom:1px solid #eee; }
    audio { width:100%; max-width:600px; margin-top:6px; }
    .hint { color:#555; font-size:13px; }
    .ok { color:green; }
    .error { color:red; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>MenÃ¼</h2>
    <button type="button" id="libraryBtn" class="active" onclick="showPanel('library')">ðŸ“€ KitaplÄ±k</button>
    <button type="button" id="requestBtn" onclick="showPanel('request')">âž• ÅžarkÄ± Ä°steÄŸi</button>
    <button type="button" id="adminBtn" style="display:none" onclick="showPanel('admin')">ðŸŽ§ Admin Paneli</button>
    <button type="button" id="requestsBtn" style="display:none" onclick="showPanel('requests')">ðŸ“¨ Ä°stekler</button>
  </div>

  <!-- Content -->
  <div id="content">
    <div id="library" class="panel active">
      <h2>ðŸ“€ MÃ¼zik KitaplÄ±ÄŸÄ±</h2>
      <ul id="songs-list"></ul>
      <p id="library-msg" class="hint"></p>
    </div>

    <div id="request" class="panel">
      <h2>âž• ÅžarkÄ± Ä°steÄŸi GÃ¶nder</h2>
      <label>ÅžarkÄ± AdÄ±</label>
      <input id="req-name" />
      <label>SanatÃ§Ä±</label>
      <input id="req-artist" />
      <label>Dosya (mp3)</label>
      <input type="file" id="req-file" accept="audio/*" />
      <button class="action" onclick="sendRequest()">Ä°stek GÃ¶nder</button>
      <p id="req-msg" class="hint"></p>
    </div>

    <div id="admin" class="panel">
      <h2>ðŸŽ§ Admin Paneli</h2>
      <label>ÅžarkÄ± AdÄ±</label>
      <input id="song-name" />
      <label>SanatÃ§Ä±</label>
      <input id="song-artist" />
      <label>Dosya URL (catbox/mp3 linki)</label>
      <input id="song-url" />
      <button class="action" onclick="addSong()">ÅžarkÄ±yÄ± Ekle</button>
      <p id="admin-msg" class="hint"></p>
    </div>

    <div id="requests" class="panel">
      <h2>ðŸ“¨ KullanÄ±cÄ± ÅžarkÄ± Ä°stekleri</h2>
      <ul id="requests-list"></ul>
    </div>
  </div>

  <!-- Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- SENÄ°N SUPABASE BÄ°LGÄ°LERÄ°N (geri koydum) ---
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ADMIN IP (senin verdiÄŸin) ---
    const ADMIN_IP = "151.250.4.2";
    let currentIp = null;

    function showPanel(id) {
      // TÃ¼m panelleri gizle
      document.querySelectorAll('.panel').forEach(p => {
        p.classList.remove('active');
      });
      
      // TÃ¼m butonlardan aktif sÄ±nÄ±fÄ±nÄ± kaldÄ±r
      document.querySelectorAll('#sidebar button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Ä°lgili paneli gÃ¶ster
      document.getElementById(id).classList.add('active');
      
      // Ä°lgili butona aktif sÄ±nÄ±fÄ± ekle
      document.getElementById(id + 'Btn').classList.add('active');
      
      // EÄŸer kitaplÄ±k paneli gÃ¶steriliyorsa ÅŸarkÄ±larÄ± yeniden yÃ¼kle
      if (id === 'library') {
        loadSongs();
      }
      
      // EÄŸer admin istekler paneli gÃ¶steriliyorsa istekleri yeniden yÃ¼kle
      if (id === 'requests' && currentIp === ADMIN_IP) {
        loadRequests();
      }
    }

    async function init() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const d = await res.json();
        currentIp = d.ip;
      } catch (err) {
        // IP alÄ±namazsa default kullanÄ±cÄ± gÃ¶rÃ¼nÃ¼mÃ¼
        currentIp = 'unknown';
        console.warn("IP alÄ±namadÄ±:", err);
      }

      // admin gÃ¶rÃ¼nÃ¼mÃ¼ kontrolÃ¼
      if (currentIp === ADMIN_IP) {
        document.getElementById('adminBtn').style.display = 'block';
        document.getElementById('requestsBtn').style.display = 'block';
      }
      
      await loadSongs();
      if (currentIp === ADMIN_IP) await loadRequests();
    }

    // ÅžarkÄ± ekle (admin)
    async function addSong() {
      const name = document.getElementById('song-name').value.trim();
      const artist = document.getElementById('song-artist').value.trim();
      const url = document.getElementById('song-url').value.trim();
      const msg = document.getElementById('admin-msg');
      msg.innerText = '';

      if (!name || !artist || !url) { msg.innerText="TÃ¼m alanlarÄ± doldurun"; msg.className='hint'; return; }

      const { data, error } = await supabase.from('Songs').insert([{ name, artist, url }]);
      if (error) {
        msg.innerText = "Hata: " + error.message;
        msg.className = 'error';
        console.error("Insert error:", error);
      } else {
        msg.innerText = "ÅžarkÄ± eklendi âœ…";
        msg.className = 'ok';
        document.getElementById('song-name').value='';
        document.getElementById('song-artist').value='';
        document.getElementById('song-url').value='';
        await loadSongs();
      }
    }

    // ÅžarkÄ±larÄ± yÃ¼kle
    async function loadSongs() {
      const list = document.getElementById('songs-list');
      list.innerHTML = 'YÃ¼kleniyor...';
      const { data, error } = await supabase.from('Songs').select('*').order('id',{ascending:false});
      if (error) { list.innerHTML = "<li class='error'>Liste yÃ¼klenemedi: "+error.message+"</li>"; return; }
      if (!data || data.length === 0) { list.innerHTML = '<li>HenÃ¼z ÅŸarkÄ± yok.</li>'; return; }
      list.innerHTML = '';
      data.forEach(s=>{
        const li = document.createElement('li');
        li.innerHTML = `<b>${escapeHtml(s.name)}</b> - ${escapeHtml(s.artist)}<br>
                        <audio controls preload="none" src="${escapeAttr(s.url)}"></audio>`;
        list.appendChild(li);
      });
    }

    // Ä°stek gÃ¶nder (kullanÄ±cÄ± -> storage + SongRequests tablosu)
    async function sendRequest() {
      const name = document.getElementById('req-name').value.trim();
      const artist = document.getElementById('req-artist').value.trim();
      const file = document.getElementById('req-file').files[0];
      const msg = document.getElementById('req-msg');
      msg.innerText = '';

      if (!name || !artist || !file) { msg.innerText="TÃ¼m alanlarÄ± doldurun"; msg.className='hint'; return; }

      // bucket: "song-requests" olmalÄ± (Supabase Storage'da oluÅŸtur)
      const path = 'requests/' + Date.now() + '_' + file.name;
      const { error: upErr } = await supabase.storage.from('song-requests').upload(path, file);
      if (upErr) { msg.innerText = "YÃ¼kleme hatasÄ±: " + upErr.message; msg.className='error'; return; }

      const { publicURL, error: urlErr } = supabase.storage.from('song-requests').getPublicUrl(path);
      if (urlErr) { msg.innerText = "URL alma hatasÄ±: " + urlErr.message; msg.className='error'; return; }

      const { data, error } = await supabase.from('SongRequests').insert([{ name, artist, ip: currentIp, file_url: publicURL }]);
      if (error) { msg.innerText = "VeritabanÄ± hatasÄ±: " + error.message; msg.className='error'; return; }

      msg.innerText = "Ä°stek gÃ¶nderildi âœ…";
      msg.className = 'ok';
      document.getElementById('req-name').value='';
      document.getElementById('req-artist').value='';
      document.getElementById('req-file').value='';
      if (currentIp === ADMIN_IP) await loadRequests();
    }

    // Admin: gelen istekleri yÃ¼kle
    async function loadRequests() {
      const list = document.getElementById('requests-list');
      list.innerHTML = 'YÃ¼kleniyor...';
      const { data, error } = await supabase.from('SongRequests').select('*').order('id',{ascending:false});
      if (error) { list.innerHTML = "<li class='error'>Liste yÃ¼klenemedi: "+error.message+"</li>"; return; }
      if (!data || data.length === 0) { list.innerHTML = '<li>Ä°stek yok.</li>'; return; }
      list.innerHTML = '';
      data.forEach(r=>{
        const li = document.createElement('li');
        li.innerHTML = `<b>${escapeHtml(r.name)}</b> - ${escapeHtml(r.artist)} (${escapeHtml(r.ip||'?' )})<br>
                        <a href="${escapeAttr(r.file_url)}" target="_blank" rel="noopener">DosyayÄ± indir</a>`;
        list.appendChild(li);
      });
    }

    function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
    function escapeAttr(t){ return escapeHtml(t); }

    // baÅŸlat
    init();
  </script>
</body>
</html>
