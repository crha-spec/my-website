<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</title>
  <style>
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      padding:20px; 
      background: #f6f7fb; 
      color:#111; 
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .panel-container {
      display: flex;
      gap: 20px;
    }
    #sidebar {
      width: 220px;
      background: #222;
      color: white;
      padding: 20px;
      border-radius: 8px;
      height: fit-content;
    }
    #sidebar h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #fff;
    }
    #sidebar button {
      margin: 6px 0;
      padding: 10px;
      cursor: pointer;
      background: #444;
      color: white;
      border: none;
      border-radius: 6px;
      text-align: left;
      width: 100%;
    }
    #sidebar button:hover {
      background: #666;
    }
    #content {
      flex: 1;
    }
    .panel {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      margin-bottom: 20px;
    }
    input {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button.action {
      padding: 12px 16px;
      margin-top: 10px;
      cursor: pointer;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
    }
    button.action:hover {
      background: #1565c0;
    }
    button.secondary {
      background: #757575;
    }
    button.secondary:hover {
      background: #616161;
    }
    ul#songs-list {
      list-style: none;
      padding: 0;
    }
    li.song-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .hint {
      color: #666;
      font-size: 14px;
      margin-top: 8px;
    }
    .error {
      color: #c62828;
      font-weight: 700;
    }
    .ok {
      color: #2e7d32;
      font-weight: 700;
    }
    .ip-info {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    footer {
      margin-top: 30px;
      color: #666;
      font-size: 13px;
      text-align: center;
      padding: 15px;
      border-top: 1px solid #ddd;
    }
    audio {
      width: 100%;
      max-width: 600px;
      margin-top: 10px;
      height: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</h1>
      <div id="user-ip" class="ip-info">IP adresi yÃ¼kleniyor...</div>
    </header>

    <div class="panel-container">
      <!-- Sidebar -->
      <div id="sidebar">
        <h2>MenÃ¼</h2>
        <button type="button" onclick="showPanel('library')">ðŸ“€ KitaplÄ±k</button>
        <button type="button" onclick="showPanel('request')">âž• ÅžarkÄ± Ä°steÄŸi</button>
        <button type="button" id="adminBtn" style="display:none" onclick="showPanel('admin')">ðŸŽ§ Admin Paneli</button>
        <button type="button" id="requestsBtn" style="display:none" onclick="showPanel('requests')">ðŸ“¨ Ä°stekler</button>
      </div>

      <!-- Content -->
      <div id="content">
        <!-- KitaplÄ±k Paneli -->
        <div id="library" class="panel">
          <h2>ðŸ“€ MÃ¼zik KitaplÄ±ÄŸÄ±</h2>
          <ul id="songs-list"></ul>
          <p id="library-msg" class="hint"></p>
        </div>

        <!-- ÅžarkÄ± Ä°steÄŸi Paneli -->
        <div id="request" class="panel">
          <h2>âž• ÅžarkÄ± Ä°steÄŸi</h2>
          <input type="text" id="req-name" placeholder="ÅžarkÄ± AdÄ±" />
          <input type="text" id="req-artist" placeholder="SanatÃ§Ä±" />
          <input type="file" id="req-file" accept="audio/*" />
          <button class="action" onclick="sendRequest()">GÃ¶nder</button>
          <p id="req-msg" class="hint"></p>
        </div>

        <!-- Admin Paneli -->
        <div id="admin" class="panel">
          <h2>ðŸŽ§ Admin Paneli</h2>
          <input type="text" id="song-name" placeholder="ÅžarkÄ± AdÄ±" />
          <input type="text" id="song-artist" placeholder="SanatÃ§Ä±" />
          <input type="text" id="song-url" placeholder="Dosya URL (catbox veya mp3 linki)" />
          <button class="action" id="addSongBtn" onclick="addSong()">ÅžarkÄ±yÄ± Ekle</button>
          <button class="action secondary" id="clearBtn" onclick="clearForm()">Temizle</button>
          <p id="admin-msg" class="hint"></p>
        </div>

        <!-- Ä°stekler Paneli -->
        <div id="requests" class="panel">
          <h2>ðŸ“¨ Gelen Ä°stekler</h2>
          <ul id="requests-list"></ul>
        </div>
      </div>
    </div>

    <footer>
      <p>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi Â© 2023</p>
    </footer>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- SUPABASE BÄ°LGÄ°LERÄ° ---
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ADMIN IP ---
    const ADMIN_IP = "151.250.4.2";
    let currentIp = null;

    // Panel yÃ¶nlendirme fonksiyonu
    function showPanel(id) {
      // TÃ¼m panelleri gizle
      document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
      
      // Ä°stenen paneli gÃ¶ster
      document.getElementById(id).style.display = 'block';
      
      // Paneller arasÄ± geÃ§iÅŸte iÃ§erikleri yenile
      if (id === 'library') loadSongs();
      if (id === 'requests' && currentIp === ADMIN_IP) loadRequests();
    }

    // Form temizleme
    function clearForm() {
      document.getElementById('song-name').value = '';
      document.getElementById('song-artist').value = '';
      document.getElementById('song-url').value = '';
      document.getElementById('admin-msg').innerText = '';
    }

    // Sayfa aÃ§Ä±lÄ±nca IP'yi al, admin mi kontrol et, ÅŸarkÄ±larÄ± yÃ¼kle
    async function init() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const d = await res.json();
        currentIp = d.ip || 'unknown';
        
        // IP bilgisini gÃ¶ster
        document.getElementById('user-ip').innerText = `IP adresiniz: ${currentIp}`;
        
        // admin gÃ¶rÃ¼nÃ¼mÃ¼ kontrolÃ¼
        if (currentIp === ADMIN_IP) {
          document.getElementById('adminBtn').style.display = 'block';
          document.getElementById('requestsBtn').style.display = 'block';
          showPanel('admin');
        } else {
          showPanel('library');
        }

        await loadSongs();
        if (currentIp === ADMIN_IP) await loadRequests();
      } catch (err) {
        // IP alÄ±namazsa default kullanÄ±cÄ± gÃ¶rÃ¼nÃ¼mÃ¼
        currentIp = 'unknown';
        console.warn("IP alÄ±namadÄ±:", err);
        document.getElementById('user-ip').innerText = "IP adresi alÄ±namadÄ±";
        showPanel('library');
        await loadSongs();
      }
    }

    // ÅžarkÄ± ekle (admin)
    async function addSong() {
      const name = document.getElementById('song-name').value.trim();
      const artist = document.getElementById('song-artist').value.trim();
      const url = document.getElementById('song-url').value.trim();
      const msg = document.getElementById('admin-msg');
      const addSongBtn = document.getElementById('addSongBtn');
      
      msg.innerText = '';

      if (!name || !artist || !url) { 
        msg.innerText = "LÃ¼tfen tÃ¼m alanlarÄ± doldurun (name, artist, url)."; 
        msg.className = 'error'; 
        return; 
      }

      try {
        msg.innerText = "Kaydediliyor...";
        msg.className = 'hint';
        addSongBtn.disabled = true;
        
        const { data, error } = await supabase.from('Songs').insert([{ name, artist, url }]);
        
        if (error) {
          msg.innerText = "Hata: " + error.message;
          msg.className = 'error';
          console.error("Insert error:", error);
          
          // EÄŸer RLS hatasÄ±ysa kullanÄ±cÄ±ya SQL dÃ¼zeltmesi gerektiÄŸini sÃ¶yle
          if (error.message && error.message.toLowerCase().includes('row-level')) {
            msg.innerText += " â€” RLS policy izinlerini kontrol et (SQL tarafÄ±nda insert izni ver).";
          }
        } else {
          msg.innerText = "ÅžarkÄ± baÅŸarÄ±yla eklendi âœ…";
          msg.className = 'ok';
          clearForm();
          await loadSongs();
        }
      } catch (err) {
        msg.innerText = "Beklenmeyen hata: " + (err.message || err);
        msg.className = 'error';
        console.error("Insert exception:", err);
      } finally {
        addSongBtn.disabled = false;
      }
    }

    // ÅžarkÄ±larÄ± yÃ¼kle
    async function loadSongs() {
      const list = document.getElementById('songs-list');
      const msg = document.getElementById('library-msg');
      
      list.innerHTML = 'YÃ¼kleniyor...';
      msg.innerText = '';
      
      try {
        const { data, error } = await supabase.from('Songs').select('*').order('id', { ascending: false });
        
        if (error) { 
          list.innerHTML = `<li class="error">Liste yÃ¼klenemedi: ${error.message}</li>`; 
          console.error("Supabase select error:", error);
          return; 
        }
        
        if (!data || data.length === 0) { 
          list.innerHTML = '<li class="hint">HenÃ¼z ÅŸarkÄ± yok.</li>'; 
          return; 
        }
        
        list.innerHTML = '';
        data.forEach(s => {
          const li = document.createElement('li');
          li.className = 'song-item';
          li.innerHTML = `<strong>${escapeHtml(s.name || '')}</strong> - ${escapeHtml(s.artist || '')} 
                          <div style="margin-top:10px">
                            <audio controls preload="none" src="${escapeAttr(s.url || '')}"></audio>
                          </div>`;
          list.appendChild(li);
        });
      } catch (err) {
        list.innerHTML = `<li class="error">Beklenmeyen liste hatasÄ±: ${err.message || err}</li>`;
        console.error(err);
      }
    }

    // Ä°stek gÃ¶nder (kullanÄ±cÄ± -> storage + SongRequests tablosu)
    async function sendRequest() {
      const name = document.getElementById('req-name').value.trim();
      const artist = document.getElementById('req-artist').value.trim();
      const file = document.getElementById('req-file').files[0];
      const msg = document.getElementById('req-msg');
      msg.innerText = '';

      if (!name || !artist || !file) { 
        msg.innerText = "TÃ¼m alanlarÄ± doldurun"; 
        msg.className = 'error'; 
        return; 
      }

      // bucket: "song-requests" olmalÄ± (Supabase Storage'da oluÅŸtur)
      const path = 'requests/' + Date.now() + '_' + file.name;
      const { error: upErr } = await supabase.storage.from('song-requests').upload(path, file);
      
      if (upErr) { 
        msg.innerText = "YÃ¼kleme hatasÄ±: " + upErr.message; 
        msg.className = 'error'; 
        return; 
      }

      const { publicURL, error: urlErr } = supabase.storage.from('song-requests').getPublicUrl(path);
      if (urlErr) { 
        msg.innerText = "URL alma hatasÄ±: " + urlErr.message; 
        msg.className = 'error'; 
        return; 
      }

      const { data, error } = await supabase.from('SongRequests').insert([{ 
        name, 
        artist, 
        ip: currentIp, 
        file_url: publicURL 
      }]);
      
      if (error) { 
        msg.innerText = "VeritabanÄ± hatasÄ±: " + error.message; 
        msg.className = 'error'; 
        return; 
      }

      msg.innerText = "Ä°stek gÃ¶nderildi âœ…";
      msg.className = 'ok';
      document.getElementById('req-name').value = '';
      document.getElementById('req-artist').value = '';
      document.getElementById('req-file').value = '';
      
      if (currentIp === ADMIN_IP) await loadRequests();
    }

    // Admin: gelen istekleri yÃ¼kle
    async function loadRequests() {
      const list = document.getElementById('requests-list');
      list.innerHTML = 'YÃ¼kleniyor...';
      
      const { data, error } = await supabase.from('SongRequests').select('*').order('id', { ascending: false });
      
      if (error) { 
        list.innerHTML = `<li class="error">Liste yÃ¼klenemedi: ${error.message}</li>`; 
        return; 
      }
      
      if (!data || data.length === 0) { 
        list.innerHTML = '<li>Ä°stek yok.</li>'; 
        return; 
      }
      
      list.innerHTML = '';
      data.forEach(r => {
        const li = document.createElement('li');
        li.className = 'song-item';
        li.innerHTML = `<b>${escapeHtml(r.name)}</b> - ${escapeHtml(r.artist)} (${escapeHtml(r.ip || '?' )})<br>
                        <a href="${escapeAttr(r.file_url)}" target="_blank" rel="noopener">DosyayÄ± indir</a>`;
        list.appendChild(li);
      });
    }

    // HTML escaping fonksiyonlarÄ±
    function escapeHtml(text) { 
      if (!text) return ''; 
      return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); 
    }
    
    function escapeAttr(text) { 
      return escapeHtml(text); 
    }

    // Sayfa yÃ¼klendiÄŸinde init fonksiyonunu Ã§alÄ±ÅŸtÄ±r
    window.onload = init;
  </script>
</body>
</html>
