<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kişisel Müzik Kütüphanesi - Admin + Kullanıcı</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding:20px; background:#f6f7fb; color:#111; margin:0; }
    h1,h2,h3 { margin:8px 0; }
    input,textarea{ padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    button{ padding:10px 14px; margin-top:8px; cursor:pointer; }
    #admin-panel, #user-panel { display:none; background:white; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.06); margin-bottom:20px; }
    .container { display:flex; gap:20px; max-width:1200px; }
    .sidebar { width:200px; flex-shrink:0; }
    .main-content { flex-grow:1; }
    .sidebar button { display:block; width:100%; margin-bottom:10px; padding:12px; background:#f0f0f0; border:none; border-radius:5px; text-align:left; cursor:pointer; }
    .sidebar button.active { background:#4a6bff; color:white; }
    ul { list-style:none; padding:0; }
    li.song-item{ padding:10px 0; border-bottom:1px solid #eee; }
    .hint{ color:#666; font-size:13px; margin-top:8px; }
    .error{ color:#c62828; font-weight:700; }
    .ok{ color:#2e7d32; font-weight:700; }
    footer { margin-top:20px; color:#666; font-size:13px; }
    .request-item { padding:15px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px; }
    .request-actions { margin-top:10px; display:flex; gap:10px; }
    #player-bar { position:fixed; bottom:0; left:0; right:0; background:#222; color:#fff; padding:10px; display:flex; flex-direction:column; align-items:center; }
    #player-controls{ display:flex; gap:10px; margin-bottom:6px; }
    #lyrics-box{ max-height:120px; overflow-y:auto; font-size:14px; line-height:1.4; background:#333; color:#eee; padding:8px; border-radius:6px; width:100%; max-width:600px; text-align:center; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>Müzik Kütüphanesi</h1>

  <!-- Admin Panel -->
  <div id="admin-panel">
    <h2>🎧 Admin Paneli</h2>
    <div class="container">
      <div class="sidebar">
        <button id="btn-library" class="active">Kitaplık</button>
        <button id="btn-add-song">Şarkı Ekle</button>
        <button id="btn-song-requests">Şarkı İstekleri</button>
        <button id="btn-access-requests">Giriş Onayları</button>
      </div>
      <div class="main-content">
        <div id="library-section">
          <h3>Müzik Kitaplığı</h3>
          <ul id="songs-list"></ul>
        </div>
        <div id="add-song-section" style="display:none;">
          <h3>Yeni Şarkı Ekle</h3>
          <input id="song-name" placeholder="Şarkı adı" />
          <input id="song-artist" placeholder="Sanatçı" />
          <input id="song-url" placeholder="Şarkı URL" />
          <textarea id="song-lyrics" placeholder="Şarkı sözleri (opsiyonel)"></textarea>
          <button id="addSongBtn">Ekle</button>
          <button id="clearBtn">Temizle</button>
          <div id="admin-msg" class="hint"></div>
        </div>
        <div id="song-requests-section" style="display:none;">
          <h3>Şarkı İstekleri</h3>
          <ul id="song-requests-list"></ul>
        </div>
        <div id="access-requests-section" style="display:none;">
          <h3>Giriş Onayları</h3>
          <button id="approveAllBtn">Tümünü Onayla</button>
          <ul id="access-requests-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel">
    <h2>📀 Kullanıcı Paneli</h2>
    <div class="container">
      <div class="sidebar">
        <button id="user-btn-library" class="active">Kitaplık</button>
        <button id="user-btn-song-request">Şarkı İsteği</button>
      </div>
      <div class="main-content">
        <div id="user-library-section">
          <ul id="user-songs-list"></ul>
        </div>
        <div id="user-song-request-section" style="display:none;">
          <h3>Şarkı İsteği Gönder</h3>
          <input id="request-song-name" placeholder="Şarkı adı" />
          <input id="request-song-artist" placeholder="Sanatçı" />
          <input id="request-song-url" placeholder="Şarkı URL (catbox.moe)" />
          <button id="sendRequestBtn">İstek Gönder</button>
          <div id="user-request-msg" class="hint"></div>
        </div>
      </div>
    </div>
  </div>

  <footer><div id="debug" class="hint"></div></footer>

  <!-- Player bar -->
  <div id="player-bar">
    <div id="player-controls">
      <button id="prevBtn">⏮</button>
      <button id="playPauseBtn">⏯</button>
      <button id="nextBtn">⏭</button>
    </div>
    <audio id="global-player" controls style="width:100%;max-width:600px"></audio>
    <div id="lyrics-box">Henüz şarkı seçilmedi</div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "YOUR_KEY_HERE"; // kendi anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const ADMIN_IP = "151.250.4.2";
    const adminPanel=document.getElementById("admin-panel");
    const userPanel=document.getElementById("user-panel");
    const songsList=document.getElementById("songs-list");
    const userSongsList=document.getElementById("user-songs-list");
    const adminMsg=document.getElementById("admin-msg");
    const debug=document.getElementById("debug");
    const addSongBtn=document.getElementById("addSongBtn");
    const clearBtn=document.getElementById("clearBtn");
    const sendRequestBtn=document.getElementById("sendRequestBtn");
    const approveAllBtn=document.getElementById("approveAllBtn");

    let currentSongs=[];
    let currentIndex=-1;
    const player=document.getElementById("global-player");
    const lyricsBox=document.getElementById("lyrics-box");

    async function init(){
      try{
        const res=await fetch("https://api64.ipify.org?format=json");
        const ip=(await res.json()).ip;
        if(ip===ADMIN_IP){ adminPanel.style.display="block"; }
        else{ userPanel.style.display="block"; }
        await loadSongs();
      }catch(e){ console.error(e); }
    }

    async function addSong(){
      const name=document.getElementById("song-name").value.trim();
      const artist=document.getElementById("song-artist").value.trim();
      const url=document.getElementById("song-url").value.trim();
      const lyrics=document.getElementById("song-lyrics").value.trim();
      if(!name||!artist||!url){ adminMsg.innerText="Eksik bilgi"; return; }
      const {error}=await supabase.from("Songs").insert([{name,artist,url,lyrics}]);
      if(error){ adminMsg.innerText="Hata: "+error.message; }
      else{ adminMsg.innerText="Şarkı eklendi ✅"; await loadSongs(); }
    }

    async function deleteSong(id,element){
      if(!confirm("Bu şarkıyı silmek istediğinize emin misiniz?")) return;
      const {error}=await supabase.from("Songs").delete().eq("id",id);
      if(error){ alert("Silme hatası: "+error.message); }
      else{ element.remove(); alert("✅ Şarkı silindi"); }
    }

    function playSong(idx){
      currentIndex=idx;
      const s=currentSongs[idx];
      if(!s) return;
      player.src=s.url;
      player.play();
      lyricsBox.innerText=s.lyrics? s.lyrics : "Bu şarkıya söz eklenmemiş.";
    }

    async function loadSongs(){
      const {data,error}=await supabase.from("Songs").select("*").order("id",{ascending:false});
      if(error){ console.error(error); return; }
      currentSongs=data||[];
      [songsList,userSongsList].forEach(list=>{
        list.innerHTML="";
        currentSongs.forEach((s,idx)=>{
          const li=document.createElement("li");
          li.className="song-item";
          li.innerHTML=`<strong>${s.name}</strong> - ${s.artist}
            <div>
              <button class="play">Çal</button>
              <button class="edit">Düzenle</button>
              <button class="delete">Sil</button>
            </div>`;
          li.querySelector(".play").addEventListener("click",()=>playSong(idx));
          li.querySelector(".delete").addEventListener("click",()=>deleteSong(s.id,li));
          // edit olayı ekleyebilirsin burada
          list.appendChild(li);
        });
      });
    }

    document.getElementById("playPauseBtn").onclick=()=>{
      if(player.paused) player.play(); else player.pause();
    };
    document.getElementById("prevBtn").onclick=()=>{
      if(currentIndex>0) playSong(currentIndex-1);
    };
    document.getElementById("nextBtn").onclick=()=>{
      if(currentIndex<currentSongs.length-1) playSong(currentIndex+1);
    };

    addSongBtn.onclick=addSong;
    clearBtn.onclick=()=>{["song-name","song-artist","song-url","song-lyrics"].forEach(id=>document.getElementById(id).value="");};

    init();
  </script>
</body>
</html>
