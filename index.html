<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi - Tam SÃ¼rÃ¼m</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1724; --muted:#9aa4b2; --accent:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, Arial;background:linear-gradient(180deg,#0b1220,#102033);color:#fff;padding:18px;}
    .app{max-width:1200px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(255,255,255,0.03);border-radius:8px}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:16px}
    .panel{background:rgba(255,255,255,0.03);padding:14px;border-radius:8px}
    .menu-toggle{background:#f72585;border:0;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
    input,textarea,select{width:100%;padding:8px;border-radius:6px;border:0;background:rgba(255,255,255,0.02);color:#fff;margin-bottom:8px}
    .btn{background:rgba(255,255,255,0.04);border:0;padding:8px 10px;border-radius:6px;color:#fff;cursor:pointer}
    .btn.primary{background:var(--accent)}
    .btn.danger{background:#ef4444}
    .list{list-style:none;padding:0;margin:0;max-height:60vh;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .cover{width:220px;height:220px;object-fit:cover;border-radius:10px;display:block;margin:12px auto}
    /* saÄŸdan aÃ§Ä±lan menÃ¼ */
    #coverArt {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
    .sidebar-panel {
      position: fixed;
      top: 0; right: -280px;
      width: 260px;
      height: 100%;
      background: rgba(3,7,18,0.98);
      padding: 20px;
      transition: right .28s ease;
      z-index: 9999;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow: -24px 0 40px rgba(0,0,0,0.6);
    }
    .sidebar-panel.open { right: 0; }
    .sidebar-panel button { padding: 12px; background: #081323; border: none; border-radius: 6px; color: #fff; cursor: pointer; text-align:left; }
    .small{font-size:13px;color:var(--muted)}
    #lyrics-box, #user-lyrics-box { position:relative; height:72px; overflow:hidden; margin-top:12px; display:flex; align-items:center; justify-content:center; }
    .lyric-word { position:absolute; opacity:0; transition: opacity .5s linear; font-weight:700; font-size:20px; text-align:center; padding:0 8px; line-height:1.2; }
    footer{margin-top:14px;color:var(--muted);text-align:center;font-size:13px}
    a.link{color:#8ab4ff;text-decoration:none}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:8px}
    audio{width:100%}
    .row{display:flex;gap:8px}
    .hidden{display:none}
    .timestamp{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div><strong>ğŸµ KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi â€” Tam SÃ¼rÃ¼m</strong></div>
      <div>
        <button id="menuToggle" class="menu-toggle">â˜° MenÃ¼</button>
        &nbsp;<span id="user-type">â€”</span>
      </div>
    </header>

    <div class="layout">
      <!-- SOL: yÃ¶netim / kullanÄ±cÄ± panelleri (aynÄ± yapÄ± iÃ§inde) -->
      <div>
        <!-- ADMIN PANEL -->
        <div id="admin-panel" class="panel" style="display:none">
          <!-- sidebar panel (saÄŸdan aÃ§Ä±lÄ±r) -->
          <div id="admin-sidebar" class="sidebar-panel" aria-hidden="true">
            <button data-target="library-section">KitaplÄ±k</button>
            <button data-target="add-song-section">ÅarkÄ± Ekle</button>
            <button data-target="song-requests-section">ÅarkÄ± Ä°stekleri</button>
            <button data-target="access-requests-section">GiriÅŸ OnaylarÄ±</button>
            <button id="closeAdminSidebar">Kapat</button>
          </div>

          <div id="library-section">
            <h3>KitaplÄ±k</h3>
            <div class="controls"><input id="admin-search" placeholder="Ara..."><select id="admin-sort"><option value="id">En Yeni</option><option value="name">Ada GÃ¶re</option><option value="artist">SanatÃ§Ä±ya GÃ¶re</option></select></div>
            <ul id="songs-list" class="list"></ul>
          </div>

          <div id="add-song-section" class="hidden">
            <h3>ÅarkÄ± Ekle</h3>
            <label>ÅarkÄ± AdÄ±</label><input id="song-name" placeholder="Ã–r: Faded">
            <label>SanatÃ§Ä±</label><input id="song-artist" placeholder="Ã–r: Alan Walker">
            <label>Dosya URL (catbox veya mp3 linki)</label><input id="song-url" placeholder="https://files.catbox.moe/...">
            <label>Kapak URL (direct link)</label><input id="song-cover" placeholder="https://files.catbox.moe/xxxx.jpg">
            <div class="row"><button id="pasteCover" class="btn">Panodan YapÄ±ÅŸtÄ±r</button><button id="testCover" class="btn">Kapak Ã–nizle</button></div>
            <label>ÅarkÄ± SÃ¶zleri (her satÄ±r / paragraf) - GÃ¶sterim: kelime-kelime</label>
            <textarea id="song-lyrics" rows="4" placeholder="kahpe kader yuzumuze gulmedi\nBugunde ne olucak"></textarea>
            <div class="row"><button id="addSongBtn" class="btn primary">ÅarkÄ±yÄ± Ekle</button><button id="clearAdd" class="btn">Temizle</button></div>
            <div id="admin-msg" class="small"></div>
          </div>

          <div id="song-requests-section" class="hidden">
            <h3>ÅarkÄ± Ä°stekleri</h3>
            <ul id="song-requests-list" class="list"></ul>
          </div>

          <div id="access-requests-section" class="hidden">
            <h3>GiriÅŸ OnaylarÄ±</h3>
            <div id="access-requests-container"><ul id="access-requests-list" class="list"></ul></div>
            <div style="margin-top:8px"><button id="approveAllBtn" class="btn primary">TÃ¼mÃ¼nÃ¼ Onayla</button></div>
          </div>

          <div id="now-playing-admin" class="hidden" style="margin-top:12px;">
            <h3>Åu An Ã‡alan</h3>
            <img id="now-playing-cover" src="" alt="Kapak FotoÄŸrafÄ±" 
     style="display:none; width:120px; height:120px; object-fit:cover; border-radius:12px; margin-bottom:10px;" />
            <div id="now-playing-info">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
            <div style="margin-top:8px;" class="row">
              <button id="prevBtn" class="btn">â® Ã–nceki</button>
              <button id="toggleBtn" class="btn primary">â¯ BaÅŸlat/Durdur</button>
              <button id="nextBtn" class="btn">â­ Sonraki</button>
            </div>
            <div id="lyrics-box"><div id="now-lyric" class="lyric-word" style="opacity:0;">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div></div>
          </div>
        </div>

        <!-- USER PANEL -->
        <div id="user-panel" class="panel" style="display:none">
          <div id="user-sidebar" class="sidebar-panel" aria-hidden="true">
            <button data-target="user-library-section">KitaplÄ±k</button>
            <button data-target="user-request-section">ÅarkÄ± Ä°steÄŸi</button>
            <button data-target="user-now-playing-section">Åu An Ã‡alan</button>
            <button id="closeUserSidebar">Kapat</button>
          </div>

          <div id="user-library-section">
            <h3>KitaplÄ±k</h3>
            <div class="controls"><input id="user-search" placeholder="Ara..."><select id="user-sort"><option value="id">En Yeni</option><option value="name">Ada GÃ¶re</option><option value="artist">SanatÃ§Ä±ya GÃ¶re</option></select></div>
            <ul id="user-songs-list" class="list"></ul>
          </div>

          <div id="user-request-section" class="hidden">
            <h3>ÅarkÄ± Ä°steÄŸi GÃ¶nder</h3>
            <label>ÅarkÄ± AdÄ±</label><input id="request-song-name">
            <label>SanatÃ§Ä±</label><input id="request-song-artist">
            <label>Dosya Linki (catbox veya mp3)</label><input id="request-song-url" placeholder="https://files.catbox.moe/...">
            <label>Kapak URL (opsiyonel)</label><input id="request-song-cover" placeholder="https://files.catbox.moe/xxxx.jpg">
            <label>SÃ¶zler (opsiyonel)</label><textarea id="request-song-lyrics" rows="3"></textarea>
            <div class="row"><button id="sendRequestBtn" class="btn primary">Ä°stek GÃ¶nder</button><button id="openCatbox" class="btn">Catbox'a Git</button></div>
            <div id="user-request-msg" class="small"></div>
          </div>

          <div id="user-now-playing-section" class="hidden" style="margin-top:12px;">
            <h3>Åu An Ã‡alan</h3>
            <img id="user-now-playing-cover" class="cover" src="" alt="Kapak">
            <div id="user-now-playing-info">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
            <div style="margin-top:8px;" class="row">
              <button id="uPrevBtn" class="btn">â® Ã–nceki</button>
              <button id="uToggleBtn" class="btn primary">â¯ BaÅŸlat/Durdur</button>
              <button id="uNextBtn" class="btn">â­ Sonraki</button>
            </div>
            <div id="user-lyrics-box"><div id="user-lyric" class="lyric-word" style="opacity:0;">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div></div>
          </div>
        </div>
      </div>

      <!-- SAÄ: player + bilgiler -->
      <div>
        <div class="panel" style="text-align:center">
          <h3>Kontroller</h3>
          <img id="main-cover" src="" alt="Kapak" 
     style="display:none;width:100px;height:100px;object-fit:cover;
            border-radius:12px;margin-bottom:8px;" />
            <img id="coverArt" class="cover-art" src="" alt="Kapak FotoÄŸrafÄ±"
     style="display:block; width:120px; height:120px; object-fit:cover; border-radius:12px; margin:8px auto;">
          <div id="player-info">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
          <audio id="main-player" controls></audio>
          <div class="small" style="margin-top:8px">Admin paneli sadece ADMIN_IP ile aÃ§Ä±lÄ±r. (IP kontrolÃ¼ mevcut)</div>
        </div>

        <div class="panel">
          <h3>YardÄ±m & Notlar</h3>
          <div class="small">Ä°stek gÃ¶ndermek iÃ§in dosyanÄ±zÄ± <a class="link" href="https://catbox.moe/" target="_blank">catbox.moe</a>'ye yÃ¼kleyip Ã§Ä±kan direct linki kullanÄ±n.</div>
          <div class="small" style="margin-top:8px">Onaylanan istek kitaplÄ±ÄŸa eklendiÄŸinde otomatik Ã§alar.</div>
        </div>
      </div>
    </div>

    <footer>Single-file â€” Supabase ile Ã§alÄ±ÅŸÄ±r. (SQL tablolarÄ±: songs, songrequests, accessrequests)</footer>
  </div>

<script type="module">
/* ---------------------------
   SUPABASE AYARLARI - BURAYI GÃœNCELLE
   --------------------------- */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------------------------
   GENEL DEÄÄ°ÅKENLER
   --------------------------- */
const ADMIN_IP = "151.250.4.2"; // admin IP - deÄŸiÅŸtirilebilir
let allSongs = []; let currentIndex = -1;
let lyricsInterval = null, lyricsWords = [], wordIdx = 0;

/* DOM */
const menuToggle = document.getElementById("menuToggle");
const adminSidebar = document.getElementById("admin-sidebar");
const userSidebar = document.getElementById("user-sidebar");

/* Elements */
const songsList = document.getElementById("songs-list");
const userSongsList = document.getElementById("user-songs-list");
const songRequestsList = document.getElementById("song-requests-list");
const accessRequestsList = document.getElementById("access-requests-list");
const mainPlayer = document.getElementById("main-player");
const playerInfo = document.getElementById("player-info");

/* ---------------------------
   YARDIMCI: DOM MenÃ¼ aÃ§ma/kapatma
   --------------------------- */
function openSidebarForActivePanel(){
  // hangi panel aktif? admin mi user mÄ±
  if (document.getElementById("admin-panel").style.display !== "none"){
    adminSidebar.classList.add("open");
  } else {
    userSidebar.classList.add("open");
  }
}
menuToggle.addEventListener("click", openSidebarForActivePanel);
document.getElementById("closeAdminSidebar").addEventListener("click", ()=>adminSidebar.classList.remove("open"));
document.getElementById("closeUserSidebar").addEventListener("click", ()=>userSidebar.classList.remove("open"));

[...document.querySelectorAll("#admin-sidebar button[data-target]")].forEach(b=>{
  b.onclick = ()=>{
    const tgt = b.dataset.target;
    // gizle tÃ¼m admin bÃ¶lÃ¼mler
    ["library-section","add-song-section","song-requests-section","access-requests-section","now-playing-admin"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.classList.add("hidden");
    });
    // gÃ¶ster hedef
    const t = document.getElementById(tgt);
    if(t) t.classList.remove("hidden");
    adminSidebar.classList.remove("open");
  };
});
[...document.querySelectorAll("#user-sidebar button[data-target]")].forEach(b=>{
  b.onclick = ()=>{
    const tgt = b.dataset.target;
    ["user-library-section","user-request-section","user-now-playing-section"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.classList.add("hidden");
    });
    const t = document.getElementById(tgt);
    if(t) t.classList.remove("hidden");
    userSidebar.classList.remove("open");
  };
});

/* ---------------------------
   INIT: IP kontrolÃ¼, yÃ¼klemeler
   --------------------------- */
(async function init(){
  try {
    const res = await fetch("https://api64.ipify.org?format=json");
    const j = await res.json();
    const ip = j.ip || "";
    if (ip === ADMIN_IP) {
      // opsiyonel parola - eÄŸer istersen aktif et
      const pass = prompt("Admin parolasÄ± (boÅŸ bÄ±rakÄ±p Tamam ile geÃ§mek iÃ§in):");
      if (pass && pass !== "efkaza7634") {
        alert("YanlÄ±ÅŸ parola â€” kullanÄ±cÄ± paneline yÃ¶nlendiriliyorsunuz");
        showUser();
      } else {
        showAdmin();
        await loadSongRequests();
        await loadAccessRequests();
      }
    } else {
      showUser();
      await saveAccessRequest(ip);
    }
  } catch (err) {
    // ip alÄ±namadÄ±ysa user gÃ¶ster
    console.warn("IP alÄ±namadÄ±:", err);
    showUser();
  }
  await loadSongs();
})();

function showAdmin(){ document.getElementById("admin-panel").style.display="block"; document.getElementById("user-panel").style.display="none"; document.getElementById("user-type").textContent="Admin"; }
function showUser(){ document.getElementById("admin-panel").style.display="none"; document.getElementById("user-panel").style.display="block"; document.getElementById("user-type").textContent="KullanÄ±cÄ±"; }

/* ---------------------------
   SONGS: yÃ¼kle, render, Ã§al, ekle, dÃ¼zenle, sil
   --------------------------- */
async function loadSongs(){
  const { data, error } = await supabase.from("songs").select("*").order("id", { ascending: false });
  if (error) { console.error("loadSongs error:", error); return; }
  allSongs = data || [];
  renderSongs();
}
function renderSongs(){
  songsList.innerHTML = ""; userSongsList.innerHTML = "";
  allSongs.forEach((s, idx) => {
    const li = document.createElement("li"); li.className = "item";
    li.innerHTML = `<div style="max-width:68%"><strong>${escapeHtml(s.name)}</strong> - ${escapeHtml(s.artist)}<div class="timestamp">${new Date(s.created_at||'').toLocaleString()}</div></div>
                    <div>
                      <button class="btn" data-idx="${idx}" data-act="play">Ã‡al</button>
                      <a class="link" href="${escapeAttr(s.url||'')}" target="_blank">AÃ§</a>
                      <button class="btn" data-id="${s.id}" data-act="edit">DÃ¼zenle</button>
                      <button class="btn danger" data-id="${s.id}" data-act="delete">Sil</button>
                    </div>`;
    songsList.appendChild(li);
    // kullanÄ±cÄ± listesi kopyasÄ± (sil & dÃ¼zenleme adminde Ã§alÄ±ÅŸsÄ±n â€” kullanÄ±cÄ±da sadece Ã§al ve aÃ§)
    const uli = li.cloneNode(true);
    // kullanÄ±cÄ± listesindeki dÃ¼ÄŸmelerden edit ve delete'leri gizle
    [...uli.querySelectorAll('button')].forEach(b=>{
      if (b.dataset.act === 'edit' || b.dataset.act === 'delete') b.remove();
    });
    userSongsList.appendChild(uli);
  });
  // event binding
  document.querySelectorAll('[data-act="play"]').forEach(b => {
    b.onclick = (e)=> playSong(parseInt(e.currentTarget.dataset.idx));
  });
  document.querySelectorAll('[data-act="delete"]').forEach(b => {
    b.onclick = async (e) => {
      const id = e.currentTarget.dataset.id;
      if(!confirm("Bu ÅŸarkÄ±yÄ± silmek istediÄŸinize emin misiniz?")) return;
      const { error } = await supabase.from("songs").delete().eq("id", id);
      if (error) { alert("Silme hatasÄ±: "+error.message); console.error(error); }
      else { await loadSongs(); if (currentIndex !== -1) { if(!allSongs[currentIndex] || allSongs[currentIndex].id == id) stopAndReset(); } }
    };
  });
  document.querySelectorAll('[data-act="edit"]').forEach(b=>{
    b.onclick = async (e)=>{
      const id = e.currentTarget.dataset.id;
      await editSong(id);
    };
  });
}

/* play */
function playSong(index){
  if (!allSongs.length || index < 0 || index >= allSongs.length) return;
  currentIndex = index;
  const s = allSongs[index];
  mainPlayer.src = s.url || s.file_url || "";
  mainPlayer.play().catch(()=>{/* autoplay engellerse kullanÄ±cÄ± baÅŸlatÄ±r */});
  playerInfo.textContent = `${s.name} - ${s.artist}`;
  const coverArt = document.getElementById("coverArt");
if (s.cover_url && s.cover_url.trim() !== "") {
  coverArt.src = s.cover_url;
  coverArt.style.display = "block";
} else {
  coverArt.style.display = "none";
}
  const coverEl = document.getElementById("now-playing-cover");
if (s.cover_url && s.cover_url.trim() !== "") {
  coverEl.src = s.cover_url;
  coverEl.style.display = "block";
} else {
  coverEl.style.display = "none";
}
  // kapaklarÄ± setle (hem admin hem user)
  const userCover = document.getElementById("user-now-playing-cover"); if(userCover) userCover.src = s.cover_url || s.cover || "";
  // now info
  const ni = document.getElementById("now-playing-info"); if(ni) ni.textContent = playerInfo.textContent;
  const ui = document.getElementById("user-now-playing-info"); if(ui) ui.textContent = playerInfo.textContent;
  // lyrics: prepare words (split by whitespace)
  const raw = (s.lyrics && s.lyrics.trim()) ? s.lyrics : "Bu ÅŸarkÄ±ya sÃ¶z eklenmemiÅŸ.";
  lyricsWords = raw.replace(/\r/g,'').split(/\s+/).filter(Boolean);
  wordIdx = 0;
  stopLyrics();
  showWord(); // ilk gÃ¶sterim
  if(!mainPlayer.paused) startLyrics();
}

/* edit (prompt-based minimal) */
async function editSong(id){
  const song = allSongs.find(x=>x.id == id);
  if(!song) return alert("ÅarkÄ± bulunamadÄ±");
  const newName = prompt("ÅarkÄ± adÄ±:", song.name); if(!newName) return;
  const newArtist = prompt("SanatÃ§Ä±:", song.artist); if(!newArtist) return;
  const newUrl = prompt("URL:", song.url); if(!newUrl) return;
  const newLyrics = prompt("SÃ¶zler:", song.lyrics || "");
  const newCover = prompt("Kapak URL:", song.cover_url || "");
  const { error } = await supabase.from("songs").update({ name:newName, artist:newArtist, url:newUrl, lyrics:newLyrics, cover_url:newCover }).eq("id", id);
  if(error) alert("GÃ¼ncelleme hatasÄ±: "+error.message);
  else { alert("GÃ¼ncellendi"); await loadSongs(); }
}

/* add song (admin) */
document.getElementById("addSongBtn").onclick = async ()=>{
  const name = document.getElementById("song-name").value.trim();
  const artist = document.getElementById("song-artist").value.trim();
  const url = document.getElementById("song-url").value.trim();
  const cover = document.getElementById("song-cover").value.trim();
  const lyrics = document.getElementById("song-lyrics").value.trim();
  const msg = document.getElementById("admin-msg");
  if(!name || !artist || !url){ msg.textContent = "LÃ¼tfen ad, sanatÃ§Ä± ve url girin."; return; }
  const { data, error } = await supabase.from("songs").insert([{ name, artist, url, lyrics, cover_url: cover }]).select();
  if(error){ msg.textContent = "Hata: "+error.message; console.error(error); }
  else { msg.textContent = "âœ… Eklendi"; document.getElementById("song-name").value=''; document.getElementById("song-artist").value=''; document.getElementById("song-url").value=''; document.getElementById("song-cover").value=''; document.getElementById("song-lyrics").value=''; await loadSongs(); }
};
document.getElementById("clearAdd").onclick = ()=>{
  document.getElementById("song-name").value=''; document.getElementById("song-artist").value=''; document.getElementById("song-url").value=''; document.getElementById("song-cover").value=''; document.getElementById("song-lyrics").value='';
};
document.getElementById("pasteCover").onclick = async ()=>{
  try {
    const t = await navigator.clipboard.readText();
    document.getElementById("song-cover").value = t || "";
  } catch(e){ alert("Panodan yapÄ±ÅŸtÄ±rma izinleri olmayabilir."); }
};
document.getElementById("testCover").onclick = ()=>{
  const url = document.getElementById("song-cover").value.trim();
  if(!url) return alert("Ã–nce URL girin.");
  // hÄ±zlÄ± test: yeni pencere veya img preview
  const w = window.open(""); w.document.body.style.background="#000"; const img = w.document.createElement("img"); img.src=url; img.style.maxWidth="100%"; w.document.body.appendChild(img);
};

/* ---------------------------
   LYRICS: kelime-kelime, 1s gÃ¶ster, 0.5s fade
   --------------------------- */
function showWord(){
  const adminBox = document.getElementById("now-lyric");
  const userBox = document.getElementById("user-lyric");
  const word = lyricsWords.length ? lyricsWords[wordIdx] : "â€”";
  // reset opacity quickly
  if(adminBox){ adminBox.style.opacity = "0"; adminBox.textContent = word; setTimeout(()=> adminBox.style.opacity = "1", 20); setTimeout(()=> adminBox.style.opacity = "0", 1000); }
  if(userBox){ userBox.style.opacity = "0"; userBox.textContent = word; setTimeout(()=> userBox.style.opacity = "1", 20); setTimeout(()=> userBox.style.opacity = "0", 1000); }
  wordIdx = (wordIdx + 1) % Math.max(1, lyricsWords.length);
}
function startLyrics(){
  stopLyrics();
  // interval 1500ms: 1s visible + 0.5s fade
  lyricsInterval = setInterval(()=>{
    // if paused, do nothing (but we stop interval on pause)
    if(mainPlayer.paused) return;
    showWord();
  }, 1500);
}
function stopLyrics(){ if(lyricsInterval) { clearInterval(lyricsInterval); lyricsInterval = null; } }
function stopAndReset(){
  mainPlayer.pause(); mainPlayer.src = ""; playerInfo.textContent = "HenÃ¼z ÅŸarkÄ± seÃ§ilmedi";
  const a = document.getElementById("now-lyric"), b = document.getElementById("user-lyric");
  if(a) { a.textContent = "HenÃ¼z ÅŸarkÄ± seÃ§ilmedi"; a.style.opacity = 0; }
  if(b) { b.textContent = "HenÃ¼z ÅŸarkÄ± seÃ§ilmedi"; b.style.opacity = 0; }
  stopLyrics();
  allSongs = []; currentIndex = -1;
}

/* sync audio events */
mainPlayer.onplay = ()=> { if(!lyricsInterval) startLyrics(); };
mainPlayer.onpause = ()=> { stopLyrics(); };
mainPlayer.onended = ()=> { stopLyrics(); };

/* ---------------------------
   SONG REQUESTS
   --------------------------- */
async function loadSongRequests(){
  const { data, error } = await supabase.from("songrequests").select("*").order("created_at", { ascending: false });
  if(error){ console.error("loadSongRequests", error); return; }
  songRequestsList.innerHTML = "";
  (data||[]).forEach(r=>{
    const li = document.createElement("li"); li.className="item";
    const left = document.createElement("div"); left.innerHTML = `<strong>${escapeHtml(r.name)}</strong> - ${escapeHtml(r.artist)}<div class="timestamp">${new Date(r.created_at||'').toLocaleString()}</div>`;
    const right = document.createElement("div");
    const playBtn = document.createElement("button"); playBtn.className="btn"; playBtn.textContent="Dinle";
    const approveBtn = document.createElement("button"); approveBtn.className="btn primary"; approveBtn.textContent="Onayla";
    const rejectBtn = document.createElement("button"); rejectBtn.className="btn danger"; rejectBtn.textContent="Reddet";
    const dl = document.createElement("a"); dl.href = r.file_url; dl.target="_blank"; dl.textContent = "Ä°ndir"; dl.className="link";
    playBtn.onclick = ()=> { mainPlayer.src = r.file_url; mainPlayer.play().catch(()=>{}); playerInfo.textContent = `${r.name} - ${r.artist}`; lyricsWords = (r.lyrics||"").split(/\s+/).filter(Boolean); wordIdx = 0; stopLyrics(); showWord(); if(!mainPlayer.paused) startLyrics(); };
    approveBtn.onclick = async ()=>{
      // insert to songs
      const { error: ins } = await supabase.from("songs").insert([{ name: r.name, artist: r.artist, url: r.file_url, lyrics: r.lyrics, cover_url: r.cover_url }]);
      if(ins){ alert("Ekleme hatasÄ±: "+ins.message); console.error(ins); return; }
      // delete request
      await supabase.from("songrequests").delete().eq("id", r.id);
      await loadSongRequests();
      await loadSongs();
      // otomatik Ã§almak iÃ§in en son ekleneni bul
      const { data: songsNow } = await supabase.from("songs").select("*").order("created_at", { ascending: true });
      if(songsNow && songsNow.length){ allSongs = songsNow; const idx = allSongs.findIndex(s=>s.url===r.file_url && s.name===r.name); playSong(idx>=0?idx:allSongs.length-1); }
      alert("Ä°stek onaylandÄ± ve kitaplÄ±ÄŸa eklendi.");
    };
    rejectBtn.onclick = async ()=> { await supabase.from("songrequests").delete().eq("id", r.id); await loadSongRequests(); alert("Ä°stek reddedildi."); };
    right.appendChild(playBtn); right.appendChild(approveBtn); right.appendChild(rejectBtn); right.appendChild(dl);
    li.appendChild(left); li.appendChild(right); songRequestsList.appendChild(li);
  });
}

/* send request (user) */
document.getElementById("sendRequestBtn").onclick = async ()=>{
  const name = document.getElementById("request-song-name").value.trim();
  const artist = document.getElementById("request-song-artist").value.trim();
  const file = document.getElementById("request-song-url").value.trim();
  const cover = document.getElementById("request-song-cover").value.trim();
  const lyrics = document.getElementById("request-song-lyrics").value.trim();
  const msg = document.getElementById("user-request-msg");
  if(!name || !artist || !file){ msg.textContent = "Eksik alan"; return; }
  const { error } = await supabase.from("songrequests").insert([{ name, artist, file_url: file, cover_url: cover, lyrics }]);
  if(error){ msg.textContent = "Hata: "+error.message; console.error(error); } else { msg.textContent = "âœ… Ä°stek gÃ¶nderildi"; document.getElementById("request-song-name").value=''; document.getElementById("request-song-artist").value=''; document.getElementById("request-song-url").value=''; document.getElementById("request-song-cover").value=''; document.getElementById("request-song-lyrics").value=''; }
};
document.getElementById("openCatbox").onclick = ()=> window.open("https://catbox.moe/", "_blank");

/* ---------------------------
   ACCESS REQUESTS
   --------------------------- */
async function saveAccessRequest(ip){
  try {
    const { data: existing } = await supabase.from("accessrequests").select("*").eq("ip", ip);
    if(existing && existing.length) return;
    const { error } = await supabase.from("accessrequests").insert([{ ip, status: 'pending', created_at: new Date().toISOString() }]);
    if(error) console.error("saveAccessRequest:", error);
  } catch(e){ console.error(e); }
}
async function loadAccessRequests(){
  const { data, error } = await supabase.from("accessrequests").select("*").order("created_at", { ascending: false });
  if(error){ console.error("loadAccessRequests", error); return; }
  accessRequestsList.innerHTML = "";
  (data||[]).forEach(r=>{
    const li = document.createElement("li"); li.className = "item";
    li.innerHTML = `<div><strong>${escapeHtml(r.ip)}</strong><div class="muted small">${new Date(r.created_at||'').toLocaleString()}</div></div>
                    <div>${r.status === 'pending' ? `<button class="btn" data-ip="${r.ip}" data-act="approve">Onayla</button>` : `<span class="small">${r.status}</span>`}</div>`;
    accessRequestsList.appendChild(li);
  });
  document.querySelectorAll('#access-requests-list [data-act="approve"]').forEach(b=>{
    b.onclick = async (e)=>{
      const ip = e.currentTarget.dataset.ip;
      await supabase.from("accessrequests").update({ status: 'approved' }).eq("ip", ip);
      const approved = JSON.parse(localStorage.getItem('approvedIPs')||'[]'); if(!approved.includes(ip)){ approved.push(ip); localStorage.setItem('approvedIPs', JSON.stringify(approved)); }
      await loadAccessRequests();
    };
  });
}
document.getElementById("approveAllBtn").onclick = async ()=>{
  const { error } = await supabase.from("accessrequests").update({ status: 'approved' }).eq("status", "pending");
  if(error) return console.error("approveAll", error);
  await loadAccessRequests();
};

/* ---------------------------
   MENU Buttons (now playing etc.)
   --------------------------- */
document.getElementById("prevBtn")?.addEventListener("click", ()=>{ if(currentIndex>0) playSong(currentIndex-1); });
document.getElementById("nextBtn")?.addEventListener("click", ()=>{ if(currentIndex<allSongs.length-1) playSong(currentIndex+1); });
document.getElementById("toggleBtn")?.addEventListener("click", ()=>{ if(mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); });
document.getElementById("uPrevBtn")?.addEventListener("click", ()=>{ if(currentIndex>0) playSong(currentIndex-1); });
document.getElementById("uNextBtn")?.addEventListener("click", ()=>{ if(currentIndex<allSongs.length-1) playSong(currentIndex+1); });
document.getElementById("uToggleBtn")?.addEventListener("click", ()=>{ if(mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); });

/* Arama/sort */
document.getElementById("admin-search").oninput = ()=> loadSongs();
document.getElementById("user-search").oninput = ()=> loadSongs();
document.getElementById("admin-sort").onchange = ()=> loadSongs();
document.getElementById("user-sort").onchange = ()=> loadSongs();

/* ---------------------------
   KÃœÃ‡ÃœK YARDIMCILAR
   --------------------------- */
function escapeHtml(t){ if(!t) return ""; return String(t).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[m]); }
function escapeAttr(t){ return escapeHtml(t); }

/* ---------------------------
   SON: hata loglarÄ± gÃ¶ster (console)
   --------------------------- */
console.log("Music library script loaded. Supabase URL:", SUPABASE_URL);

</script>
</body>
</html>
