<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi - Admin + KullanÄ±cÄ±</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding:20px; background: #f6f7fb; color:#111; }
    h1,h2{ margin:8px 0; }
    input{ padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    button{ padding:10px 14px; margin-top:8px; cursor:pointer; }
    #admin-panel, #user-panel { 
      display:none; 
      background:white; 
      padding:16px; 
      border-radius:8px; 
      box-shadow:0 6px 18px rgba(0,0,0,.06); 
      margin-bottom:20px; 
    }
    .container {
      display: flex;
      gap: 20px;
      max-width: 1200px;
    }
    .sidebar {
      width: 200px;
      flex-shrink: 0;
    }
    .main-content {
      flex-grow: 1;
    }
    .sidebar button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 5px;
      text-align: left;
      cursor: pointer;
    }
    .sidebar button.active {
      background: #4a6bff;
      color: white;
    }
    ul#songs-list, ul#song-requests-list, ul#access-requests-list { list-style:none; padding:0; }
    li.song-item{ padding:10px 0; border-bottom:1px solid #eee; }
    .hint{ color:#666; font-size:13px; margin-top:8px; }
    .error{ color:#c62828; font-weight:700; }
    .ok{ color:#2e7d32; font-weight:700; }
    footer { margin-top:20px; color:#666; font-size:13px; }
    .request-item {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .request-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    #upload-status {
      margin-top: 10px;
      font-size: 14px;
    }
    .catbox-instructions {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #4a6bff;
    }
    .access-request-item {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    .approve-all-btn {
      margin-bottom: 15px;
      background: #2e7d32;
      color: white;
    }
  </style>
</head>
<body>
  <h1>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</h1>

  <!-- Admin Panel -->
  <div id="admin-panel">
    <h2>ðŸŽ§ Admin Paneli</h2>
    <div class="container">
      <div class="sidebar">
        <button id="btn-library" class="active">KitaplÄ±k</button>
        <button id="btn-add-song">ÅžarkÄ± Ekle</button>
        <button id="btn-song-requests">ÅžarkÄ± Ä°stekleri</button>
        <button id="btn-access-requests">GiriÅŸ OnaylarÄ±</button>
      </div>
      <div class="main-content">
        <!-- KitaplÄ±k BÃ¶lÃ¼mÃ¼ -->
        <div id="library-section">
          <h3>MÃ¼zik KitaplÄ±ÄŸÄ±</h3>
          <div id="songs-container">
            <ul id="songs-list"></ul>
          </div>
        </div>
        
        <!-- ÅžarkÄ± Ekleme BÃ¶lÃ¼mÃ¼ -->
        <div id="add-song-section" style="display:none">
          <h3>ÅžarkÄ± Ekle</h3>
          <label>ÅžarkÄ± AdÄ±</label>
          <input id="song-name" placeholder="Ã–rnek: Faded" />
          <label>SanatÃ§Ä±</label>
          <input id="song-artist" placeholder="Ã–rnek: Alan Walker" />
          <label>Dosya URL (catbox veya mp3 linki)</label>
          <input id="song-url" placeholder="https://..." />
          <div style="display:flex; gap:8px;">
            <button id="addSongBtn">ÅžarkÄ±yÄ± Ekle</button>
            <button id="clearBtn" style="background:#eee">Temizle</button>
          </div>
          <p id="admin-msg" class="hint"></p>
        </div>
        
        <!-- ÅžarkÄ± Ä°stekleri BÃ¶lÃ¼mÃ¼ -->
        <div id="song-requests-section" style="display:none">
          <h3>ÅžarkÄ± Ä°stekleri</h3>
          <div id="song-requests-container">
            <ul id="song-requests-list"></ul>
          </div>
        </div>
        
        <!-- GiriÅŸ OnaylarÄ± BÃ¶lÃ¼mÃ¼ -->
        <div id="access-requests-section" style="display:none">
          <h3>GiriÅŸ OnaylarÄ±</h3>
          <button id="approveAllBtn" class="approve-all-btn">TÃ¼mÃ¼nÃ¼ Onayla</button>
          <div id="access-requests-container">
            <ul id="access-requests-list"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel">
    <h2>ðŸ“€ MÃ¼zik KitaplÄ±ÄŸÄ±</h2>
    <div class="container">
      <div class="sidebar">
        <button id="user-btn-library" class="active">KitaplÄ±k</button>
        <button id="user-btn-song-request">ÅžarkÄ± Ä°steÄŸi</button>
      </div>
      <div class="main-content">
        <!-- KullanÄ±cÄ± KitaplÄ±k BÃ¶lÃ¼mÃ¼ -->
        <div id="user-library-section">
          <div id="user-songs-container">
            <ul id="user-songs-list"></ul>
          </div>
        </div>
        
        <!-- ÅžarkÄ± Ä°steÄŸi BÃ¶lÃ¼mÃ¼ -->
        <div id="user-song-request-section" style="display:none">
          <h3>ÅžarkÄ± Ä°steÄŸi GÃ¶nder</h3>
          <label>ÅžarkÄ± AdÄ±</label>
          <input id="request-song-name" placeholder="Ã–rnek: Faded" />
          <label>SanatÃ§Ä±</label>
          <input id="request-song-artist" placeholder="Ã–rnek: Alan Walker" />
          
          <div class="catbox-instructions">
            <h4>Dosya YÃ¼kleme TalimatlarÄ±:</h4>
            <ol>
              <li><button onclick="window.open('https://catbox.moe/', '_blank')">Catbox.moe'ya Git</button></li>
              <li>DosyanÄ±zÄ± catbox.moe'ya yÃ¼kleyin</li>
              <li>YÃ¼kleme tamamlandÄ±ÄŸÄ±nda size verilen linki aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±rÄ±n</li>
            </ol>
          </div>
          
          <label>Catbox.moe Dosya Linki</label>
          <input id="request-song-url" placeholder="https://files.catbox.moe/..." />
          
          <div style="display:flex; gap:8px; margin-top:15px">
            <button id="sendRequestBtn">ÅžarkÄ± Ä°steÄŸi GÃ¶nder</button>
          </div>
          <p id="user-request-msg" class="hint"></p>
        </div>
      </div>
    </div>
    <p id="user-ip" class="hint"></p>
    <p id="user-msg" class="hint"></p>
  </div>

  <footer>
    <div id="debug" class="hint"></div>
  </footer>

  <!-- Supabase ESM import (tarayÄ±cÄ±da Ã§alÄ±ÅŸÄ±r) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- SENÄ°N SUPABASE BÄ°LGÄ°LERÄ°N (sen verdiÄŸin) ---
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ADMIN IP (senin verdiÄŸin) ---
    const ADMIN_IP = "151.250.4.2";

    // Elemanlar
    const adminPanel = document.getElementById('admin-panel');
    const userPanel = document.getElementById('user-panel');
    const userIpP = document.getElementById('user-ip');
    const songsList = document.getElementById('songs-list');
    const userSongsList = document.getElementById('user-songs-list');
    const songRequestsList = document.getElementById('song-requests-list');
    const accessRequestsList = document.getElementById('access-requests-list');
    const adminMsg = document.getElementById('admin-msg');
    const userMsg = document.getElementById('user-msg');
    const userRequestMsg = document.getElementById('user-request-msg');
    const debug = document.getElementById('debug');
    const addSongBtn = document.getElementById('addSongBtn');
    const clearBtn = document.getElementById('clearBtn');
    const sendRequestBtn = document.getElementById('sendRequestBtn');
    const approveAllBtn = document.getElementById('approveAllBtn');

    // OnaylanmÄ±ÅŸ IP'ler (localStorage'da saklanacak)
    let approvedIPs = JSON.parse(localStorage.getItem('approvedIPs')) || [];

    // Sayfa aÃ§Ä±lÄ±nca IP'yi al, admin mi kontrol et, ÅŸarkÄ±larÄ± yÃ¼kle
    async function init() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const d = await res.json();
        const ip = d.ip || 'unknown';
        debug.innerText = ""; // baÅŸlangÄ±Ã§ta temiz
        console.log("GÃ¶rÃ¼nen IP:", ip);

        // IP'yi kaydet
        localStorage.setItem('currentIP', ip);
        
        // EÄŸer admin IP'si ise
        if (ip === ADMIN_IP) {
          // admin
          adminPanel.style.display = 'block';
          userPanel.style.display = 'none';
          adminMsg.innerText = `Admin olarak giriÅŸ yaptÄ±nÄ±z (IP: ${ip}).`;
          await loadSongRequests(); // ÅžarkÄ± isteklerini yÃ¼kle
          await loadAccessRequests(); // GiriÅŸ isteklerini yÃ¼kle
        } else {
          // normal kullanÄ±cÄ± - artÄ±k direkt girebiliyor
          adminPanel.style.display = 'none';
          userPanel.style.display = 'block';
          userIpP.innerText = `Senin IP adresin: ${ip}`;
          userMsg.innerText = ``;
          
          // IP'yi access requests tablosuna kaydet
          await saveAccessRequest(ip);
        }

        // ÅžarkÄ±larÄ± her durumda yÃ¼kle
        await loadSongs();
      } catch (err) {
        debug.innerText = "IP alÄ±nÄ±rken hata: " + (err.message || err);
        console.error(err);
        // Hata olsa bile ÅŸarkÄ±larÄ± dene
        await loadSongs();
        adminPanel.style.display = 'none';
        userPanel.style.display = 'block';
      }
    }

    // EriÅŸim isteÄŸini kaydet
    async function saveAccessRequest(ip) {
      try {
        // Ã–ncelikle bu IP zaten kayÄ±tlÄ± mÄ± kontrol et
        const { data: existingRequests, error: checkError } = await supabase
          .from('AccessRequests')
          .select('*')
          .eq('ip', ip);

        if (checkError) {
          console.error("IP kontrol hatasÄ±:", checkError);
          return;
        }

        // EÄŸer bu IP zaten kayÄ±tlÄ± deÄŸilse ekle
        if (!existingRequests || existingRequests.length === 0) {
          const { error } = await supabase
            .from('AccessRequests')
            .insert([{ 
              ip: ip, 
              status: 'pending',
              created_at: new Date().toISOString()
            }]);

          if (error) {
            console.error("EriÅŸim isteÄŸi kaydetme hatasÄ±:", error);
          }
        }
      } catch (err) {
        console.error("EriÅŸim isteÄŸi kaydetme hatasÄ±:", err);
      }
    }

    // ÅžarkÄ± ekleme
    async function addSong() {
      adminMsg.innerText = "";
      const name = document.getElementById('song-name').value.trim();
      const artist = document.getElementById('song-artist').value.trim();
      const url = document.getElementById('song-url').value.trim();

      if (!name || !artist || !url) {
        adminMsg.innerText = "LÃ¼tfen tÃ¼m alanlarÄ± doldurun (name, artist, url).";
        adminMsg.className = "error";
        return;
      }

      // insert dene
      try {
        adminMsg.innerText = "Kaydediliyor...";
        addSongBtn.disabled = true;

        const payload = { name, artist, url };
        const { data, error } = await supabase
          .from('Songs')    // tablo adÄ±: public.Songs
          .insert([payload]);

        if (error) {
          // RLS veya benzeri bir problem varsa error.message burada olacak
          adminMsg.innerText = "Hata: " + error.message;
          adminMsg.className = "error";
          console.error("Supabase insert error:", error);
          // EÄŸer RLS hatasÄ±ysa kullanÄ±cÄ±ya SQL dÃ¼zeltmesi gerektiÄŸini sÃ¶yle
          if (error.message && error.message.toLowerCase().includes('row-level')) {
            adminMsg.innerText += " â€” RLS policy izinlerini kontrol et (SQL tarafÄ±nda insert izni ver).";
          }
        } else {
          adminMsg.innerText = "ÅžarkÄ± baÅŸarÄ±yla eklendi âœ…";
          adminMsg.className = "ok";
          // form temizle
          document.getElementById('song-name').value = '';
          document.getElementById('song-artist').value = '';
          document.getElementById('song-url').value = '';
          await loadSongs();
        }
      } catch (err) {
        adminMsg.innerText = "Beklenmeyen hata: " + (err.message || err);
        adminMsg.className = "error";
        console.error("Insert exception:", err);
      } finally {
        addSongBtn.disabled = false;
      }
    }

    // ÅžarkÄ± isteÄŸi gÃ¶nderme
    async function sendSongRequest() {
      userRequestMsg.innerText = "";
      const name = document.getElementById('request-song-name').value.trim();
      const artist = document.getElementById('request-song-artist').value.trim();
      const url = document.getElementById('request-song-url').value.trim();

      if (!name || !artist || !url) {
        userRequestMsg.innerText = "LÃ¼tfen tÃ¼m alanlarÄ± doldurun.";
        userRequestMsg.className = "error";
        return;
      }

      // URL'nin geÃ§erli bir catbox URL'si olup olmadÄ±ÄŸÄ±nÄ± kontrol et
      if (!url.includes('catbox.moe')) {
        userRequestMsg.innerText = "LÃ¼tfen geÃ§erli bir catbox.moe URL'si girin.";
        userRequestMsg.className = "error";
        return;
      }

      try {
        userRequestMsg.innerText = "Ä°stek gÃ¶nderiliyor...";
        sendRequestBtn.disabled = true;

        const payload = { 
          name, 
          artist, 
          file_url: url,
          status: 'pending' // pending, approved, rejected
        };
        
        const { data, error } = await supabase
          .from('SongRequests')    // Yeni tablo
          .insert([payload]);

        if (error) {
          userRequestMsg.innerText = "Hata: " + error.message;
          userRequestMsg.className = "error";
          console.error("Supabase insert error:", error);
        } else {
          userRequestMsg.innerText = "ÅžarkÄ± isteÄŸi baÅŸarÄ±yla gÃ¶nderildi âœ…";
          userRequestMsg.className = "ok";
          // form temizle
          document.getElementById('request-song-name').value = '';
          document.getElementById('request-song-artist').value = '';
          document.getElementById('request-song-url').value = '';
        }
      } catch (err) {
        userRequestMsg.innerText = "Beklenmeyen hata: " + (err.message || err);
        userRequestMsg.className = "error";
        console.error("Insert exception:", err);
      } finally {
        sendRequestBtn.disabled = false;
      }
    }

    // GiriÅŸ isteklerini yÃ¼kle (admin iÃ§in)
    async function loadAccessRequests() {
      accessRequestsList.innerHTML = 'YÃ¼kleniyor...';
      try {
        const { data, error } = await supabase
          .from('AccessRequests')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          accessRequestsList.innerHTML = `<li class="error">Ä°stekler yÃ¼klenemedi: ${error.message}</li>`;
          console.error("Supabase select error:", error);
          return;
        }

        if (!data || data.length === 0) {
          accessRequestsList.innerHTML = '<li class="hint">HenÃ¼z giriÅŸ isteÄŸi yok.</li>';
          return;
        }

        accessRequestsList.innerHTML = '';
        data.forEach(request => {
          const li = document.createElement('li');
          li.className = 'access-request-item';
          li.innerHTML = `
            <div><strong>IP Adresi:</strong> ${escapeHtml(request.ip || '')}</div>
            <div><strong>Durum:</strong> ${request.status || 'pending'}</div>
            <div><strong>Ä°stek ZamanÄ±:</strong> ${new Date(request.created_at).toLocaleString('tr-TR')}</div>
            ${request.status === 'pending' ? `
              <div class="request-actions">
                <button class="approve-access-btn" data-ip="${escapeAttr(request.ip)}">Onayla</button>
              </div>
            ` : ''}
          `;
          accessRequestsList.appendChild(li);
        });

        // Onayla butonlarÄ±na event ekle
        document.querySelectorAll('.approve-access-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const ip = btn.getAttribute('data-ip');
            approveAccessRequest(ip);
          });
        });

      } catch (err) {
        accessRequestsList.innerHTML = `<li class="error">Beklenmeyen istek yÃ¼kleme hatasÄ±: ${err.message || err}</li>`;
        console.error(err);
      }
    }

    // TÃ¼m giriÅŸ isteklerini onayla
    async function approveAllAccessRequests() {
      try {
        const { data: requests, error: fetchError } = await supabase
          .from('AccessRequests')
          .select('*')
          .eq('status', 'pending');

        if (fetchError) {
          console.error("Ä°stekleri getirme hatasÄ±:", fetchError);
          return;
        }

        if (!requests || requests.length === 0) {
          alert("Onay bekleyen istek bulunamadÄ±.");
          return;
        }

        // TÃ¼m bekleyen istekleri onayla
        for (const request of requests) {
          const { error } = await supabase
            .from('AccessRequests')
            .update({ status: 'approved' })
            .eq('id', request.id);

          if (error) {
            console.error(`IP ${request.ip} onaylama hatasÄ±:`, error);
          } else {
            // Onaylanan IP'yi localStorage'a ekle
            if (!approvedIPs.includes(request.ip)) {
              approvedIPs.push(request.ip);
            }
          }
        }

        // localStorage'Ä± gÃ¼ncelle
        localStorage.setItem('approvedIPs', JSON.stringify(approvedIPs));
        
        // Listeyi yenile
        await loadAccessRequests();
        
        alert("TÃ¼m istekler onaylandÄ±!");
      } catch (err) {
        console.error("Toplu onaylama hatasÄ±:", err);
      }
    }

    // GiriÅŸ isteÄŸini onayla
    async function approveAccessRequest(ip) {
      try {
        const { error } = await supabase
          .from('AccessRequests')
          .update({ status: 'approved' })
          .eq('ip', ip);

        if (error) {
          console.error("Ä°stek onaylama hatasÄ±:", error);
        } else {
          // Onaylanan IP'yi localStorage'a ekle
          if (!approvedIPs.includes(ip)) {
            approvedIPs.push(ip);
            localStorage.setItem('approvedIPs', JSON.stringify(approvedIPs));
          }
          
          // Listeyi yenile
          await loadAccessRequests();
        }
      } catch (err) {
        console.error("Ä°stek onaylama hatasÄ±:", err);
      }
    }

    // ÅžarkÄ± isteklerini yÃ¼kle (admin iÃ§in)
    async function loadSongRequests() {
      songRequestsList.innerHTML = 'YÃ¼kleniyor...';
      try {
        const { data, error } = await supabase
          .from('SongRequests')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          songRequestsList.innerHTML = `<li class="error">Ä°stekler yÃ¼klenemedi: ${error.message}</li>`;
          console.error("Supabase select error:", error);
          return;
        }

        if (!data || data.length === 0) {
          songRequestsList.innerHTML = '<li class="hint">HenÃ¼z ÅŸarkÄ± isteÄŸi yok.</li>';
          return;
        }

        songRequestsList.innerHTML = '';
        data.forEach(request => {
          const li = document.createElement('li');
          li.className = 'request-item';
          li.innerHTML = `
            <div><strong>${escapeHtml(request.name || '')}</strong> - ${escapeHtml(request.artist || '')}</div>
            <div class="hint">Durum: ${request.status || 'pending'}</div>
            <div class="request-actions">
              <button class="play-btn" data-url="${escapeAttr(request.file_url || '')}">Dinle</button>
              ${request.status === 'pending' ? `
                <button class="approve-btn" data-id="${request.id}" data-name="${escapeAttr(request.name)}" data-artist="${escapeAttr(request.artist)}" data-url="${escapeAttr(request.file_url)}">Onayla</button>
                <button class="reject-btn" data-id="${request.id}">Reddet</button>
              ` : ''}
            </div>
          `;
          songRequestsList.appendChild(li);
        });

        // Dinle butonlarÄ±na event ekle
        document.querySelectorAll('.play-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const url = btn.getAttribute('data-url');
            if (url) {
              window.open(url, '_blank');
            }
          });
        });

        // Onayla butonlarÄ±na event ekle
        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            const artist = btn.getAttribute('data-artist');
            const fileUrl = btn.getAttribute('data-url');
            
            // ÅžarkÄ± ekleme formunu doldur
            document.getElementById('song-name').value = name;
            document.getElementById('song-artist').value = artist;
            document.getElementById('song-url').value = fileUrl;
            
            // ÅžarkÄ± isteÄŸini onayla
            approveSongRequest(id);
            
            // ÅžarkÄ± ekleme bÃ¶lÃ¼mÃ¼ne geÃ§
            document.getElementById('btn-add-song').click();
          });
        });

        // Reddet butonlarÄ±na event ekle
        document.querySelectorAll('.reject-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            rejectSongRequest(id);
          });
        });

      } catch (err) {
        songRequestsList.innerHTML = `<li class="error">Beklenmeyen istek yÃ¼kleme hatasÄ±: ${err.message || err}</li>`;
        console.error(err);
      }
    }

    // ÅžarkÄ± isteÄŸini onayla
    async function approveSongRequest(id) {
      try {
        const { error } = await supabase
          .from('SongRequests')
          .update({ status: 'approved' })
          .eq('id', id);

        if (error) {
          console.error("Ä°stek onaylama hatasÄ±:", error);
        } else {
          // Listeyi yenile
          await loadSongRequests();
        }
      } catch (err) {
        console.error("Ä°stek onaylama hatasÄ±:", err);
      }
    }

    // ÅžarkÄ± isteÄŸini reddet
    async function rejectSongRequest(id) {
      try {
        const { error } = await supabase
          .from('SongRequests')
          .update({ status: 'rejected' })
          .eq('id', id);

        if (error) {
          console.error("Ä°stek reddetme hatasÄ±:", error);
        } else {
          // Listeyi yenile
          await loadSongRequests();
        }
      } catch (err) {
        console.error("Ä°stek reddetme hatasÄ±:", err);
      }
    }

    // ÅžarkÄ±larÄ± yÃ¼kle / listele
    async function loadSongs() {
      const lists = [songsList, userSongsList];
      
      for (const list of lists) {
        if (list) list.innerHTML = 'YÃ¼kleniyor...';
      }
      
      try {
        const { data, error } = await supabase
          .from('Songs')
          .select('*')
          .order('id', { ascending: false });

        if (error) {
          const errorMsg = `<li class="error">Liste yÃ¼klenemedi: ${error.message}</li>`;
          for (const list of lists) {
            if (list) list.innerHTML = errorMsg;
          }
          console.error("Supabase select error:", error);
          return;
        }

        if (!data || data.length === 0) {
          const emptyMsg = '<li class="hint">HenÃ¼z ÅŸarkÄ± yok.</li>';
          for (const list of lists) {
            if (list) list.innerHTML = emptyMsg;
          }
          return;
        }

        for (const list of lists) {
          if (!list) continue;
          
          list.innerHTML = '';
          data.forEach(s => {
            const li = document.createElement('li');
            li.className = 'song-item';
            // GÃ¼venlik: user tarafÄ±ndan gÃ¶nderilen url'leri direkt koyuyoruz - catbox/cdn linki olduÄŸundan genelde Ã§alÄ±ÅŸÄ±r.
            li.innerHTML = `<strong>${escapeHtml(s.name || '')}</strong> - ${escapeHtml(s.artist || '')}
                            <div style="margin-top:6px">
                              <audio controls preload="none" src="${escapeAttr(s.url || '')}" style="width:100%;max-width:600px"></audio>
                            </div>`;
            list.appendChild(li);
          });
        }
      } catch (err) {
        const errorMsg = `<li class="error">Beklenmeyen liste hatasÄ±: ${err.message || err}</li>`;
        for (const list of lists) {
          if (list) list.innerHTML = errorMsg;
        }
        console.error(err);
      }
    }

    // Basit escaping yardÄ±mcÄ±larÄ±
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }
    function escapeAttr(text) { return escapeHtml(text); }

    // Sidebar butonlarÄ± iÃ§in event listener'lar
    function setupSidebarButtons() {
      // Admin paneli butonlarÄ±
      document.getElementById('btn-library').addEventListener('click', () => {
        document.getElementById('library-section').style.display = 'block';
        document.getElementById('add-song-section').style.display = 'none';
        document.getElementById('song-requests-section').style.display = 'none';
        document.getElementById('access-requests-section').style.display = 'none';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-library').classList.add('active');
      });
      
      document.getElementById('btn-add-song').addEventListener('click', () => {
        document.getElementById('library-section').style.display = 'none';
        document.getElementById('add-song-section').style.display = 'block';
        document.getElementById('song-requests-section').style.display = 'none';
        document.getElementById('access-requests-section').style.display = 'none';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-add-song').classList.add('active');
      });
      
      document.getElementById('btn-song-requests').addEventListener('click', () => {
        document.getElementById('library-section').style.display = 'none';
        document.getElementById('add-song-section').style.display = 'none';
        document.getElementById('song-requests-section').style.display = 'block';
        document.getElementById('access-requests-section').style.display = 'none';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-song-requests').classList.add('active');
      });
      
      document.getElementById('btn-access-requests').addEventListener('click', () => {
        document.getElementById('library-section').style.display = 'none';
        document.getElementById('add-song-section').style.display = 'none';
        document.getElementById('song-requests-section').style.display = 'none';
        document.getElementById('access-requests-section').style.display = 'block';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-access-requests').classList.add('active');
      });
      
      // KullanÄ±cÄ± paneli butonlarÄ±
      document.getElementById('user-btn-library').addEventListener('click', () => {
        document.getElementById('user-library-section').style.display = 'block';
        document.getElementById('user-song-request-section').style.display = 'none';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('#user-panel .sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('user-btn-library').classList.add('active');
      });
      
      document.getElementById('user-btn-song-request').addEventListener('click', () => {
        document.getElementById('user-library-section').style.display = 'none';
        document.getElementById('user-song-request-section').style.display = 'block';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('#user-panel .sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('user-btn-song-request').classList.add('active');
      });
    }

    // eventler
    addSongBtn.addEventListener('click', addSong);
    clearBtn.addEventListener('click', () => {
      document.getElementById('song-name').value = '';
      document.getElementById('song-artist').value = '';
      document.getElementById('song-url').value = '';
      adminMsg.innerText = '';
    });
    
    sendRequestBtn.addEventListener('click', sendSongRequest);
    approveAllBtn.addEventListener('click', approveAllAccessRequests);

    // baÅŸlat
    init();
    setupSidebarButtons();
  </script>
</body>
</html>
