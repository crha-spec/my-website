<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Müzik Kütüphanesi - Onayla/Reddet + Kayan Sözler</title>
  <style>
    body { font-family: Inter, "Segoe UI", Arial; background:#111; color:#fff; margin:0; padding:20px; }
    .app { max-width:1100px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; padding:14px; background:#1f1f1f; border-radius:8px; margin-bottom:18px;}
    .panels { display:flex; gap:18px; }
    .panel { background:#1b1b1b; border-radius:8px; padding:14px; flex:1; min-width:280px; }
    .sidebar { display:flex; gap:8px; margin-bottom:12px; }
    .btn { padding:8px 12px; border-radius:6px; border:0; cursor:pointer; background:#2b2b2b; color:#fff; }
    .btn.primary { background:#3b82f6; }
    .btn.danger { background:#ef4444; }
    .btn.approve { background:#06d6a0; color:#042a2b; }
    .list { list-style:none; padding:0; margin:0; }
    li.item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); }
    input, textarea { width:100%; padding:8px; border-radius:6px; border:0; margin-bottom:8px; background:#0f1720; color:#fff; }
    label { font-size:13px; color:#aaa; }
    .cover { width:220px; height:220px; object-fit:cover; border-radius:10px; display:block; margin:0 auto 12px; }
    #lyrics-box { position:relative; height:64px; overflow:hidden; margin-top:12px; }
    .lyric-line { position:absolute; width:100%; text-align:center; left:0; top:0; transition:transform 0.6s ease; font-weight:600; }
    footer { margin-top:18px; font-size:13px; color:#aaa; text-align:center; }
    a.link { color:#8ab4ff; text-decoration:none; margin-left:8px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div><strong>🎵 Kişisel Müzik Kütüphanesi</strong></div>
      <div><span id="user-type">—</span></div>
    </header>

    <div class="panels">
      <!-- Admin panel sol -->
      <div class="panel" id="admin-panel" style="display:none">
        <div class="sidebar">
          <button class="btn primary" id="show-library">Kitaplık</button>
          <button class="btn" id="show-add">Şarkı Ekle</button>
          <button class="btn" id="show-requests">İstekler</button>
          <button class="btn" id="show-now">Şu An Çalan</button>
        </div>

        <div id="admin-library" style="display:block">
          <h3>Kitaplık</h3>
          <ul id="songs-list" class="list"></ul>
        </div>

        <div id="admin-add" style="display:none">
          <h3>Şarkı Ekle (Admin)</h3>
          <label>Şarkı Adı</label>
          <input id="song-name" placeholder="Şarkı adı">
          <label>Sanatçı</label>
          <input id="song-artist" placeholder="Sanatçı">
          <label>MP3 URL</label>
          <input id="song-url" placeholder="https://... .mp3">
          <label>Kapak URL</label>
          <input id="song-cover" placeholder="Kapak görseli URL (opsiyonel)">
          <label>Şarkı Sözleri (her satır ayrı satır)</label>
          <textarea id="song-lyrics" rows="4" placeholder="her satırı yeni bir satır yap"></textarea>
          <button class="btn primary" id="addSongBtn">Ekle</button>
          <div id="admin-msg" style="margin-top:8px;color:#9ae6b4"></div>
        </div>

        <div id="admin-requests" style="display:none">
          <h3>Şarkı İstekleri</h3>
          <ul id="requests-list" class="list"></ul>
        </div>

        <div id="admin-now" style="display:none; text-align:center">
          <h3>Şu An Çalan (Admin)</h3>
          <img id="now-cover" class="cover" src="" alt="kapak">
          <div id="now-info">Henüz şarkı seçilmedi</div>

          <div style="margin-top:10px;">
            <button class="btn" id="prevBtn">⏮</button>
            <button class="btn primary" id="toggleBtn">⏯</button>
            <button class="btn" id="nextBtn">⏭</button>
          </div>

          <div id="lyrics-box">
            <div id="lyrics-line" class="lyric-line">Henüz şarkı seçilmedi</div>
          </div>
        </div>
      </div>

      <!-- User panel sağ -->
      <div class="panel" id="user-panel" style="display:none">
        <div class="sidebar">
          <button class="btn primary" id="user-show-library">Kitaplık</button>
          <button class="btn" id="user-show-req">Şarkı İsteği</button>
          <button class="btn" id="user-show-now">Şu An Çalan</button>
        </div>

        <div id="user-library" style="display:block">
          <h3>Kitaplık</h3>
          <ul id="user-songs-list" class="list"></ul>
        </div>

        <div id="user-request" style="display:none">
          <h3>Şarkı İsteği Gönder</h3>
          <label>Şarkı Adı</label><input id="req-name" placeholder="Şarkı adı">
          <label>Sanatçı</label><input id="req-artist" placeholder="Sanatçı">
          <label>Catbox Link (veya mp3 link)</label><input id="req-file" placeholder="https://files.catbox.moe/....">
          <label>Kapak URL (opsiyonel)</label><input id="req-cover" placeholder="Kapak URL">
          <label>Sözler (opsiyonel)</label><textarea id="req-lyrics" rows="4"></textarea>
          <button class="btn primary" id="sendReqBtn">İstek Gönder</button>
          <div id="req-msg" style="margin-top:8px;color:#9ae6b4"></div>
        </div>

        <div id="user-now" style="display:none; text-align:center">
          <h3>Şu An Çalan (Kullanıcı)</h3>
          <img id="user-cover" class="cover" src="" alt="kapak">
          <div id="user-info">Henüz şarkı seçilmedi</div>
          <div style="margin-top:10px;">
            <button class="btn" id="uPrevBtn">⏮</button>
            <button class="btn primary" id="uToggleBtn">⏯</button>
            <button class="btn" id="uNextBtn">⏭</button>
          </div>
          <div id="user-lyrics-box">
            <div id="user-lyrics-line" class="lyric-line">Henüz şarkı seçilmedi</div>
          </div>
        </div>
      </div>
    </div>

    <div id="player-bar" style="position:fixed;left:0;right:0;bottom:0;background:#000;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;">
      <div id="player-info">Henüz şarkı seçilmedi</div>
      <audio id="main-player" controls style="width:320px"></audio>
    </div>

    <footer>Supabase ile çalışan demo — kapak & sözler ve istek onay sistemi</footer>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ====== Supabase Ayarları ======
   (Eğer kendi anon key'in varsa buraya koyabilirsin)
   NOT: Bu örnekte user verdiği anahtarı kullanıyoruz; üretimde güvenlik açısından dikkat et.
*/
const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====== Genel durum ====== */
const ADMIN_IP = "151.250.4.2";
let allSongs = [];
let currentIndex = -1;
let lyricsTimer = null;

/* DOM refs */
const songsList = document.getElementById("songs-list");
const userSongsList = document.getElementById("user-songs-list");
const requestsList = document.getElementById("requests-list");
const mainPlayer = document.getElementById("main-player");
const playerInfo = document.getElementById("player-info");

/* Init: IP kontrolü ve yükleme */
(async function init(){
  try {
    const ipRes = await fetch("https://api64.ipify.org?format=json");
    const ipJson = await ipRes.json();
    const ip = ipJson.ip || "";
    if (ip === ADMIN_IP) {
      document.getElementById("admin-panel").style.display = "block";
      document.getElementById("user-type").textContent = "Admin";
      setupAdminMenu();
      await loadSongRequests();
    } else {
      document.getElementById("user-panel").style.display = "block";
      document.getElementById("user-type").textContent = "Kullanıcı";
      setupUserMenu();
    }
  } catch (e) {
    // IP alınamazsa user panel göster
    document.getElementById("user-panel").style.display = "block";
    document.getElementById("user-type").textContent = "Kullanıcı";
    setupUserMenu();
  }
  await loadSongs();
})();

/* --- SONGS yükle ve listele --- */
async function loadSongs(){
  const { data, error } = await supabase.from("songs").select("*").order("id", { ascending: true });
  if (error) { console.error("loadSongs error:", error); return; }
  allSongs = data || [];
  renderSongs();
}
function renderSongs(){
  songsList.innerHTML = "";
  userSongsList.innerHTML = "";
  allSongs.forEach((s, i) => {
    const li = document.createElement("li"); li.className = "item";
    li.innerHTML = `<div><strong>${escapeHtml(s.name)}</strong> - ${escapeHtml(s.artist)}</div>
                    <div>
                      <button class="btn play" data-index="${i}">Çal</button>
                      <a class="link" href="${escapeAttr(s.url||'')}" target="_blank" rel="noopener">🎧 Aç</a>
                    </div>`;
    songsList.appendChild(li);

    const uli = li.cloneNode(true);
    uli.querySelector('.play').dataset.index = i;
    userSongsList.appendChild(uli);
  });

  // eventleri bağla
  document.querySelectorAll('.play').forEach(b => {
    b.onclick = () => playSong(parseInt(b.dataset.index));
  });
}

/* --- PLAY / NOW PLAYING / LYRICS --- */
function playSong(index){
  if (!allSongs || !allSongs.length) return;
  if (index < 0 || index >= allSongs.length) return;
  currentIndex = index;
  const s = allSongs[index];
  mainPlayer.src = s.url || s.file_url || "";
  mainPlayer.play().catch(()=>{ /* otomatik oynatma engellenirse sessiz devam eder */ });
  playerInfo.textContent = `${s.name} - ${s.artist}`;

  // admin now
  document.getElementById("now-cover").src = s.cover_url || s.cover || "https://via.placeholder.com/220";
  document.getElementById("now-info").textContent = `${s.name} - ${s.artist}`;
  startLyrics(s.lyrics || "", "lyrics-line");

  // user now
  document.getElementById("user-cover").src = s.cover_url || s.cover || "https://via.placeholder.com/220";
  document.getElementById("user-info").textContent = `${s.name} - ${s.artist}`;
  startLyrics(s.lyrics || "", "user-lyrics-line");
}

function startLyrics(lyrics, elId){
  clearInterval(lyricsTimer);
  const el = document.getElementById(elId);
  if (!lyrics || !lyrics.trim()) {
    el.textContent = "Bu şarkıya söz eklenmemiş.";
    return;
  }
  const lines = lyrics.split("\n").map(l=>l.trim()).filter(Boolean);
  if (!lines.length) { el.textContent = "Bu şarkıya söz eklenmemiş."; return; }
  let idx = 0;
  el.style.transition = "none";
  el.style.transform = "translateY(0)";
  el.textContent = lines[idx];

  lyricsTimer = setInterval(()=>{
    idx = (idx + 1) % lines.length;
    // kaydırma animasyonu: yukarı kaydır -> reset alt -> yeni satırı yukarı getirme
    el.style.transition = "transform 0.6s ease";
    el.style.transform = "translateY(-100%)";
    setTimeout(()=>{
      el.style.transition = "none";
      el.style.transform = "translateY(100%)";
      el.textContent = lines[idx];
      setTimeout(()=>{ el.style.transition = "transform 0.6s ease"; el.style.transform = "translateY(0)"; }, 40);
    }, 600);
  }, 3000);
}

/* Kontroller */
document.getElementById("prevBtn").onclick = ()=> { if (currentIndex>0) playSong(currentIndex-1); };
document.getElementById("nextBtn").onclick = ()=> { if (currentIndex < allSongs.length-1) playSong(currentIndex+1); };
document.getElementById("toggleBtn").onclick = ()=> { if (mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); };
document.getElementById("uPrevBtn").onclick = ()=> { if (currentIndex>0) playSong(currentIndex-1); };
document.getElementById("uNextBtn").onclick = ()=> { if (currentIndex < allSongs.length-1) playSong(currentIndex+1); };
document.getElementById("uToggleBtn").onclick = ()=> { if (mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); };

/* --- ADD SONG (admin) --- */
document.getElementById("addSongBtn").onclick = async () => {
  const name = document.getElementById("song-name").value.trim();
  const artist = document.getElementById("song-artist").value.trim();
  const url = document.getElementById("song-url").value.trim();
  const cover = document.getElementById("song-cover").value.trim();
  const lyrics = document.getElementById("song-lyrics").value.trim();
  const msg = document.getElementById("admin-msg");
  if (!name || !artist || !url) { msg.textContent = "Alanlar boş olamaz"; return; }
  const { error } = await supabase.from("songs").insert([{ name, artist, url, lyrics, cover_url: cover }]);
  if (error) { msg.textContent = "Hata: " + error.message; console.error(error); }
  else { msg.textContent = "✅ Şarkı eklendi"; document.getElementById("song-name").value=''; document.getElementById("song-artist").value=''; document.getElementById("song-url").value=''; document.getElementById("song-cover").value=''; document.getElementById("song-lyrics").value=''; await loadSongs(); }
};

/* --- Song Requests: load / render / approve / reject / send --- */
async function loadSongRequests(){
  const { data, error } = await supabase.from("songrequests").select("*").order("created_at", { ascending: false });
  if (error) { console.error("loadSongRequests", error); return; }
  requestsList.innerHTML = "";
  (data || []).forEach(req => {
    const li = document.createElement("li"); li.className = "item";
    const left = document.createElement("div"); left.innerHTML = `<strong>${escapeHtml(req.name)}</strong> - ${escapeHtml(req.artist)}`;
    const right = document.createElement("div");
    const playBtn = document.createElement("button"); playBtn.className="btn"; playBtn.textContent="Dinle";
    const approveBtn = document.createElement("button"); approveBtn.className="btn approve"; approveBtn.textContent="Onayla";
    const rejectBtn = document.createElement("button"); rejectBtn.className="btn reject"; rejectBtn.textContent="Reddet";
    const dl = document.createElement("a"); dl.href = req.file_url; dl.target="_blank"; dl.textContent="⬇ İndir"; dl.className="link";
    playBtn.onclick = ()=> { mainPlayer.src = req.file_url; mainPlayer.play(); document.getElementById("player-info").textContent = `${req.name} - ${req.artist}`; startLyrics(req.lyrics||"", "lyrics-line"); };
    approveBtn.onclick = async ()=> {
      // onay = songs tablosuna ekle, sonra isteği sil
      const { error: insErr } = await supabase.from("songs").insert([{ name: req.name, artist: req.artist, url: req.file_url, lyrics: req.lyrics, cover_url: req.cover_url }]);
      if (insErr) { alert("Ekleme hatası: " + insErr.message); console.error(insErr); return; }
      await supabase.from("songrequests").delete().eq("id", req.id);
      await loadSongRequests();
      await loadSongs();
      // otomatik çalacak şekilde en son eklenen şarkıyı çal
      const { data: songsNow } = await supabase.from("songs").select("*").order("id", { ascending: true });
      if (songsNow && songsNow.length) {
        const idx = songsNow.findIndex(s => s.url === req.file_url && s.name === req.name);
        if (idx >= 0) {
          allSongs = songsNow;
          playSong(idx);
        } else {
          // yoksa listeyi güncelle ve sonunu çal
          allSongs = songsNow;
          playSong(allSongs.length - 1);
        }
      }
      alert("✅ İstek onaylandı ve kitaplığa eklendi");
    };
    rejectBtn.onclick = async ()=> {
      await supabase.from("songrequests").delete().eq("id", req.id);
      await loadSongRequests();
      alert("❌ İstek reddedildi");
    };
    right.appendChild(playBtn);
    right.appendChild(approveBtn);
    right.appendChild(rejectBtn);
    right.appendChild(dl);
    li.appendChild(left);
    li.appendChild(right);
    requestsList.appendChild(li);
  });
}

/* send request (user) */
document.getElementById("sendReqBtn").onclick = async () => {
  const name = document.getElementById("req-name").value.trim();
  const artist = document.getElementById("req-artist").value.trim();
  const file = document.getElementById("req-file").value.trim();
  const cover = document.getElementById("req-cover").value.trim();
  const lyrics = document.getElementById("req-lyrics").value.trim();
  const msg = document.getElementById("req-msg");
  if (!name || !artist || !file) { msg.textContent = "Eksik alan"; return; }
  const { error } = await supabase.from("songrequests").insert([{ name, artist, file_url: file, lyrics, cover_url: cover }]);
  if (error) { msg.textContent = "Hata: " + error.message; console.error(error); }
  else { msg.textContent = "✅ İstek gönderildi"; document.getElementById("req-name").value=''; document.getElementById("req-artist").value=''; document.getElementById("req-file").value=''; document.getElementById("req-cover").value=''; document.getElementById("req-lyrics").value=''; }
};

/* --- Menüler (admin & user) --- */
function setupAdminMenu(){
  document.getElementById("show-library").onclick = ()=> { showAdminSection("admin-library"); };
  document.getElementById("show-add").onclick = ()=> { showAdminSection("admin-add"); };
  document.getElementById("show-requests").onclick = async ()=> { showAdminSection("admin-requests"); await loadSongRequests(); };
  document.getElementById("show-now").onclick = ()=> { showAdminSection("admin-now"); };
  function showAdminSection(id){ ["admin-library","admin-add","admin-requests","admin-now"].forEach(x=>document.getElementById(x).style.display=(x===id?"block":"none")); }
}

function setupUserMenu(){
  document.getElementById("user-show-library").onclick = ()=> { showUserSection("user-library"); };
  document.getElementById("user-show-req").onclick = ()=> { showUserSection("user-request"); };
  document.getElementById("user-show-now").onclick = ()=> { showUserSection("user-now"); };
  function showUserSection(id){ ["user-library","user-request","user-now"].forEach(x=>document.getElementById(x).style.display=(x===id?"block":"none")); }
}

/* --- Helpers --- */
function escapeHtml(text){ if (!text) return ""; return String(text).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[m]); }
function escapeAttr(text){ return escapeHtml(text); }

</script>
</body>
</html>
