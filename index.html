<!DOCTYPE html>

<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</title>

  <!-- Supabase client (CDN) -->

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/supabase.min.js"></script>

  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#e52e71;--muted:#9aa4b2;--panel:#0b1226;}
    body{font-family: Inter, system-ui, Arial; margin:0; min-height:100vh; background: linear-gradient(135deg,#0b1536 0%, #1a0830 100%); color:#fff;}
    .wrap{max-width:1000px;margin:30px auto;padding:20px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
    header h1{font-size:22px;margin:0;color:var(--accent);}
    .grid{display:grid;grid-template-columns:220px 1fr;gap:18px;}
    .sidebar{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;}
    .side-item{padding:12px;border-radius:8px;margin-bottom:10px;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.03)}
    .side-item.active{background:rgba(229,46,113,0.12);border-color:rgba(229,46,113,0.3)}
    .main{background:rgba(255,255,255,0.03);padding:18px;border-radius:10px;min-height:400px;}
    .song-card, .req-card{background:rgba(255,255,255,0.02);padding:12px;margin-bottom:10px;border-radius:8px;}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="text"], textarea{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .ip-badge{font-size:13px;color:var(--muted);margin-top:10px}
    .notice{background:rgba(255,255,255,0.03);padding:8px;border-radius:6px;margin-top:10px;color:var(--muted)}
    audio{width:100%;margin-top:8px}
  </style>

</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸŽµ KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</h1>
      <div class="ip-badge" id="ipBadge">IP: ...</div>
    </header>

  </div>

<script>
/* =======================
   AYARLAR â€” burayÄ± gerektiÄŸinde deÄŸiÅŸtir
   ======================= */
const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";

// admin IP (sana Ã¶zel)
const ADMIN_IP = "151.250.4.2";

/* =======================
   Supabase client
   ======================= */
const { createClient } = supabase; // global provided by CDN
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

/* =======================
   DOM referanslarÄ±
   ======================= */
const ipBadge = document.getElementById('ipBadge');
const navLibrary = document.getElementById('nav-library');
const navAdd = document.getElementById('nav-add');
const navAdminPanel = document.getElementById('nav-admin-panel');
const adminLinks = document.getElementById('admin-links');

const sectionLibrary = document.getElementById('section-library');
const sectionRequest = document.getElementById('section-request');
const sectionAdminAdd = document.getElementById('section-admin-add');

const songsList = document.getElementById('songsList');
const requestsList = document.getElementById('requestsList');

const reqName = document.getElementById('req_name');
const reqArtist = document.getElementById('req_artist');
const reqFile = document.getElementById('req_file');
const sendReqBtn = document.getElementById('sendReqBtn');
const reqMsg = document.getElementById('reqMsg');

const adminName = document.getElementById('admin_name');
const adminArtist = document.getElementById('admin_artist');
const adminUrl = document.getElementById('admin_url');
const adminAddBtn = document.getElementById('adminAddBtn');
const adminAddMsg = document.getElementById('adminAddMsg');

const globalMsg = document.getElementById('globalMsg');

let currentIp = null;
let isAdmin = false;

/* =======================
   YardÄ±mcÄ±: gÃ¶rÃ¼nÃ¼m deÄŸiÅŸtir
   ======================= */
function showSection(name) {
  sectionLibrary.style.display = 'none';
  sectionRequest.style.display = 'none';
  sectionAdminAdd.style.display = 'none';
  navLibrary.classList.remove('active');
  navAdd.classList.remove('active');
  if (name === 'library') {
    sectionLibrary.style.display = 'block';
    navLibrary.classList.add('active');
  } else if (name === 'request') {
    sectionRequest.style.display = 'block';
    navAdd.classList.add('active');
  } else if (name === 'admin') {
    sectionAdminAdd.style.display = 'block';
    navAdminPanel.classList.add('active');
  }
}

/* =======================
   IP kontrolÃ¼ (her sayfa yÃ¼klenmesinde ve sekme odaklandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r)
   ======================= */
async function checkAndApplyIP() {
  try {
    const res = await fetch('https://api64.ipify.org?format=json', {cache: "no-store"});
    const json = await res.json();
    currentIp = json.ip;
    ipBadge.innerText = `IP: ${currentIp}`;
    // admin mi?
    if (currentIp === ADMIN_IP) {
      isAdmin = true;
      adminLinks.style.display = 'block';
      // otomatik olarak admin panelini aÃ§
      showSection('admin');
      // yÃ¼klemelerini yap
      loadRequests();
    } else {
      isAdmin = false;
      adminLinks.style.display = 'none';
      // normal kullanÄ±cÄ±: kitaplÄ±ÄŸÄ± gÃ¶ster
      showSection('library');
    }
  } catch (err) {
    console.error('IP alma hatasÄ±:', err);
    ipBadge.innerText = 'IP: alÄ±namadÄ±';
    isAdmin = false;
    adminLinks.style.display = 'none';
    showSection('library');
  }
}

/* =======================
   ÅžarkÄ±larÄ± yÃ¼kle (Songs tablosu)
   ======================= */
async function loadSongs() {
  songsList.innerHTML = '<p class="small">YÃ¼kleniyor...</p>';
  try {
    const { data, error } = await supabaseClient.from('Songs').select('id, name, artist, url').order('id', { ascending: false });
    if (error) {
      console.error('loadSongs error', error);
      songsList.innerHTML = `<div class="small">ÅžarkÄ±lar yÃ¼klenemedi: ${error.message}</div>`;
      return;
    }
    if (!data || data.length === 0) {
      songsList.innerHTML = `<div class="small">HenÃ¼z kitaplÄ±kta ÅŸarkÄ± yok.</div>`;
      return;
    }
    songsList.innerHTML = '';
    data.forEach(s => {
      const card = document.createElement('div');
      card.className = 'song-card';
      card.innerHTML = `<strong>${escapeHtml(s.name)}</strong> â€” <span class="small">${escapeHtml(s.artist)}</span>
        <audio controls src="${escapeHtml(s.url)}"></audio>`;
      songsList.appendChild(card);
    });
  } catch (e) {
    console.error(e);
    songsList.innerHTML = `<div class="small">Beklenmeyen hata oluÅŸtu.</div>`;
  }
}

/* =======================
   Ä°stek tabloyu yÃ¼kle (admin)
   ======================= */
async function loadRequests() {
  requestsList.innerHTML = '<p class="small">Bekleyen istekler yÃ¼kleniyor...</p>';
  try {
    const { data, error } = await supabaseClient.from('SongRequests').select('*').order('created_at', { ascending: false });
    if (error) {
      console.error('loadRequests error', error);
      requestsList.innerHTML = `<div class="small">Ä°stekler yÃ¼klenemedi: ${error.message}</div>`;
      return;
    }
    if (!data || data.length === 0) {
      requestsList.innerHTML = `<div class="small">Bekleyen istek yok.</div>`;
      return;
    }
    requestsList.innerHTML = '';
    data.forEach(r => {
      const el = document.createElement('div');
      el.className = 'req-card';
      el.innerHTML = `<strong>${escapeHtml(r.name)}</strong> â€” ${escapeHtml(r.artist)}<br>
        <div class="small">Dosya: <a target="_blank" href="${escapeHtml(r.file_url)}">${escapeHtml(r.file_url)}</a></div>
        <div class="small">IP: ${escapeHtml(r.user_ip || 'Bilinmiyor')} â€¢ Tarih: ${escapeHtml(r.created_at)}</div>
        <div style="margin-top:8px">
          <button onclick="adminImportRequest(${r.id})">Ä°steÄŸi Ä°ndir / Catbox'a YÃ¼kle</button>
          <button style="background:#666;margin-left:8px" onclick="deleteRequest(${r.id})">Sil</button>
        </div>`;
      requestsList.appendChild(el);
    });
  } catch (err) {
    console.error(err);
    requestsList.innerHTML = `<div class="small">Beklenmeyen hata oluÅŸtu.</div>`;
  }
}

/* =======================
   Admin: isteÄŸi indir / iÅŸleme (placeholder)
   - Burada otomatik indirme yok, admin manuel iÅŸleme yapacak.
   ======================= */
async function adminImportRequest(requestId) {
  // Basit: istek detayÄ±nÄ± al ve adminin manuel iÅŸlemesi iÃ§in bir uyarÄ± gÃ¶ster
  const { data, error } = await supabaseClient.from('SongRequests').select('*').eq('id', requestId).single();
  if (error || !data) {
    alert('Ä°stek alÄ±namadÄ±: ' + (error?.message || 'BulunamadÄ±'));
    return;
  }
  // adminin catbox'a yÃ¼kleyip elde edeceÄŸi linki kullanarak Songs tablosuna elle eklemesini Ã¶ner
  const msg = `Ä°stek bulundu:\nÅžarkÄ±: ${data.name}\nSanatÃ§Ä±: ${data.artist}\nDosya: ${data.file_url}\n\nLÃ¼tfen dosyayÄ± indirip catbox.moe'ya yÃ¼kleyin, elde ettiÄŸiniz direct link ile "KitaplÄ±ÄŸa Ekle" bÃ¶lÃ¼mÃ¼nden ekleyin.`;
  alert(msg);
}

/* =======================
   Admin: istek sil
   ======================= */
async function deleteRequest(id) {
  if (!confirm('Bu isteÄŸi silmek istiyor musun?')) return;
  const { error } = await supabaseClient.from('SongRequests').delete().eq('id', id);
  if (error) {
    alert('Silme hatasÄ±: ' + error.message);
  } else {
    loadRequests();
  }
}

/* =======================
   Admin: Songs tablosuna ekle
   ======================= */
adminAddBtn.addEventListener('click', async () => {
  adminAddMsg.innerText = '';
  const name = (adminName.value || '').trim();
  const artist = (adminArtist.value || '').trim();
  const url = (adminUrl.value || '').trim();
  if (!name || !artist || !url) { adminAddMsg.innerText = 'LÃ¼tfen tÃ¼m alanlarÄ± doldur.'; return; }
  adminAddBtn.disabled = true;
  adminAddMsg.innerText = 'GÃ¶nderiliyor...';
  try {
    const { data, error } = await supabaseClient.from('Songs').insert([{ name, artist, url }]);
    if (error) {
      adminAddMsg.innerText = 'Hata: ' + error.message;
    } else {
      adminAddMsg.innerText = 'BaÅŸarÄ±yla eklendi!';
      adminName.value = adminArtist.value = adminUrl.value = '';
      await loadSongs();
    }
  } catch (e) {
    adminAddMsg.innerText = 'Beklenmeyen hata: ' + e.message;
  } finally {
    adminAddBtn.disabled = false;
  }
});

/* =======================
   Normal kullanÄ±cÄ±: istek gÃ¶nder
   ======================= */
sendReqBtn.addEventListener('click', async () => {
  reqMsg.innerText = '';
  const name = (reqName.value || '').trim();
  const artist = (reqArtist.value || '').trim();
  const file_url = (reqFile.value || '').trim();
  if (!name || !artist) { reqMsg.innerText = 'ÅžarkÄ± adÄ± ve sanatÃ§Ä± girin.'; return; }
  sendReqBtn.disabled = true;
  reqMsg.innerText = 'GÃ¶nderiliyor...';
  try {
    const { data, error } = await supabaseClient.from('SongRequests').insert([{ name, artist, file_url, user_ip: currentIp }]);
    if (error) {
      reqMsg.innerText = 'Hata: ' + error.message;
    } else {
      reqMsg.innerText = 'Ä°stek gÃ¶nderildi. TeÅŸekkÃ¼rler!';
      reqName.value = reqArtist.value = reqFile.value = '';
    }
  } catch (e) {
    reqMsg.innerText = 'Beklenmeyen hata: ' + e.message;
  } finally {
    sendReqBtn.disabled = false;
  }
});

/* =======================
   Eventler: navigasyon
   ======================= */
navLibrary.addEventListener('click', () => showSection('library'));
navAdd.addEventListener('click', () => {
  // adminse admin paneldeki ekleme, normalse istek formu
  if (isAdmin) showSection('admin');
  else showSection('request');
});
navAdminPanel.addEventListener('click', () => {
  if (isAdmin) showSection('admin');
});

/* =======================
   Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacaklar
   ======================= */
document.addEventListener('DOMContentLoaded', async () => {
  await checkAndApplyIP();
  await loadSongs();
  // periyodik olarak liste yenile (10s)
  setInterval(loadSongs, 10000);
});

// sekme geri geldiÄŸinde IP tekrar kontrol (bazÄ± mobil tarayÄ±cÄ±larda sayfa yeniden yÃ¼klenmeyebilir)
window.addEventListener('focus', () => {
  checkAndApplyIP();
});

/* =======================
   GÃ¼venlik / yardÄ±mcÄ±lar
   ======================= */
function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[c]);
}
</script>

</body>
</html>

bak dedigim gibi senin veridgn olmadi burdaki verdigim hatasiz eski hali sadece yeni ozellikleri ekle gorunumu guzellestir baska degisme
