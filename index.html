<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kişisel Müzik Kütüphanesi</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family:'Segoe UI',sans-serif; background:#667eea; color:#fff; padding:24px; padding-bottom:160px; }
    .app { max-width:1200px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:18px 24px; border-radius:12px; margin-bottom:20px; }
    .sidebar { background:rgba(255,255,255,0.1); padding:12px; border-radius:12px; display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    .sidebar button { padding:10px; border:0; border-radius:8px; background:transparent; color:#fff; cursor:pointer; text-align:left; }
    .sidebar button.active { background:#f72585; }
    .card { background:rgba(0,0,0,0.2); border-radius:12px; padding:18px; margin-top:10px; }
    .controls { display:flex; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    input,textarea,select { padding:8px; border-radius:6px; border:0; width:100%; margin-bottom:8px; }
    .btn { padding:6px 12px; border-radius:8px; border:0; cursor:pointer; margin-left:4px; }
    .btn.danger { background:#e63946; color:#fff; }
    .btn.play { background:#4361ee; color:#fff; }
    .btn.edit { background:#f8961e; color:#fff; }
    .song { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.2); }
    #player-bar { position:fixed; left:0; right:0; bottom:0; background:#000; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; }
    #now-playing-lyrics, #user-now-playing-lyrics { white-space:pre-wrap; margin-top:10px; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; }
    .edit-form { display:none; margin-top:10px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center; }
    .modal-content { background:#2d3748; padding:20px; border-radius:12px; width:80%; max-width:500px; }
    .delete-all-btn { background:#e63946; color:white; padding:10px; border-radius:8px; border:none; cursor:pointer; margin-top:10px; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>🎵 Müzik Kütüphanesi</div>
    <div><span id="user-type"></span></div>
  </header>

  <!-- Admin Panel -->
  <div id="admin-panel" style="display:none;">
    <h2>Admin Paneli</h2>
    <div class="sidebar">
      <button id="btn-library" class="active">Kitaplık</button>
      <button id="btn-add-song">Şarkı Ekle</button>
      <button id="btn-now-playing">Şu An Çalan</button>
    </div>

    <div id="library-section" class="card">
      <div class="controls">
        <input type="text" id="admin-search" placeholder="Ara...">
        <select id="admin-sort">
          <option value="id">En Yeni</option>
          <option value="name">Ada Göre</option>
          <option value="artist">Sanatçıya Göre</option>
        </select>
      </div>
      <button id="delete-all-btn" class="delete-all-btn">Tüm Şarkıları Sil</button>
      <ul id="songs-list"></ul>
    </div>

    <div id="add-song-section" class="card" style="display:none;">
      <input id="song-name" placeholder="Şarkı adı">
      <input id="song-artist" placeholder="Sanatçı">
      <input id="song-url" placeholder="URL">
      <textarea id="song-lyrics" placeholder="Şarkı sözleri (opsiyonel)"></textarea>
      <button id="addSongBtn" class="btn">Ekle</button>
      <div id="admin-msg"></div>
    </div>

    <div id="now-playing-section" class="card" style="display:none;">
      <h3>Şu An Çalan</h3>
      <div id="now-playing-info">Henüz şarkı seçilmedi</div>
      <div style="margin-top:10px;">
        <button id="prevBtn" class="btn">⏮ Önceki</button>
        <button id="toggleBtn" class="btn">⏯ Başlat/Durdur</button>
        <button id="nextBtn" class="btn">⏭ Sonraki</button>
      </div>
      <div id="now-playing-lyrics">Henüz şarkı seçilmedi</div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel" style="display:none;">
    <h2>Kullanıcı Paneli</h2>
    <div class="sidebar">
      <button id="user-btn-library" class="active">Kitaplık</button>
      <button id="user-btn-now-playing">Şu An Çalan</button>
    </div>

    <div id="user-library-section" class="card">
      <div class="controls">
        <input type="text" id="user-search" placeholder="Ara...">
        <select id="user-sort">
          <option value="id">En Yeni</option>
          <option value="name">Ada Göre</option>
          <option value="artist">Sanatçıya Göre</option>
        </select>
      </div>
      <ul id="user-songs-list"></ul>
    </div>

    <div id="user-now-playing-section" class="card" style="display:none;">
      <h3>Şu An Çalan</h3>
      <div id="user-now-playing-info">Henüz şarkı seçilmedi</div>
      <div style="margin-top:10px;">
        <button id="uPrevBtn" class="btn">⏮ Önceki</button>
        <button id="uToggleBtn" class="btn">⏯ Başlat/Durdur</button>
        <button id="uNextBtn" class="btn">⏭ Sonraki</button>
      </div>
      <div id="user-now-playing-lyrics">Henüz şarkı seçilmedi</div>
    </div>
  </div>
</div>

<!-- Player -->
<div id="player-bar">
  <div id="player-info">Henüz şarkı seçilmedi</div>
  <audio id="main-player" controls></audio>
</div>

<!-- Düzenleme Modalı -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>Şarkı Düzenle</h3>
    <input id="edit-song-name" placeholder="Şarkı adı">
    <input id="edit-song-artist" placeholder="Sanatçı">
    <input id="edit-song-url" placeholder="URL">
    <textarea id="edit-song-lyrics" placeholder="Şarkı sözleri"></textarea>
    <div style="margin-top:10px;">
      <button id="saveEditBtn" class="btn">Kaydet</button>
      <button id="cancelEditBtn" class="btn danger">İptal</button>
    </div>
  </div>
</div>

<!-- Tümünü Sil Onay Modalı -->
<div id="deleteAllModal" class="modal">
  <div class="modal-content">
    <h3>Tüm Şarkıları Sil</h3>
    <p>Bu işlem tüm şarkıları kalıcı olarak silecektir. Emin misiniz?</p>
    <div style="margin-top:10px;">
      <button id="confirmDeleteAllBtn" class="btn danger">Evet, Tümünü Sil</button>
      <button id="cancelDeleteAllBtn" class="btn">İptal</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://zzlrltqrzxjwmtpuvhsi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g");
const ADMIN_IP="151.250.4.2";
let allSongs=[]; let currentIndex=-1;
const songsList=document.getElementById("songs-list");
const userSongsList=document.getElementById("user-songs-list");
const mainPlayer=document.getElementById("main-player");
const playerInfo=document.getElementById("player-info");
let sortField="id"; let searchTerm="";
let currentEditId = null;

// IP kontrol
(async()=>{
  try {
    const response = await fetch("https://api64.ipify.org?format=json");
    const data = await response.json();
    const ip = data.ip;
    
    if(ip===ADMIN_IP){
      document.getElementById("admin-panel").style.display="block"; 
      document.getElementById("user-type").textContent="Admin"; 
      setupAdminButtons();
    } else {
      document.getElementById("user-panel").style.display="block"; 
      document.getElementById("user-type").textContent="Kullanıcı"; 
      setupUserButtons();
    }
    await loadSongs();
  } catch (error) {
    console.error("IP alma hatası:", error);
    // Admin panelini varsayılan olarak göster (geliştirme için)
    document.getElementById("admin-panel").style.display="block"; 
    document.getElementById("user-type").textContent="Admin"; 
    setupAdminButtons();
    await loadSongs();
  }
})();

// Şarkı listeleme
async function loadSongs(){
  try {
    const {data,error}=await supabase.from("Songs").select("*").order(sortField,{ascending: sortField === "id" ? false : true});
    if(error){console.error("Şarkı yükleme hatası:",error);return;}
    allSongs=data || [];
    const filter=d=>d.name.toLowerCase().includes(searchTerm)||d.artist.toLowerCase().includes(searchTerm);
    renderList(songsList,allSongs.filter(filter),true);
    renderList(userSongsList,allSongs.filter(filter),false);
  } catch (err) {
    console.error("Şarkı yükleme hatası:", err);
  }
}

function renderList(list,data,isAdmin){
  list.innerHTML="";
  if (data.length === 0) {
    list.innerHTML = "<li>Henüz şarkı eklenmemiş</li>";
    return;
  }
  
  data.forEach((s,i)=>{
    const li=document.createElement("li"); 
    li.className="song"; 
    li.dataset.id=s.id;
    
    li.innerHTML=`<div><strong>${s.name}</strong> - ${s.artist}</div>
      <div>
        <button class="btn play" data-index="${i}">Çal</button>
        ${isAdmin ? `
          <button class="btn edit" data-id="${s.id}">Düzenle</button>
          <button class="btn danger delete-song" data-id="${s.id}">Sil</button>
        ` : ""}
      </div>`;
    
    list.appendChild(li);
  });
  
  list.querySelectorAll(".play").forEach(b=>b.addEventListener('click', ()=>playSong(parseInt(b.dataset.index))));
  
  if(isAdmin){
    list.querySelectorAll(".delete-song").forEach(b=>b.addEventListener('click', ()=>deleteSong(b.dataset.id)));
    list.querySelectorAll(".edit").forEach(b=>b.addEventListener('click', ()=>openEditModal(b.dataset.id)));
  }
}

// Modal işlevleri
function openEditModal(id) {
  const song = allSongs.find(s => s.id == id);
  if (!song) return;
  
  currentEditId = id;
  document.getElementById("edit-song-name").value = song.name;
  document.getElementById("edit-song-artist").value = song.artist;
  document.getElementById("edit-song-url").value = song.url;
  document.getElementById("edit-song-lyrics").value = song.lyrics || "";
  
  document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
  currentEditId = null;
}

// Şarkı düzenlemeyi kaydet
async function saveSongEdit() {
  if (!currentEditId) return;
  
  const name = document.getElementById("edit-song-name").value.trim();
  const artist = document.getElementById("edit-song-artist").value.trim();
  const url = document.getElementById("edit-song-url").value.trim();
  const lyrics = document.getElementById("edit-song-lyrics").value.trim();

  if (!name || !artist || !url) {
    alert("Lütfen tüm zorunlu alanları doldurun.");
    return;
  }

  try {
    const { error } = await supabase
      .from("Songs")
      .update({ name, artist, url, lyrics, updated_at: new Date() })
      .eq("id", currentEditId);

    if (error) {
      alert("Güncelleme hatası: " + error.message);
      console.error("Güncelleme hatası:", error);
    } else {
      alert("✅ Şarkı başarıyla güncellendi");
      closeEditModal();
      await loadSongs(); // Listeyi yeniden yükle
    }
  } catch (err) {
    alert("Bir hata oluştu: " + err.message);
    console.error("Güncelleme hatası:", err);
  }
}

// Çalma
function playSong(i){
  if (i < 0 || i >= allSongs.length) return;
  
  currentIndex=i;
  const s=allSongs[i]; 
  if(!s) return;
  
  mainPlayer.src=s.url; 
  mainPlayer.play().catch(e => console.error("Çalma hatası:", e));
  
  playerInfo.textContent=`${s.name} - ${s.artist}`;
  document.getElementById("now-playing-info").textContent=`${s.name} - ${s.artist}`;
  document.getElementById("user-now-playing-info").textContent=`${s.name} - ${s.artist}`;

  // Şarkı sözleri
  const lyricsText = s.lyrics && s.lyrics.trim() ? s.lyrics : "Bu şarkıya söz eklenmemiş.";
  document.getElementById("now-playing-lyrics").textContent=lyricsText;
  document.getElementById("user-now-playing-lyrics").textContent=lyricsText;
}

// Önceki/sonraki
function prevSong(){ 
  if(allSongs.length === 0) return;
  if(currentIndex <= 0) playSong(allSongs.length - 1);
  else playSong(currentIndex - 1); 
}

function nextSong(){ 
  if(allSongs.length === 0) return;
  if(currentIndex >= allSongs.length - 1) playSong(0);
  else playSong(currentIndex + 1); 
}

function togglePlay(){ 
  if(mainPlayer.paused) mainPlayer.play();
  else mainPlayer.pause(); 
}

// Şarkı silme - GELİŞTİRİLMİŞ VERSİYON
async function deleteSong(id){
  if(!confirm("Bu şarkıyı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) return;

  try {
    console.log("Silinecek şarkı ID:", id);
    
    const { error } = await supabase
      .from("Songs")
      .delete()
      .eq("id", id);

    if(error){ 
      alert("Silme hatası: " + error.message);
      console.error("Silme hatası:", error);
      return;
    }
    
    // Şarkıyı yerel listeden de kaldır
    allSongs = allSongs.filter(song => song.id !== id);
    
    // Listeleri yeniden yükle
    await loadSongs();
    alert("✅ Şarkı tamamen silindi");
    
    // Eğer silinen şarkı çalınıyorsa, çalmayı durdur
    if (currentIndex !== -1 && allSongs[currentIndex] && allSongs[currentIndex].id === id) {
      mainPlayer.pause();
      mainPlayer.src = "";
      playerInfo.textContent = "Henüz şarkı seçilmedi";
      document.getElementById("now-playing-info").textContent = "Henüz şarkı seçilmedi";
      document.getElementById("user-now-playing-info").textContent = "Henüz şarkı seçilmedi";
      document.getElementById("now-playing-lyrics").textContent = "Henüz şarkı seçilmedi";
      document.getElementById("user-now-playing-lyrics").textContent = "Henüz şarkı seçilmedi";
      currentIndex = -1;
    }
  } catch (err) {
    alert("Bir hata oluştu: " + err.message);
    console.error("Silme hatası:", err);
  }
}

// Tüm şarkıları silme fonksiyonu
async function deleteAllSongs() {
  try {
    // Tüm şarkıları veritabanından sil
    const { error } = await supabase
      .from("Songs")
      .delete()
      .neq('id', 0); // Tüm kayıtları sil

    if (error) {
      alert("Tüm şarkıları silme hatası: " + error.message);
      console.error("Tüm şarkıları silme hatası:", error);
      return;
    }
    
    // Yerel listeyi temizle
    allSongs = [];
    
    // Listeleri yeniden yükle
    await loadSongs();
    
    // Çalmayı durdur
    mainPlayer.pause();
    mainPlayer.src = "";
    playerInfo.textContent = "Henüz şarkı seçilmedi";
    document.getElementById("now-playing-info").textContent = "Henüz şarkı seçilmedi";
    document.getElementById("user-now-playing-info").textContent = "Henüz şarkı seçilmedi";
    document.getElementById("now-playing-lyrics").textContent = "Henüz şarkı seçilmedi";
    document.getElementById("user-now-playing-lyrics").textContent = "Henüz şarkı seçilmedi";
    currentIndex = -1;
    
    alert("✅ Tüm şarkılar başarıyla silindi");
  } catch (err) {
    alert("Tüm şarkıları silerken bir hata oluştu: " + err.message);
    console.error("Tüm şarkıları silme hatası:", err);
  }
}

// Şarkı ekleme
async function addSong(){
  const name=document.getElementById("song-name").value.trim();
  const artist=document.getElementById("song-artist").value.trim();
  const url=document.getElementById("song-url").value.trim();
  const lyrics=document.getElementById("song-lyrics").value.trim();
  const msg=document.getElementById("admin-msg");
  
  if(!name || !artist || !url) {
    msg.textContent="Lütfen tüm zorunlu alanları doldurun.";
    return;
  }
  
  try {
    const {error} = await supabase.from("Songs").insert([{name,artist,url,lyrics}]);
    if(error){ 
      msg.textContent="Hata: "+error.message;
      console.error("Ekleme hatası:", error);
    } else { 
      msg.textContent="✅ Eklendi"; 
      // Formu temizle
      document.getElementById("song-name").value = "";
      document.getElementById("song-artist").value = "";
      document.getElementById("song-url").value = "";
      document.getElementById("song-lyrics").value = "";
      // Listeyi yenile
      await loadSongs(); 
    }
  } catch (err) {
    msg.textContent = "Bir hata oluştu: " + err.message;
    console.error("Ekleme hatası:", err);
  }
}

// Admin menü
function setupAdminButtons(){
  const sections=["library-section","add-song-section","now-playing-section"];
  const buttons = ["btn-library","btn-add-song","btn-now-playing"];
  
  buttons.forEach((id,i)=>{
    document.getElementById(id).addEventListener('click', ()=>{
      sections.forEach((s,j)=>{
        document.getElementById(s).style.display = (i === j) ? "block" : "none";
      });
      document.querySelectorAll("#admin-panel .sidebar button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    });
  });
  
  document.getElementById("addSongBtn").addEventListener('click', addSong);
  document.getElementById("prevBtn").addEventListener('click', prevSong);
  document.getElementById("nextBtn").addEventListener('click', nextSong);
  document.getElementById("toggleBtn").addEventListener('click', togglePlay);
  
  // Modal olayları
  document.getElementById("saveEditBtn").addEventListener('click', saveSongEdit);
  document.getElementById("cancelEditBtn").addEventListener('click', closeEditModal);
  
  // Tümünü sil butonu
  document.getElementById("delete-all-btn").addEventListener('click', () => {
    document.getElementById("deleteAllModal").style.display = "flex";
  });
  
  document.getElementById("confirmDeleteAllBtn").addEventListener('click', async () => {
    document.getElementById("deleteAllModal").style.display = "none";
    await deleteAllSongs();
  });
  
  document.getElementById("cancelDeleteAllBtn").addEventListener('click', () => {
    document.getElementById("deleteAllModal").style.display = "none";
  });
}

// User menü
function setupUserButtons(){
  const sections=["user-library-section","user-now-playing-section"];
  const buttons = ["user-btn-library","user-btn-now-playing"];
  
  buttons.forEach((id,i)=>{
    document.getElementById(id).addEventListener('click', ()=>{
      sections.forEach((s,j)=>{
        document.getElementById(s).style.display = (i === j) ? "block" : "none";
      });
      document.querySelectorAll("#user-panel .sidebar button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    });
  });
  
  document.getElementById("uPrevBtn").addEventListener('click', prevSong);
  document.getElementById("uNextBtn").addEventListener('click', nextSong);
  document.getElementById("uToggleBtn").addEventListener('click', togglePlay);
}

// Arama & sıralama
document.getElementById("admin-search").addEventListener('input', e => {
  searchTerm = e.target.value.toLowerCase();
  loadSongs();
});

document.getElementById("user-search").addEventListener('input', e => {
  searchTerm = e.target.value.toLowerCase();
  loadSongs();
});

document.getElementById("admin-sort").addEventListener('change', e => {
  sortField = e.target.value;
  loadSongs();
});

document.getElementById("user-sort").addEventListener('change', e => {
  sortField = e.target.value;
  loadSongs();
});

// Modal dışına tıklanınca kapat
window.addEventListener('click', (e) => {
  const editModal = document.getElementById("editModal");
  const deleteModal = document.getElementById("deleteAllModal");
  
  if (e.target === editModal) {
    closeEditModal();
  }
  if (e.target === deleteModal) {
    deleteModal.style.display = "none";
  }
});
</script>
</body>
</html>
