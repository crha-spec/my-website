<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InstaChat Single HTML</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#6e8efb,#a777e3);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.container{width:100%;max-width:500px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;display:flex;flex-direction:column}
.header{background:linear-gradient(90deg,#4b6cb7,#182848);color:white;padding:20px;text-align:center}
.chat-container{padding:20px;height:300px;overflow-y:auto;display:flex;flex-direction:column;flex:1;border-bottom:1px solid #eee}
.message{padding:12px 16px;border-radius:20px;margin-bottom:15px;max-width:80%;word-break:break-word}
.user-message{background:#e3f2fd;align-self:flex-end;border-bottom-right-radius:5px}
.bot-message{background:#f1f0f0;align-self:flex-start;border-bottom-left-radius:5px}
.input-area{display:flex;padding:15px;background:#f9f9f9}
#message-input{flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:25px;outline:none;font-size:16px}
#send-button{background:linear-gradient(90deg,#4b6cb7,#182848);color:white;border:none;border-radius:25px;padding:12px 20px;margin-left:10px;cursor:pointer;transition:all 0.3s ease}
#send-button:hover{background:linear-gradient(90deg,#182848,#4b6cb7);transform:scale(1.05)}
.user-list{padding:10px;border-top:1px solid #eee;background:#f5f5f5;display:flex;flex-wrap:wrap}
.user-item{margin:5px;padding:5px 10px;border-radius:15px;background:#eee;cursor:pointer;position:relative}
.user-item .online-dot{width:10px;height:10px;border-radius:50%;position:absolute;top:5px;right:5px}
.user-item .online-dot.green{background:green}
.user-item .online-dot.grey{background:grey}
.api-status{text-align:center;padding:10px;font-size:14px;color:#666;background-color:#f5f5f5;border-top:1px solid #eee}
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<!-- Agora RTM -->
<script src="https://download.agora.io/sdk/release/AgoraRTM_N.js"></script>
</head>
<body>
<div class="container">
<div class="header">
<h1>InstaChat Single HTML</h1>
<p>Online kullanıcı: <span id="online-count">0</span></p>
</div>
<div class="user-list" id="user-list"></div>
<div class="chat-container" id="chat-container"></div>
<div class="input-area">
<input type="text" id="message-input" placeholder="Mesajınızı yazın...">
<button id="send-button">Gönder</button>
</div>
<div class="api-status" id="api-status">Durum: Hazır</div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAx6kLcjHyoFKCdnRF0YkPrNXml-kxMMgE",
  authDomain: "instachatclone-a37f8.firebaseapp.com",
  projectId: "instachatclone-a37f8",
  storageBucket: "instachatclone-a37f8.firebasestorage.app",
  messagingSenderId: "1014809554871",
  appId: "1:1014809554871:web:e28e92945506a846950232"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Kullanıcı bilgisi
let uid, username, userIP;
const chatContainer = document.getElementById('chat-container');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const userListEl = document.getElementById('user-list');
const onlineCountEl = document.getElementById('online-count');
let currentChatUser = null;

// IP alma
async function getUserIP(){
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    return data.ip;
}

// Kullanıcıyı başlat
async function initUser(){
    userIP = await getUserIP();
    const snapshot = await db.collection("users").where("ip","==",userIP).get();
    if(snapshot.empty){
        // Yeni kullanıcı
        username = prompt("Nickname giriniz:");
        uid = "user_" + Math.floor(Math.random()*10000);
        db.collection("users").doc(uid).set({name:username,online:true,lastSeen:new Date(),ip:userIP});
    }else{
        const doc = snapshot.docs[0];
        uid = doc.id;
        username = doc.data().name;
        db.collection("users").doc(uid).update({online:true,lastSeen:new Date()});
    }

    window.addEventListener("beforeunload",()=>{db.collection("users").doc(uid).update({online:false,lastSeen:new Date()})});
    initAgora();
    loadUsers();
}

// Agora RTM
const APP_ID = "3962323028604aeaa62ef04c08298341";
let client;
function initAgora(){
    client = AgoraRTM.createInstance(APP_ID);
    client.login({uid, token:null}).then(()=>{
        document.getElementById('api-status').textContent = "Agora RTM bağlandı";
    });
}

// Kullanıcı listesi ve online sayısı
function loadUsers(){
    db.collection("users").onSnapshot(snapshot=>{
        userListEl.innerHTML='';
        let onlineCount = 0;
        snapshot.forEach(doc=>{
            const u = doc.data();
            if(u.ip !== userIP){
                const div = document.createElement('div');
                div.className='user-item';
                div.textContent=u.name;
                const dot = document.createElement('div');
                dot.className='online-dot ' + (u.online ? 'green':'grey');
                div.appendChild(dot);
                div.onclick=()=>selectChat(doc.id,u.name);
                userListEl.appendChild(div);
            }
            if(u.online) onlineCount++;
        });
        // Kendini dahil et
        const currentUserDoc = snapshot.docs.find(d=>d.id===uid);
        if(currentUserDoc && currentUserDoc.data().online) onlineCount++;
        onlineCountEl.textContent = onlineCount;
    });
}

// Chat seçimi
function selectChat(userId,userName){
    currentChatUser = userId;
    chatContainer.innerHTML='';
    db.collection("messages")
      .where("participants","array-contains",uid)
      .orderBy("timestamp")
      .onSnapshot(snapshot=>{
          chatContainer.innerHTML='';
          snapshot.forEach(doc=>{
              const m = doc.data();
              if(m.participants.includes(currentChatUser)){
                  addMessage(m.text,m.sender===uid?'user':'bot');
              }
          });
      });
}

// Mesaj gönder
async function sendMessage(){
    if(!messageInput.value.trim() || !currentChatUser) return;
    const text = messageInput.value.trim();
    await db.collection("messages").add({
        text,
        sender: uid,
        participants: [uid,currentChatUser],
        timestamp: new Date()
    });
    addMessage(text,'user');
    messageInput.value='';
}

function addMessage(text,sender){
    const div=document.createElement('div');
    div.className='message '+sender+'-message';
    div.textContent=text;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

sendButton.addEventListener('click',sendMessage);
messageInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});

initUser();
</script>
</body>
</html>
