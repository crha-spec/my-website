<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Müzik Platformu - Sanatçılar İçin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4a6bff;
      --secondary: #ff6b6b;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --gray: #6c757d;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --card-shadow: 0 10px 20px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: var(--dark);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 0 0 12px 12px;
      margin-bottom: 2rem;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .logo i {
      color: var(--primary);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.1);
      padding: 8px 15px;
      border-radius: 20px;
    }
    
    h1, h2, h3, h4 {
      margin-bottom: 1rem;
      color: var(--dark);
    }
    
    h2 {
      border-left: 4px solid var(--primary);
      padding-left: 12px;
    }
    
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
    }
    
    .panel {
      display: none;
    }
    
    .active-panel {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .grid-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 24px;
    }
    
    .sidebar {
      background: white;
      border-radius: 12px;
      padding: 20px 0;
      box-shadow: var(--card-shadow);
      height: fit-content;
    }
    
    .sidebar button {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 14px 20px;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      transition: var(--transition);
      color: var(--gray);
      font-weight: 500;
    }
    
    .sidebar button:hover {
      background: rgba(74, 107, 255, 0.08);
      color: var(--primary);
    }
    
    .sidebar button.active {
      background: rgba(74, 107, 255, 0.12);
      color: var(--primary);
      border-left: 4px solid var(--primary);
    }
    
    .main-content {
      min-height: 600px;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      transition: var(--transition);
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .btn:hover {
      background: #3a5be0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 107, 255, 0.3);
    }
    
    .btn-secondary {
      background: var(--secondary);
    }
    
    .btn-secondary:hover {
      background: #e55a5a;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: #bd2130;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    
    .songs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .song-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
    }
    
    .song-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .song-image {
      height: 180px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    .song-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      padding: 15px;
      color: white;
    }
    
    .song-info {
      padding: 20px;
    }
    
    .song-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .song-artist {
      color: var(--gray);
      margin-bottom: 15px;
    }
    
    .song-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .lyrics-container {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .lyrics-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--dark);
    }
    
    .requests-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .request-item {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .request-info {
      flex: 1;
    }
    
    .request-actions {
      display: flex;
      gap: 10px;
    }
    
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(74, 107, 255, 0.05);
    }
    
    .upload-icon {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 15px;
    }
    
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 16px 0;
      font-weight: 500;
    }
    
    .status-error {
      background: #ffebee;
      color: var(--danger);
    }
    
    .status-success {
      background: #e8f5e9;
      color: var(--success);
    }
    
    .status-info {
      background: #e3f2fd;
      color: var(--primary);
    }
    
    .player-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      padding: 15px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .now-playing {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }
    
    .now-playing-img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
    }
    
    .now-playing-info {
      flex: 1;
    }
    
    .now-playing-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .now-playing-artist {
      color: var(--gray);
      font-size: 0.9rem;
    }
    
    .player-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 2;
    }
    
    .progress-container {
      flex: 1;
      background: #eee;
      height: 5px;
      border-radius: 5px;
      cursor: pointer;
      position: relative;
    }
    
    .progress-bar {
      background: var(--primary);
      height: 100%;
      border-radius: 5px;
      width: 0%;
    }
    
    .volume-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 150px;
    }
    
    .volume-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 5px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
    }
    
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }
    
    .control-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--dark);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .control-btn:hover {
      color: var(--primary);
    }
    
    .hidden {
      display: none;
    }
    
    footer {
      text-align: center;
      padding: 30px 0;
      color: var(--gray);
      margin-top: 50px;
    }
    
    @media (max-width: 992px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: flex;
        overflow-x: auto;
        padding: 10px;
        gap: 5px;
      }
      
      .sidebar button {
        padding: 10px 15px;
        white-space: nowrap;
        border-left: none;
        border-bottom: 3px solid transparent;
        justify-content: center;
      }
      
      .sidebar button.active {
        border-left: none;
        border-bottom: 3px solid var(--primary);
      }
      
      .songs-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 768px) {
      .request-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .request-actions {
        align-self: flex-end;
      }
      
      .player-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .now-playing {
        width: 100%;
      }
      
      .player-controls {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-music"></i>
      <span>Müzik Platformu</span>
    </div>
    <div class="user-info">
      <i class="fas fa-user"></i>
      <span id="user-type">Kullanıcı</span>
    </div>
  </header>

  <div class="container">
    <!-- Admin Panel -->
    <div id="admin-panel" class="panel">
      <h2>Yönetici Paneli</h2>
      <div class="grid-container">
        <div class="sidebar">
          <button id="btn-library" class="active">
            <i class="fas fa-compact-disc"></i>
            <span>Müzik Kütüphanesi</span>
          </button>
          <button id="btn-add-song">
            <i class="fas fa-plus-circle"></i>
            <span>Şarkı Ekle</span>
          </button>
          <button id="btn-song-requests">
            <i class="fas fa-envelope"></i>
            <span>Şarkı İstekleri</span>
          </button>
          <button id="btn-statistics">
            <i class="fas fa-chart-bar"></i>
            <span>İstatistikler</span>
          </button>
        </div>
        
        <div class="main-content">
          <!-- Kitaplık Bölümü -->
          <div id="library-section" class="active-panel">
            <div class="card">
              <h3>Tüm Şarkılar</h3>
              <div class="songs-grid" id="songs-list">
                <!-- Şarkılar buraya dinamik olarak eklenecek -->
              </div>
            </div>
          </div>
          
          <!-- Şarkı Ekleme Bölümü -->
          <div id="add-song-section" class="panel">
            <div class="card">
              <h3>Yeni Şarkı Ekle</h3>
              <div class="form-group">
                <label>Şarkı Adı</label>
                <input id="song-name" placeholder="Örnek: Faded" />
              </div>
              <div class="form-group">
                <label>Sanatçı</label>
                <input id="song-artist" placeholder="Örnek: Alan Walker" />
              </div>
              <div class="form-group">
                <label>Kapak Görseli URL (isteğe bağlı)</label>
                <input id="song-image" placeholder="https://..." />
              </div>
              <div class="form-group">
                <label>Şarkı Sözleri (isteğe bağlı)</label>
                <textarea id="song-lyrics" placeholder="Şarkı sözlerini buraya yazın..." rows="5"></textarea>
              </div>
              <div class="form-group">
                <label>Dosya URL (catbox veya mp3 linki)</label>
                <input id="song-url" placeholder="https://..." />
              </div>
              <div style="display:flex; gap:12px;">
                <button id="addSongBtn" class="btn">
                  <i class="fas fa-save"></i>
                  Şarkıyı Ekle
                </button>
                <button id="clearBtn" class="btn btn-outline">
                  <i class="fas fa-eraser"></i>
                  Temizle
                </button>
              </div>
              <div id="admin-msg" class="status-message"></div>
            </div>
          </div>
          
          <!-- Şarkı İstekleri Bölümü -->
          <div id="song-requests-section" class="panel">
            <div class="card">
              <h3>Şarkı İstekleri</h3>
              <div id="song-requests-container">
                <div class="requests-list" id="song-requests-list">
                  <!-- İstekler buraya dinamik olarak eklenecek -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- İstatistikler Bölümü -->
          <div id="statistics-section" class="panel">
            <div class="card">
              <h3>Platform İstatistikleri</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: linear-gradient(135deg, #4a6bff 0%, #3a5be0 100%); color: white; padding: 20px; border-radius: 10px;">
                  <h4>Toplam Şarkı</h4>
                  <p id="total-songs" style="font-size: 2.5rem; font-weight: 700; margin: 10px 0;">0</p>
                </div>
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #e55a5a 100%); color: white; padding: 20px; border-radius: 10px;">
                  <h4>Bekleyen İstekler</h4>
                  <p id="pending-requests" style="font-size: 2.5rem; font-weight: 700; margin: 10px 0;">0</p>
                </div>
                <div style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 20px; border-radius: 10px;">
                  <h4>Onaylanan İstekler</h4>
                  <p id="approved-requests" style="font-size: 2.5rem; font-weight: 700; margin: 10px 0;">0</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Panel -->
    <div id="user-panel" class="panel active-panel">
      <h2>Keşfet</h2>
      <div class="grid-container">
        <div class="sidebar">
          <button id="user-btn-library" class="active">
            <i class="fas fa-compact-disc"></i>
            <span>Tüm Şarkılar</span>
          </button>
          <button id="user-btn-song-request">
            <i class="fas fa-plus-circle"></i>
            <span>Şarkı İsteği</span>
          </button>
          <button id="user-btn-artists">
            <i class="fas fa-users"></i>
            <span>Sanatçılar</span>
          </button>
        </div>
        
        <div class="main-content">
          <!-- Kullanıcı Kitaplık Bölümü -->
          <div id="user-library-section" class="active-panel">
            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Popüler Şarkılar</h3>
                <div style="position: relative;">
                  <input type="text" placeholder="Şarkı veya sanatçı ara..." style="width: 250px; margin: 0;" id="search-input">
                  <i class="fas fa-search" style="position: absolute; right: 15px; top: 13px; color: #6c757d;"></i>
                </div>
              </div>
              <div class="songs-grid" id="user-songs-list">
                <!-- Şarkılar buraya dinamik olarak eklenecek -->
              </div>
            </div>
          </div>
          
          <!-- Şarkı İsteği Bölümü -->
          <div id="user-song-request-section" class="panel">
            <div class="card">
              <h3>Yeni Şarkı İsteği</h3>
              <div class="form-group">
                <label>Şarkı Adı</label>
                <input id="request-song-name" placeholder="Örnek: Faded" />
              </div>
              <div class="form-group">
                <label>Sanatçı</label>
                <input id="request-song-artist" placeholder="Örnek: Alan Walker" />
              </div>
              <div class="form-group">
                <label>Şarkı Sözleri (isteğe bağlı)</label>
                <textarea id="request-song-lyrics" placeholder="Şarkı sözlerini buraya yazın..." rows="5"></textarea>
              </div>
              
              <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h4>Dosya Yükleme Talimatları</h4>
                <p>Catbox.moe'ya giderek dosyanızı yükleyin ve elde ettiğiniz linki aşağıya yapıştırın</p>
                <button class="btn btn-outline" style="margin-top: 15px;" onclick="window.open('https://catbox.moe/', '_blank')">
                  <i class="fas fa-external-link-alt"></i>
                  Catbox.moe'ya Git
                </button>
              </div>
              
              <div class="form-group">
                <label>Catbox.moe Dosya Linki</label>
                <input id="request-song-url" placeholder="https://files.catbox.moe/..." />
              </div>
              
              <div style="display:flex; gap:12px; margin-top:15px">
                <button id="sendRequestBtn" class="btn">
                  <i class="fas fa-paper-plane"></i>
                  Şarkı İsteği Gönder
                </button>
              </div>
              <div id="user-request-msg" class="status-message"></div>
            </div>
          </div>
          
          <!-- Sanatçılar Bölümü -->
          <div id="user-artists-section" class="panel">
            <div class="card">
              <h3>Sanatçılar</h3>
              <p>Bu bölüm yakında eklenecek. Şimdilik şarkılarınızı paylaşabilir ve diğer sanatçıların şarkılarını keşfedebilirsiniz.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Müzik Çalar -->
  <div class="player-container hidden" id="music-player">
    <div class="now-playing">
      <img src="https://placehold.co/60x60/4a6bff/white?text=♪" class="now-playing-img" id="player-image">
      <div class="now-playing-info">
        <div class="now-playing-title" id="player-title">Şarkı Adı</div>
        <div class="now-playing-artist" id="player-artist">Sanatçı</div>
      </div>
    </div>
    
    <div class="player-controls">
      <button class="control-btn" id="prev-btn">
        <i class="fas fa-step-backward"></i>
      </button>
      <button class="control-btn" id="play-pause-btn">
        <i class="fas fa-play" id="play-icon"></i>
      </button>
      <button class="control-btn" id="next-btn">
        <i class="fas fa-step-forward"></i>
      </button>
      
      <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <div class="volume-container">
        <i class="fas fa-volume-up"></i>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
      </div>
    </div>
    
    <audio id="audio-element"></audio>
  </div>

  <footer>
    <p>Müzik Platformu © 2023 - Yeni yeteneklerin keşfedilmesi için</p>
  </footer>

  <!-- Supabase ESM import (tarayıcıda çalışır) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- SENİN SUPABASE BİLGİLERİN (sen verdiğin) ---
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ADMIN IP (senin verdiğin) ---
    const ADMIN_IP = "151.250.4.2";

    // Elemanlar
    const adminPanel = document.getElementById('admin-panel');
    const userPanel = document.getElementById('user-panel');
    const userType = document.getElementById('user-type');
    const songsList = document.getElementById('songs-list');
    const userSongsList = document.getElementById('user-songs-list');
    const songRequestsList = document.getElementById('song-requests-list');
    const adminMsg = document.getElementById('admin-msg');
    const userRequestMsg = document.getElementById('user-request-msg');
    const addSongBtn = document.getElementById('addSongBtn');
    const clearBtn = document.getElementById('clearBtn');
    const sendRequestBtn = document.getElementById('sendRequestBtn');
    const searchInput = document.getElementById('search-input');
    
    // Müzik çalar elemanları
    const musicPlayer = document.getElementById('music-player');
    const audioElement = document.getElementById('audio-element');
    const playerTitle = document.getElementById('player-title');
    const playerArtist = document.getElementById('player-artist');
    const playerImage = document.getElementById('player-image');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playIcon = document.getElementById('play-icon');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const volumeSlider = document.getElementById('volume-slider');
    
    // Oynatma durumu
    let isPlaying = false;
    let currentSongIndex = 0;
    let songs = [];

    // Sayfa açılınca IP'yi al, admin mi kontrol et, şarkıları yükle
    async function init() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const d = await res.json();
        const ip = d.ip || 'unknown';
        
        // Eğer admin IP'si ise
        if (ip === ADMIN_IP) {
          // admin
          adminPanel.style.display = 'block';
          userPanel.style.display = 'none';
          userType.textContent = 'Yönetici';
          adminMsg.innerText = `Admin olarak giriş yaptınız.`;
          await loadSongRequests();
          await loadStatistics();
        } else {
          // normal kullanıcı
          adminPanel.style.display = 'none';
          userPanel.style.display = 'block';
          userType.textContent = 'Kullanıcı';
        }

        // Şarkıları her durumda yükle
        await loadSongs();
      } catch (err) {
        console.error("IP alınırken hata:", err);
        // Hata olsa bile şarkıları dene
        await loadSongs();
        adminPanel.style.display = 'none';
        userPanel.style.display = 'block';
        userType.textContent = 'Kullanıcı';
      }
      
      // Müzik çalar event listener'ları
      setupPlayerEvents();
    }

    // İstatistikleri yükle
    async function loadStatistics() {
      try {
        // Toplam şarkı sayısı
        const { count: songCount, error: songError } = await supabase
          .from('Songs')
          .select('*', { count: 'exact', head: true });
          
        if (!songError) {
          document.getElementById('total-songs').textContent = songCount || 0;
        }
        
        // Bekleyen istek sayısı
        const { count: pendingCount, error: pendingError } = await supabase
          .from('SongRequests')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'pending');
          
        if (!pendingError) {
          document.getElementById('pending-requests').textContent = pendingCount || 0;
        }
        
        // Onaylanan istek sayısı
        const { count: approvedCount, error: approvedError } = await supabase
          .from('SongRequests')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'approved');
          
        if (!approvedError) {
          document.getElementById('approved-requests').textContent = approvedCount || 0;
        }
      } catch (err) {
        console.error("İstatistik yüklenirken hata:", err);
      }
    }

    // Şarkı ekleme
    async function addSong() {
      adminMsg.innerText = "";
      adminMsg.className = "status-message";
      
      const name = document.getElementById('song-name').value.trim();
      const artist = document.getElementById('song-artist').value.trim();
      const image = document.getElementById('song-image').value.trim();
      const lyrics = document.getElementById('song-lyrics').value.trim();
      const url = document.getElementById('song-url').value.trim();

      if (!name || !artist || !url) {
        showMessage(adminMsg, "Lütfen tüm zorunlu alanları doldurun (şarkı adı, sanatçı, url).", "error");
        return;
      }

      try {
        showMessage(adminMsg, "Kaydediliyor...", "info");
        addSongBtn.disabled = true;

        const payload = { 
          name, 
          artist, 
          url,
          image: image || "https://placehold.co/400x400/4a6bff/white?text=♪",
          lyrics: lyrics || null
        };
        
        const { data, error } = await supabase
          .from('Songs')
          .insert([payload]);

        if (error) {
          showMessage(adminMsg, "Hata: " + error.message, "error");
          console.error("Supabase insert error:", error);
        } else {
          showMessage(adminMsg, "Şarkı başarıyla eklendi ✅", "success");
          // form temizle
          document.getElementById('song-name').value = '';
          document.getElementById('song-artist').value = '';
          document.getElementById('song-image').value = '';
          document.getElementById('song-lyrics').value = '';
          document.getElementById('song-url').value = '';
          await loadSongs();
          await loadStatistics();
        }
      } catch (err) {
        showMessage(adminMsg, "Beklenmeyen hata: " + (err.message || err), "error");
        console.error("Insert exception:", err);
      } finally {
        addSongBtn.disabled = false;
      }
    }

    // Şarkı isteği gönderme
    async function sendSongRequest() {
      userRequestMsg.innerText = "";
      userRequestMsg.className = "status-message";
      
      const name = document.getElementById('request-song-name').value.trim();
      const artist = document.getElementById('request-song-artist').value.trim();
      const lyrics = document.getElementById('request-song-lyrics').value.trim();
      const url = document.getElementById('request-song-url').value.trim();

      if (!name || !artist || !url) {
        showMessage(userRequestMsg, "Lütfen tüm zorunlu alanları doldurun.", "error");
        return;
      }

      // URL'nin geçerli bir catbox URL'si olup olmadığını kontrol et
      if (!url.includes('catbox.moe')) {
        showMessage(userRequestMsg, "Lütfen geçerli bir catbox.moe URL'si girin.", "error");
        return;
      }

      try {
        showMessage(userRequestMsg, "İstek gönderiliyor...", "info");
        sendRequestBtn.disabled = true;

        const payload = { 
          name, 
          artist, 
          file_url: url,
          lyrics: lyrics || null,
          status: 'pending'
        };
        
        const { data, error } = await supabase
          .from('SongRequests')
          .insert([payload]);

        if (error) {
          showMessage(userRequestMsg, "Hata: " + error.message, "error");
          console.error("Supabase insert error:", error);
        } else {
          showMessage(userRequestMsg, "Şarkı isteği başarıyla gönderildi ✅", "success");
          // form temizle
          document.getElementById('request-song-name').value = '';
          document.getElementById('request-song-artist').value = '';
          document.getElementById('request-song-lyrics').value = '';
          document.getElementById('request-song-url').value = '';
          await loadStatistics();
        }
      } catch (err) {
        showMessage(userRequestMsg, "Beklenmeyen hata: " + (err.message || err), "error");
        console.error("Insert exception:", err);
      } finally {
        sendRequestBtn.disabled = false;
      }
    }

    // Şarkı isteklerini yükle (admin için)
    async function loadSongRequests() {
      songRequestsList.innerHTML = '<div class="status-message status-info">Yükleniyor...</div>';
      try {
        const { data, error } = await supabase
          .from('SongRequests')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          songRequestsList.innerHTML = `<div class="status-message status-error">İstekler yüklenemedi: ${error.message}</div>`;
          console.error("Supabase select error:", error);
          return;
        }

        if (!data || data.length === 0) {
          songRequestsList.innerHTML = '<div class="status-message status-info">Henüz şarkı isteği yok.</div>';
          return;
        }

        songRequestsList.innerHTML = '';
        data.forEach(request => {
          const requestEl = document.createElement('div');
          requestEl.className = 'request-item';
          requestEl.innerHTML = `
            <div class="request-info">
              <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(request.name || '')} - ${escapeHtml(request.artist || '')}</div>
              <div style="color: #6c757d; margin: 8px 0;">Durum: ${request.status || 'pending'}</div>
              ${request.lyrics ? `
                <div class="lyrics-container">
                  <div class="lyrics-title">Şarkı Sözleri:</div>
                  <div>${escapeHtml(request.lyrics)}</div>
                </div>
              ` : ''}
              <div style="margin-top: 10px;">
                <a href="${escapeAttr(request.file_url || '')}" target="_blank" class="btn btn-sm btn-outline">
                  <i class="fas fa-play"></i> Dinle
                </a>
              </div>
            </div>
            <div class="request-actions">
              ${request.status === 'pending' ? `
                <button class="btn btn-sm" onclick="approveSongRequest(${request.id}, '${escapeAttr(request.name)}', '${escapeAttr(request.artist)}', '${escapeAttr(request.file_url)}', '${escapeAttr(request.lyrics || '')}')">
                  <i class="fas fa-check"></i> Onayla
                </button>
                <button class="btn btn-sm btn-danger" onclick="rejectSongRequest(${request.id})">
                  <i class="fas fa-times"></i> Reddet
                </button>
              ` : ''}
            </div>
          `;
          songRequestsList.appendChild(requestEl);
        });

      } catch (err) {
        songRequestsList.innerHTML = `<div class="status-message status-error">Beklenmeyen istek yükleme hatası: ${err.message || err}</div>`;
        console.error(err);
      }
    }

    // Şarkı isteğini onayla
    async function approveSongRequest(id, name, artist, fileUrl, lyrics) {
      try {
        // Önce şarkıyı ekle
        const image = "https://placehold.co/400x400/4a6bff/white?text=♪";
        
        const { data, error } = await supabase
          .from('Songs')
          .insert([{ 
            name, 
            artist, 
            url: fileUrl,
            image: image,
            lyrics: lyrics || null
          }]);

        if (error) {
          console.error("Şarkı ekleme hatası:", error);
          return;
        }

        // Sonra istek durumunu güncelle
        const { error: updateError } = await supabase
          .from('SongRequests')
          .update({ status: 'approved' })
          .eq('id', id);

        if (updateError) {
          console.error("İstek onaylama hatası:", updateError);
        } else {
          // Listeyi yenile
          await loadSongRequests();
          await loadSongs();
          await loadStatistics();
        }
      } catch (err) {
        console.error("İstek onaylama hatası:", err);
      }
    }

    // Şarkı isteğini reddet
    async function rejectSongRequest(id) {
      try {
        const { error } = await supabase
          .from('SongRequests')
          .update({ status: 'rejected' })
          .eq('id', id);

        if (error) {
          console.error("İstek reddetme hatası:", error);
        } else {
          // Listeyi yenile
          await loadSongRequests();
          await loadStatistics();
        }
      } catch (err) {
        console.error("İstek reddetme hatası:", err);
      }
    }

    // Şarkıları yükle / listele
    async function loadSongs() {
      const lists = [songsList, userSongsList];
      
      for (const list of lists) {
        if (list) list.innerHTML = '<div class="status-message status-info">Yükleniyor...</div>';
      }
      
      try {
        const { data, error } = await supabase
          .from('Songs')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          const errorMsg = '<div class="status-message status-error">Liste yüklenemedi: ' + error.message + '</div>';
          for (const list of lists) {
            if (list) list.innerHTML = errorMsg;
          }
          console.error("Supabase select error:", error);
          return;
        }

        if (!data || data.length === 0) {
          const emptyMsg = '<div class="status-message status-info">Henüz şarkı yok.</div>';
          for (const list of lists) {
            if (list) list.innerHTML = emptyMsg;
          }
          return;
        }

        // Şarkıları global değişkende sakla
        songs = data;
        
        for (const list of lists) {
          if (!list) continue;
          
          list.innerHTML = '';
          data.forEach((s, index) => {
            const songCard = document.createElement('div');
            songCard.className = 'song-card';
            songCard.innerHTML = `
              <div class="song-image" style="background-image: url('${escapeAttr(s.image || 'https://placehold.co/400x400/4a6bff/white?text=♪')}')">
                <div class="song-overlay">
                  <button class="btn btn-sm" onclick="playSong(${index})">
                    <i class="fas fa-play"></i> Oynat
                  </button>
                </div>
              </div>
              <div class="song-info">
                <div class="song-title">${escapeHtml(s.name || '')}</div>
                <div class="song-artist">${escapeHtml(s.artist || '')}</div>
                ${s.lyrics ? `
                  <div class="lyrics-container">
                    <div class="lyrics-title">Şarkı Sözleri:</div>
                    <div>${escapeHtml(truncateText(s.lyrics, 100))}</div>
                  </div>
                ` : ''}
                <div class="song-actions">
                  <button class="btn btn-sm btn-outline" onclick="playSong(${index})">
                    <i class="fas fa-play"></i> Oynat
                  </button>
                  ${isAdmin() ? `
                    <button class="btn btn-sm btn-danger" onclick="deleteSong(${s.id})">
                      <i class="fas fa-trash"></i> Sil
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
            list.appendChild(songCard);
          });
        }
      } catch (err) {
        const errorMsg = '<div class="status-message status-error">Beklenmeyen liste hatası: ' + (err.message || err) + '</div>';
        for (const list of lists) {
          if (list) list.innerHTML = errorMsg;
        }
        console.error(err);
      }
    }

    // Şarkıyı sil
    async function deleteSong(id) {
      if (!confirm("Bu şarkıyı silmek istediğinize emin misiniz?")) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('Songs')
          .delete()
          .eq('id', id);

        if (error) {
          console.error("Şarkı silme hatası:", error);
          alert("Şarkı silinirken bir hata oluştu: " + error.message);
        } else {
          // Listeyi yenile
          await loadSongs();
          await loadStatistics();
        }
      } catch (err) {
        console.error("Şarkı silme hatası:", err);
        alert("Şarkı silinirken bir hata oluştu: " + err.message);
      }
    }

    // Şarkıyı çal
    function playSong(index) {
      if (index < 0 || index >= songs.length) return;
      
      currentSongIndex = index;
      const song = songs[index];
      
      // Müzik çaları göster
      musicPlayer.classList.remove('hidden');
      
      // Bilgileri güncelle
      playerTitle.textContent = song.name;
      playerArtist.textContent = song.artist;
      playerImage.src = song.image || 'https://placehold.co/60x60/4a6bff/white?text=♪';
      
      // Audio element source'unu güncelle
      audioElement.src = song.url;
      
      // Oynat
      playSong();
    }

    // Şarkıyı oynat/durdur
    function togglePlayPause() {
      if (isPlaying) {
        pauseSong();
      } else {
        playSong();
      }
    }

    // Şarkıyı oynat
    function playSong() {
      audioElement.play()
        .then(() => {
          isPlaying = true;
          playIcon.className = 'fas fa-pause';
        })
        .catch(error => {
          console.error("Oynatma hatası:", error);
        });
    }

    // Şarkıyı duraklat
    function pauseSong() {
      audioElement.pause();
      isPlaying = false;
      playIcon.className = 'fas fa-play';
    }

    // Önceki şarkı
    function prevSong() {
      currentSongIndex--;
      if (currentSongIndex < 0) {
        currentSongIndex = songs.length - 1;
      }
      playSong(currentSongIndex);
    }

    // Sonraki şarkı
    function nextSong() {
      currentSongIndex++;
      if (currentSongIndex >= songs.length) {
        currentSongIndex = 0;
      }
      playSong(currentSongIndex);
    }

    // İlerleme çubuğunu güncelle
    function updateProgress(e) {
      const { duration, currentTime } = e.srcElement;
      const progressPercent = (currentTime / duration) * 100;
      progressBar.style.width = `${progressPercent}%`;
    }

    // İlerleme çubuğuna tıklama
    function setProgress(e) {
      const width = this.clientWidth;
      const clickX = e.offsetX;
      const duration = audioElement.duration;
      audioElement.currentTime = (clickX / width) * duration;
    }

    // Ses seviyesini ayarla
    function setVolume() {
      audioElement.volume = this.value / 100;
    }

    // Müzik çalar event listener'larını kur
    function setupPlayerEvents() {
      // Oynat/Duraklat
      playPauseBtn.addEventListener('click', togglePlayPause);
      
      // Önceki/Sonraki
      prevBtn.addEventListener('click', prevSong);
      nextBtn.addEventListener('click', nextSong);
      
      // İlerleme çubuğu
      audioElement.addEventListener('timeupdate', updateProgress);
      progressContainer.addEventListener('click', setProgress);
      
      // Ses seviyesi
      volumeSlider.addEventListener('input', setVolume);
      
      // Şarkı bitince
      audioElement.addEventListener('ended', nextSong);
    }

    // Admin kontrolü
    function isAdmin() {
      return adminPanel.style.display === 'block';
    }

    // Mesaj göster
    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = "status-message";
      if (type === "error") element.classList.add("status-error");
      if (type === "success") element.classList.add("status-success");
      if (type === "info") element.classList.add("status-info");
    }

    // Metni kısalt
    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    // Basit escaping yardımcıları
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }
    function escapeAttr(text) { return escapeHtml(text); }

    // Sidebar butonları için event listener'lar
    function setupSidebarButtons() {
      // Admin paneli butonları
      document.getElementById('btn-library').addEventListener('click', () => {
        showPanel('library-section');
        setActiveButton('btn-library');
      });
      
      document.getElementById('btn-add-song').addEventListener('click', () => {
        showPanel('add-song-section');
        setActiveButton('btn-add-song');
      });
      
      document.getElementById('btn-song-requests').addEventListener('click', () => {
        showPanel('song-requests-section');
        setActiveButton('btn-song-requests');
      });
      
      document.getElementById('btn-statistics').addEventListener('click', () => {
        showPanel('statistics-section');
        setActiveButton('btn-statistics');
      });
      
      // Kullanıcı paneli butonları
      document.getElementById('user-btn-library').addEventListener('click', () => {
        showUserPanel('user-library-section');
        setActiveUserButton('user-btn-library');
      });
      
      document.getElementById('user-btn-song-request').addEventListener('click', () => {
        showUserPanel('user-song-request-section');
        setActiveUserButton('user-btn-song-request');
      });
      
      document.getElementById('user-btn-artists').addEventListener('click', () => {
        showUserPanel('user-artists-section');
        setActiveUserButton('user-btn-artists');
      });
    }

    // Panel göster
    function showPanel(panelId) {
      document.querySelectorAll('.main-content > .panel').forEach(panel => {
        panel.classList.remove('active-panel');
      });
      document.getElementById(panelId).classList.add('active-panel');
    }

    // Kullanıcı paneli göster
    function showUserPanel(panelId) {
      document.querySelectorAll('#user-panel .main-content > .panel').forEach(panel => {
        panel.classList.remove('active-panel');
      });
      document.getElementById(panelId).classList.add('active-panel');
    }

    // Aktif butonu ayarla
    function setActiveButton(buttonId) {
      document.querySelectorAll('#admin-panel .sidebar button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(buttonId).classList.add('active');
    }

    // Aktif kullanıcı butonunu ayarla
    function setActiveUserButton(buttonId) {
      document.querySelectorAll('#user-panel .sidebar button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(buttonId).classList.add('active');
    }

    // Arama işlevi
    function setupSearch() {
      searchInput.addEventListener('input', () => {
        const searchText = searchInput.value.toLowerCase();
        const songCards = userSongsList.querySelectorAll('.song-card');
        
        songCards.forEach(card => {
          const title = card.querySelector('.song-title').textContent.toLowerCase();
          const artist = card.querySelector('.song-artist').textContent.toLowerCase();
          
          if (title.includes(searchText) || artist.includes(searchText)) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      });
    }

    // eventler
    addSongBtn.addEventListener('click', addSong);
    clearBtn.addEventListener('click', () => {
      document.getElementById('song-name').value = '';
      document.getElementById('song-artist').value = '';
      document.getElementById('song-image').value = '';
      document.getElementById('song-lyrics').value = '';
      document.getElementById('song-url').value = '';
      adminMsg.innerText = '';
      adminMsg.className = "status-message";
    });
    
    sendRequestBtn.addEventListener('click', sendSongRequest);

    // başlat
    init();
    setupSidebarButtons();
    setupSearch();
    
    // Global fonksiyonlar
    window.approveSongRequest = approveSongRequest;
    window.rejectSongRequest = rejectSongRequest;
    window.playSong = playSong;
    window.deleteSong = deleteSong;
  </script>
</body>
</html>
