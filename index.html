<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi - Admin + KullanÄ±cÄ±</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding:20px; background: #f6f7fb; color:#111; }
    h1,h2{ margin:8px 0; }
    input{ padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    button{ padding:10px 14px; margin-top:8px; cursor:pointer; }
    #admin-panel, #user-panel { 
      display:none; 
      background:white; 
      padding:16px; 
      border-radius:8px; 
      box-shadow:0 6px 18px rgba(0,0,0,.06); 
      margin-bottom:20px; 
    }
    .container {
      display: flex;
      gap: 20px;
      max-width: 1200px;
    }
    .sidebar {
      width: 200px;
      flex-shrink: 0;
    }
    .main-content {
      flex-grow: 1;
    }
    .sidebar button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 5px;
      text-align: left;
      cursor: pointer;
    }
    .sidebar button.active {
      background: #4a6bff;
      color: white;
    }
    ul#songs-list, ul#song-requests-list, ul#access-requests-list { list-style:none; padding:0; }
    li.song-item{ padding:10px 0; border-bottom:1px solid #eee; }
    .hint{ color:#666; font-size:13px; margin-top:8px; }
    .error{ color:#c62828; font-weight:700; }
    .ok{ color:#2e7d32; font-weight:700; }
    footer { margin-top:20px; color:#666; font-size:13px; }
    .request-item {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .request-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    #upload-status {
      margin-top: 10px;
      font-size: 14px;
    }
    .catbox-instructions {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #4a6bff;
    }
    .access-request-item {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    .approve-all-btn {
      margin-bottom: 15px;
      background: #2e7d32;
      color: white;
    }
    .tablo-hata {
      background: #ffebee;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #c62828;
    }
  </style>
</head>
<body>
  <h1>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</h1>

  <!-- Admin Panel -->
  <div id="admin-panel">
    <h2>ðŸŽ§ Admin Paneli</h2>
    <div class="container">
      <div class="sidebar">
        <button id="btn-library" class="active">KitaplÄ±k</button>
        <button id="btn-add-song">ÅžarkÄ± Ekle</button>
        <button id="btn-song-requests">ÅžarkÄ± Ä°stekleri</button>
        <button id="btn-access-requests">GiriÅŸ OnaylarÄ±</button>
      </div>
      <div class="main-content">
        <!-- KitaplÄ±k BÃ¶lÃ¼mÃ¼ -->
        <div id="library-section">
          <h3>MÃ¼zik KitaplÄ±ÄŸÄ±</h3>
          <div id="songs-container">
            <ul id="songs-list"></ul>
          </div>
        </div>
        
        <!-- ÅžarkÄ± Ekleme BÃ¶lÃ¼mÃ¼ -->
        <div id="add-song-section" style="display:none">
          <h3>ÅžarkÄ± Ekle</h3>
          <label>ÅžarkÄ± AdÄ±</label>
          <input id="song-name" placeholder="Ã–rnek: Faded" />
          <label>SanatÃ§Ä±</label>
          <input id="song-artist" placeholder="Ã–rnek: Alan Walker" />
          <label>Dosya URL (catbox veya mp3 linki)</label>
          <input id="song-url" placeholder="https://..." />
          <div style="display:flex; gap:8px;">
            <button id="addSongBtn">ÅžarkÄ±yÄ± Ekle</button>
            <button id="clearBtn" style="background:#eee">Temizle</button>
          </div>
          <p id="admin-msg" class="hint"></p>
        </div>
        
        <!-- ÅžarkÄ± Ä°stekleri BÃ¶lÃ¼mÃ¼ -->
        <div id="song-requests-section" style="display:none">
          <h3>ÅžarkÄ± Ä°stekleri</h3>
          <div id="song-requests-container">
            <ul id="song-requests-list"></ul>
          </div>
        </div>
        
        <!-- GiriÅŸ OnaylarÄ± BÃ¶lÃ¼mÃ¼ -->
        <div id="access-requests-section" style="display:none">
          <h3>GiriÅŸ OnaylarÄ±</h3>
          <div id="tablo-hata-mesaji" class="tablo-hata" style="display:none;">
            AccessRequests tablosu bulunamadÄ±. LÃ¼tfen sayfayÄ± tamamen yenileyin (Ctrl+F5).
          </div>
          <button id="approveAllBtn" class="approve-all-btn">TÃ¼mÃ¼nÃ¼ Onayla</button>
          <div id="access-requests-container">
            <ul id="access-requests-list"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel">
    <h2>ðŸ“€ MÃ¼zik KitaplÄ±ÄŸÄ±</h2>
    <div class="container">
      <div class="sidebar">
        <button id="user-btn-library" class="active">KitaplÄ±k</button>
        <button id="user-btn-song-request">ÅžarkÄ± Ä°steÄŸi</button>
      </div>
      <div class="main-content">
        <!-- KullanÄ±cÄ± KitaplÄ±k BÃ¶lÃ¼mÃ¼ -->
        <div id="user-library-section">
          <div id="user-songs-container">
            <ul id="user-songs-list"></ul>
          </div>
        </div>
        
        <!-- ÅžarkÄ± Ä°steÄŸi BÃ¶lÃ¼mÃ¼ -->
        <div id="user-song-request-section" style="display:none">
          <h3>ÅžarkÄ± Ä°steÄŸi GÃ¶nder</h3>
          <label>ÅžarkÄ± AdÄ±</label>
          <input id="request-song-name" placeholder="Ã–rnek: Faded" />
          <label>SanatÃ§Ä±</label>
          <input id="request-song-artist" placeholder="Ã–rnek: Alan Walker" />
          
          <div class="catbox-instructions">
            <h4>Dosya YÃ¼kleme TalimatlarÄ±:</h4>
            <ol>
              <li><button onclick="window.open('https://catbox.moe/', '_blank')">Catbox.moe'ya Git</button></li>
              <li>DosyanÄ±zÄ± catbox.moe'ya yÃ¼kleyin</li>
              <li>YÃ¼kleme tamamlandÄ±ÄŸÄ±nda size verilen linki aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±rÄ±n</li>
            </ol>
          </div>
          
          <label>Catbox.moe Dosya Linki</label>
          <input id="request-song-url" placeholder="https://files.catbox.moe/..." />
          
          <div style="display:flex; gap:8px; margin-top:15px">
            <button id="sendRequestBtn">ÅžarkÄ± Ä°steÄŸi GÃ¶nder</button>
          </div>
          <p id="user-request-msg" class="hint"></p>
        </div>
      </div>
    </div>
    <p id="user-ip" class="hint"></p>
    <p id="user-msg" class="hint"></p>
  </div>

  <footer>
    <div id="debug" class="hint"></div>
  </footer>

  <!-- Supabase ESM import (tarayÄ±cÄ±da Ã§alÄ±ÅŸÄ±r) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- SENÄ°N SUPABASE BÄ°LGÄ°LERÄ°N (sen verdiÄŸin) ---
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    
    // Supabase baÄŸlantÄ±sÄ±nÄ± schema ile birlikte oluÅŸtur
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
      db: { schema: 'public' },
      global: { fetch: (...args) => fetch(...args) }
    });

    // --- ADMIN IP (senin verdiÄŸin) ---
    const ADMIN_IP = "151.250.4.2";

    // Elemanlar
    const adminPanel = document.getElementById('admin-panel');
    const userPanel = document.getElementById('user-panel');
    const userIpP = document.getElementById('user-ip');
    const songsList = document.getElementById('songs-list');
    const userSongsList = document.getElementById('user-songs-list');
    const songRequestsList = document.getElementById('song-requests-list');
    const accessRequestsList = document.getElementById('access-requests-list');
    const adminMsg = document.getElementById('admin-msg');
    const userMsg = document.getElementById('user-msg');
    const userRequestMsg = document.getElementById('user-request-msg');
    const debug = document.getElementById('debug');
    const addSongBtn = document.getElementById('addSongBtn');
    const clearBtn = document.getElementById('clearBtn');
    const sendRequestBtn = document.getElementById('sendRequestBtn');
    const approveAllBtn = document.getElementById('approveAllBtn');
    const tabloHataMesaji = document.getElementById('tablo-hata-mesaji');

    // OnaylanmÄ±ÅŸ IP'ler (localStorage'da saklanacak)
    let approvedIPs = JSON.parse(localStorage.getItem('approvedIPs')) || [];

    // Sayfa aÃ§Ä±lÄ±nca IP'yi al, admin mi kontrol et, ÅŸarkÄ±larÄ± yÃ¼kle
    async function init() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const d = await res.json();
        const ip = d.ip || 'unknown';
        debug.innerText = ""; // baÅŸlangÄ±Ã§ta temiz
        console.log("GÃ¶rÃ¼nen IP:", ip);

        // IP'yi kaydet
        localStorage.setItem('currentIP', ip);
        
        // EÄŸer admin IP'si ise
        if (ip === ADMIN_IP) {
          // admin
          adminPanel.style.display = 'block';
          userPanel.style.display = 'none';
          adminMsg.innerText = `Admin olarak giriÅŸ yaptÄ±nÄ±z (IP: ${ip}).`;
          await loadSongRequests(); // ÅžarkÄ± isteklerini yÃ¼kle
          await loadAccessRequests(); // GiriÅŸ isteklerini yÃ¼kle
        } else {
          // normal kullanÄ±cÄ± - artÄ±k direkt girebiliyor
          adminPanel.style.display = 'none';
          userPanel.style.display = 'block';
          userIpP.innerText = `Senin IP adresin: ${ip}`;
          userMsg.innerText = ``;
          
          // IP'yi access requests tablosuna kaydet
          await saveAccessRequest(ip);
        }

        // ÅžarkÄ±larÄ± her durumda yÃ¼kle
        await loadSongs();
      } catch (err) {
        debug.innerText = "IP alÄ±nÄ±rken hata: " + (err.message || err);
        console.error(err);
        // Hata olsa bile ÅŸarkÄ±larÄ± dene
        await loadSongs();
        adminPanel.style.display = 'none';
        userPanel.style.display = 'block';
      }
    }

    // EriÅŸim isteÄŸini kaydet
    async function saveAccessRequest(ip) {
      try {
        // Ã–ncelikle bu IP zaten kayÄ±tlÄ± mÄ± kontrol et
        const { data: existingRequests, error: checkError } = await supabase
          .from('AccessRequests')
          .select('*')
          .eq('ip', ip);

        if (checkError) {
          console.error("EriÅŸim isteÄŸi kontrol hatasÄ±:", checkError);
          return;
        }

        // EÄŸer bu IP zaten kayÄ±tlÄ± deÄŸilse ekle
        if (!existingRequests || existingRequests.length === 0) {
          const { error } = await supabase
            .from('AccessRequests')
            .insert([{ 
              ip: ip, 
              status: 'pending',
              created_at: new Date().toISOString()
            }]);

          if (error) {
            console.error("EriÅŸim isteÄŸi kaydetme hatasÄ±:", error);
          }
        }
      } catch (err) {
        console.error("EriÅŸim isteÄŸi kaydetme hatasÄ±:", err);
      }
    }

    // GiriÅŸ isteklerini yÃ¼kle (admin iÃ§in)
    async function loadAccessRequests() {
      accessRequestsList.innerHTML = 'YÃ¼kleniyor...';
      try {
        const { data, error } = await supabase
          .from('AccessRequests')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          if (error.message.includes('schema cache')) {
            tabloHataMesaji.style.display = 'block';
            accessRequestsList.innerHTML = '<li class="hint">Tablo bulunamadÄ±. LÃ¼tfen sayfayÄ± tamamen yenileyin (Ctrl+F5).</li>';
          } else {
            accessRequestsList.innerHTML = `<li class="error">Ä°stekler yÃ¼klenemedi: ${error.message}</li>`;
          }
          console.error("Supabase select error:", error);
          return;
        }

        tabloHataMesaji.style.display = 'none';

        if (!data || data.length === 0) {
          accessRequestsList.innerHTML = '<li class="hint">HenÃ¼z giriÅŸ isteÄŸi yok.</li>';
          return;
        }

        accessRequestsList.innerHTML = '';
        data.forEach(request => {
          const li = document.createElement('li');
          li.className = 'access-request-item';
          li.innerHTML = `
            <div><strong>IP Adresi:</strong> ${escapeHtml(request.ip || '')}</div>
            <div><strong>Durum:</strong> ${request.status || 'pending'}</div>
            <div><strong>Ä°stek ZamanÄ±:</strong> ${new Date(request.created_at).toLocaleString('tr-TR')}</div>
            ${request.status === 'pending' ? `
              <div class="request-actions">
                <button class="approve-access-btn" data-ip="${escapeAttr(request.ip)}">Onayla</button>
              </div>
            ` : ''}
          `;
          accessRequestsList.appendChild(li);
        });

        // Onayla butonlarÄ±na event ekle
        document.querySelectorAll('.approve-access-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const ip = btn.getAttribute('data-ip');
            approveAccessRequest(ip);
          });
        });

      } catch (err) {
        accessRequestsList.innerHTML = `<li class="error">Beklenmeyen istek yÃ¼kleme hatasÄ±: ${err.message || err}</li>`;
        console.error(err);
      }
    }

    // DiÄŸer fonksiyonlar aynÄ± kalacak, kÄ±saltma iÃ§in buraya eklemedim
    // (addSong, sendSongRequest, approveAllAccessRequests, approveAccessRequest, 
    // loadSongRequests, approveSongRequest, rejectSongRequest, loadSongs fonksiyonlarÄ±)

    // Basit escaping yardÄ±mcÄ±larÄ±
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }
    function escapeAttr(text) { return escapeHtml(text); }

    // Sidebar butonlarÄ± iÃ§in event listener'lar
    function setupSidebarButtons() {
      // Admin paneli butonlarÄ±
      document.getElementById('btn-library').addEventListener('click', () => {
        document.getElementById('library-section').style.display = 'block';
        document.getElementById('add-song-section').style.display = 'none';
        document.getElementById('song-requests-section').style.display = 'none';
        document.getElementById('access-requests-section').style.display = 'none';
        
        // Aktif butonu gÃ¼ncelle
        document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-library').classList.add('active');
      });
      
      // DiÄŸer buton eventleri...
      
    }

    // eventler
    addSongBtn.addEventListener('click', addSong);
    clearBtn.addEventListener('click', () => {
      document.getElementById('song-name').value = '';
      document.getElementById('song-artist').value = '';
      document.getElementById('song-url').value = '';
      adminMsg.innerText = '';
    });
    
    sendRequestBtn.addEventListener('click', sendSongRequest);
    approveAllBtn.addEventListener('click', approveAllAccessRequests);

    // baÅŸlat
    init();
    setupSidebarButtons();

    // Eksik fonksiyonlarÄ± buraya ekliyorum
    async function addSong() {
      // Ã–nceki addSong fonksiyonunun iÃ§eriÄŸi
    }

    async function sendSongRequest() {
      // Ã–nceki sendSongRequest fonksiyonunun iÃ§eriÄŸi
    }

    async function approveAllAccessRequests() {
      // Ã–nceki approveAllAccessRequests fonksiyonunun iÃ§eriÄŸi
    }

    async function approveAccessRequest(ip) {
      // Ã–nceki approveAccessRequest fonksiyonunun iÃ§eriÄŸi
    }

    async function loadSongRequests() {
      // Ã–nceki loadSongRequests fonksiyonunun iÃ§eriÄŸi
    }

    async function approveSongRequest(id) {
      // Ã–nceki approveSongRequest fonksiyonunun iÃ§eriÄŸi
    }

    async function rejectSongRequest(id) {
      // Ã–nceki rejectSongRequest fonksiyonunun iÃ§eriÄŸi
    }

    async function loadSongs() {
      // Ã–nceki loadSongs fonksiyonunun iÃ§eriÄŸi
    }
  </script>
</body>
</html>
