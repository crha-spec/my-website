<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi - Admin + KullanÄ±cÄ±</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding:20px; background: #f6f7fb; color:#111; }
    h1,h2{ margin:8px 0; }
    input{ padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
    button{ padding:10px 14px; margin-top:8px; cursor:pointer; }
    #admin-panel, #user-panel { display:none; background:white; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.06); max-width:720px; margin-bottom:20px; }
    ul#songs-list{ list-style:none; padding:0; }
    li.song-item{ padding:10px 0; border-bottom:1px solid #eee; }
    .hint{ color:#666; font-size:13px; margin-top:8px; }
    .error{ color:#c62828; font-weight:700; }
    .ok{ color:#2e7d32; font-weight:700; }
    footer { margin-top:20px; color:#666; font-size:13px; }
  </style>
</head>
<body>
  <h1>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</h1>

  <!-- Admin Panel -->
  <div id="admin-panel">
    <h2>ðŸŽ§ Admin Paneli</h2>
    <label>ÅžarkÄ± AdÄ±</label>
    <input id="song-name" placeholder="Ã–rnek: Faded" />
    <label>SanatÃ§Ä±</label>
    <input id="song-artist" placeholder="Ã–rnek: Alan Walker" />
    <label>Dosya URL (catbox veya mp3 linki)</label>
    <input id="song-url" placeholder="https://..." />
    <div style="display:flex; gap:8px;">
      <button id="addSongBtn">ÅžarkÄ±yÄ± Ekle</button>
      <button id="clearBtn" style="background:#eee">Temizle</button>
    </div>
    <p id="admin-msg" class="hint"></p>
  </div>

  <!-- User Panel -->
  <div id="user-panel">
    <h2>ðŸ“€ MÃ¼zik KitaplÄ±ÄŸÄ±</h2>
    <div id="songs-container">
      <ul id="songs-list"></ul>
    </div>
    <p id="user-ip" class="hint"></p>
    <p id="user-msg" class="hint"></p>
  </div>

  <footer>
    <div id="debug" class="hint"></div>
  </footer>

  <!-- Supabase ESM import (tarayÄ±cÄ±da Ã§alÄ±ÅŸÄ±r) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- SENÄ°N SUPABASE BÄ°LGÄ°LERÄ°N (sen verdiÄŸin) ---
    const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ADMIN IP (senin verdiÄŸin) ---
    const ADMIN_IP = "151.250.4.2";

    // Elemanlar
    const adminPanel = document.getElementById('admin-panel');
    const userPanel = document.getElementById('user-panel');
    const userIpP = document.getElementById('user-ip');
    const songsList = document.getElementById('songs-list');
    const adminMsg = document.getElementById('admin-msg');
    const userMsg = document.getElementById('user-msg');
    const debug = document.getElementById('debug');
    const addSongBtn = document.getElementById('addSongBtn');
    const clearBtn = document.getElementById('clearBtn');

    // Sayfa aÃ§Ä±lÄ±nca IP'yi al, admin mi kontrol et, ÅŸarkÄ±larÄ± yÃ¼kle
    async function init() {
      try {
        const res = await fetch("https://api64.ipify.org?format=json");
        const d = await res.json();
        const ip = d.ip || 'unknown';
        debug.innerText = ""; // baÅŸlangÄ±Ã§ta temiz
        console.log("GÃ¶rÃ¼nen IP:", ip);

        if (ip === ADMIN_IP) {
          // admin
          adminPanel.style.display = 'block';
          userPanel.style.display = 'none';
          adminMsg.innerText = `Admin olarak giriÅŸ yaptÄ±nÄ±z (IP: ${ip}).`;
        } else {
          // normal kullanÄ±cÄ±
          adminPanel.style.display = 'none';
          userPanel.style.display = 'block';
          userIpP.innerText = `Senin IP adresin: ${ip}`;
          userMsg.innerText = `EÄŸer bu senin gerÃ§ek IPnin deÄŸilse, IP eÅŸleÅŸmesini kontrol et.`;
        }

        // ÅžarkÄ±larÄ± her durumda yÃ¼kle
        await loadSongs();
      } catch (err) {
        debug.innerText = "IP alÄ±nÄ±rken hata: " + (err.message || err);
        console.error(err);
        // Hata olsa bile ÅŸarkÄ±larÄ± dene
        await loadSongs();
        adminPanel.style.display = 'none';
        userPanel.style.display = 'block';
      }
    }

    // ÅžarkÄ± ekleme
    async function addSong() {
      adminMsg.innerText = "";
      const name = document.getElementById('song-name').value.trim();
      const artist = document.getElementById('song-artist').value.trim();
      const url = document.getElementById('song-url').value.trim();

      if (!name || !artist || !url) {
        adminMsg.innerText = "LÃ¼tfen tÃ¼m alanlarÄ± doldurun (name, artist, url).";
        adminMsg.className = "error";
        return;
      }

      // insert dene
      try {
        adminMsg.innerText = "Kaydediliyor...";
        addSongBtn.disabled = true;

        const payload = { name, artist, url };
        const { data, error } = await supabase
          .from('Songs')    // tablo adÄ±: public.Songs
          .insert([payload]);

        if (error) {
          // RLS veya benzeri bir problem varsa error.message burada olacak
          adminMsg.innerText = "Hata: " + error.message;
          adminMsg.className = "error";
          console.error("Supabase insert error:", error);
          // EÄŸer RLS hatasÄ±ysa kullanÄ±cÄ±ya SQL dÃ¼zeltmesi gerektiÄŸini sÃ¶yle
          if (error.message && error.message.toLowerCase().includes('row-level')) {
            adminMsg.innerText += " â€” RLS policy izinlerini kontrol et (SQL tarafÄ±nda insert izni ver).";
          }
        } else {
          adminMsg.innerText = "ÅžarkÄ± baÅŸarÄ±yla eklendi âœ…";
          adminMsg.className = "ok";
          // form temizle
          document.getElementById('song-name').value = '';
          document.getElementById('song-artist').value = '';
          document.getElementById('song-url').value = '';
          await loadSongs();
        }
      } catch (err) {
        adminMsg.innerText = "Beklenmeyen hata: " + (err.message || err);
        adminMsg.className = "error";
        console.error("Insert exception:", err);
      } finally {
        addSongBtn.disabled = false;
      }
    }

    // ÅžarkÄ±larÄ± yÃ¼kle / listele
    async function loadSongs() {
      songsList.innerHTML = 'YÃ¼kleniyor...';
      try {
        const { data, error } = await supabase
          .from('Songs')
          .select('*')
          .order('id', { ascending: false });

        if (error) {
          songsList.innerHTML = `<li class="error">Liste yÃ¼klenemedi: ${error.message}</li>`;
          console.error("Supabase select error:", error);
          return;
        }

        if (!data || data.length === 0) {
          songsList.innerHTML = '<li class="hint">HenÃ¼z ÅŸarkÄ± yok.</li>';
          return;
        }

        songsList.innerHTML = '';
        data.forEach(s => {
          const li = document.createElement('li');
          li.className = 'song-item';
          // GÃ¼venlik: user tarafÄ±ndan gÃ¶nderilen url'leri direkt koyuyoruz - catbox/cdn linki olduÄŸundan genelde Ã§alÄ±ÅŸÄ±r.
          li.innerHTML = `<strong>${escapeHtml(s.name || '')}</strong> - ${escapeHtml(s.artist || '')}
                          <div style="margin-top:6px">
                            <audio controls preload="none" src="${escapeAttr(s.url || '')}" style="width:100%;max-width:600px"></audio>
                          </div>`;
          songsList.appendChild(li);
        });
      } catch (err) {
        songsList.innerHTML = `<li class="error">Beklenmeyen liste hatasÄ±: ${err.message || err}</li>`;
        console.error(err);
      }
    }

    // Basit escaping yardÄ±mcÄ±larÄ±
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }
    function escapeAttr(text) { return escapeHtml(text); }

    // eventler
    addSongBtn.addEventListener('click', addSong);
    clearBtn.addEventListener('click', () => {
      document.getElementById('song-name').value = '';
      document.getElementById('song-artist').value = '';
      document.getElementById('song-url').value = '';
      adminMsg.innerText = '';
    });

    // baÅŸlat
    init();
  </script>
</body>
</html>
