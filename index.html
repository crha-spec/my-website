<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InstaChat+Music</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#6e8efb,#a777e3);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:20px}
.container{width:100%;max-width:600px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;display:flex;flex-direction:column;margin-top:20px}
.header{background:linear-gradient(90deg,#4b6cb7,#182848);color:white;padding:20px;text-align:center}
.chat-container{padding:20px;height:300px;overflow-y:auto;display:flex;flex-direction:column;flex:1;border-bottom:1px solid #eee}
.message{padding:12px 16px;border-radius:20px;margin-bottom:15px;max-width:80%;word-break:break-word}
.user-message{background:#e3f2fd;align-self:flex-end;border-bottom-right-radius:5px}
.bot-message{background:#f1f0f0;align-self:flex-start;border-bottom-left-radius:5px}
.input-area{display:flex;padding:15px;background:#f9f9f9}
#message-input{flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:25px;outline:none;font-size:16px}
#send-button{background:linear-gradient(90deg,#4b6cb7,#182848);color:white;border:none;border-radius:25px;padding:12px 20px;margin-left:10px;cursor:pointer;transition:all 0.3s ease}
#send-button:hover{background:linear-gradient(90deg,#182848,#4b6cb7);transform:scale(1.05)}
.user-list{padding:10px;border-top:1px solid #eee;background:#f5f5f5;display:flex;flex-wrap:wrap}
.user-item{margin:5px;padding:5px 10px;border-radius:15px;background:#eee;cursor:pointer;position:relative}
.user-item .online-dot{width:10px;height:10px;border-radius:50%;position:absolute;top:5px;right:5px}
.user-item .online-dot.green{background:green}
.user-item .online-dot.grey{background:grey}
#online-count{padding:10px;text-align:center;background:#f5f5f5;font-weight:bold}
.audio-player{margin-top:10px;text-align:center}
.theme-button{margin:5px;padding:5px 10px;border-radius:10px;cursor:pointer;background:#ddd;border:none}
.admin-feature{display:none;}
</style>
<!-- Supabase -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const SUPABASE_URL = "https://zzlrltqrzxjwmtpuvhsi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g";
const supabase = createClient(SUPABASE_URL,SUPABASE_KEY);

const ADMIN_IP = "151.250.4.2"; // admin IP - değiştirilebilir

let userIP = "", uid = "user_" + Math.floor(Math.random()*10000), nickname = "";
let onlineUsers = {};
let isAdmin = false;
let selectedUser = null;

async function init(){
  // IP al
  try{
    const res = await fetch("https://api64.ipify.org?format=json");
    const j = await res.json();
    userIP = j.ip;
    isAdmin = (userIP === ADMIN_IP);
  }catch(e){console.warn("IP alınamadı",e)}

  // Admin kontrollerini göster/gizle
  if(isAdmin) {
    document.querySelectorAll('.admin-feature').forEach(el => {
      el.style.display = 'block';
    });
  }

  // Nickname sor
  nickname = prompt("Bir nickname belirleyin:","Kullanici"+Math.floor(Math.random()*100));
  if(!nickname) nickname = uid;

  // online kullanıcı kaydı
  await supabase.from("online_users").upsert({
    uid, 
    nickname, 
    ip: userIP, 
    last_seen: new Date()
  });

  // Online users update loop
  setInterval(updateOnlineUsers, 2000);
  
  // Mesaj dinleme
  supabase
    .channel('messages')
    .on('postgres_changes', 
      { 
        event: 'INSERT', 
        schema: 'public', 
        table: 'messages',
        filter: `receiver=eq.${uid}` 
      }, 
      (payload) => {
        const msg = payload.new;
        if(msg.sender !== uid) {
          addMessage(`${msg.sender_nickname}: ${msg.text}`, 'bot');
        }
      }
    )
    .subscribe();
}

async function updateOnlineUsers() {
  const { data, error } = await supabase
    .from("online_users")
    .select("*")
    .gt('last_seen', new Date(Date.now() - 10000).toISOString()); // Sadece son 10 saniye içinde aktif olanlar
  
  if(error) {
    console.error("Online kullanıcılar alınamadı:", error);
    return;
  }
  
  onlineUsers = {};
  let count = 0;
  
  data.forEach(u => {
    if(u.uid !== uid) {
      onlineUsers[u.uid] = {nickname: u.nickname, online: true};
      count++;
    }
  });
  
  // Kendimizi de güncelle
  await supabase.from("online_users").upsert({
    uid, 
    nickname, 
    ip: userIP, 
    last_seen: new Date()
  });
  
  renderUsers(count);
}

function renderUsers(count){
  const userListEl = document.getElementById('user-list');
  userListEl.innerHTML = '';
  
  Object.keys(onlineUsers).forEach(k => {
    const u = onlineUsers[k];
    const div = document.createElement('div');
    div.className = 'user-item';
    div.textContent = u.nickname;
    div.onclick = () => selectUser(k, u.nickname);
    
    const dot = document.createElement('div');
    dot.className = 'online-dot green';
    div.appendChild(dot);
    userListEl.appendChild(div);
  });
  
  document.getElementById('online-count').textContent = "Online Kullanıcı: " + count;
}

function selectUser(userId, userName) {
  selectedUser = userId;
  document.getElementById('chat-container').innerHTML = '';
  document.getElementById('online-count').textContent = `${userName} ile sohbet`;
  
  // Önceki mesajları getir
  loadMessages(userId);
}

async function loadMessages(targetUserId) {
  // İki yönlü mesajları getir
  const { data, error } = await supabase
    .from("messages")
    .select("*")
    .or(`and(sender.eq.${uid},receiver.eq.${targetUserId}),and(sender.eq.${targetUserId},receiver.eq.${uid})`)
    .order('timestamp', { ascending: true });
  
  if(error) {
    console.error("Mesajlar yüklenemedi:", error);
    return;
  }
  
  data.forEach(msg => {
    const type = msg.sender === uid ? 'user' : 'bot';
    addMessage(`${msg.sender_nickname}: ${msg.text}`, type);
  });
}

const chatContainer = document.getElementById('chat-container');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

async function sendMessage(){
  if(!selectedUser) {
    alert("Önce bir kullanıcı seçin!");
    return;
  }
  
  const text = messageInput.value.trim();
  if(!text) return;
  
  const { error } = await supabase.from("messages").insert([{
    text, 
    sender: uid,
    sender_nickname: nickname,
    receiver: selectedUser,
    receiver_nickname: onlineUsers[selectedUser].nickname,
    timestamp: new Date()
  }]);
  
  if(error) {
    console.error("Mesaj gönderilemedi:", error);
    return;
  }
  
  addMessage(`${nickname}: ${text}`, 'user');
  messageInput.value = '';
}

function addMessage(text, type){
  const div = document.createElement('div');
  div.className = 'message ' + type + '-message';
  div.textContent = text;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', e => {
  if(e.key === 'Enter') sendMessage();
});

// Tema değiştir (sadece admin)
const themes = [
  {bg:'#6e8efb',gradient:'#a777e3'},
  {bg:'#ff9a9e',gradient:'#fad0c4'},
  {bg:'#a1c4fd',gradient:'#c2e9fb'}
];
let themeIdx=0;
function changeTheme(){
  if(!isAdmin) {
    alert("Sadece admin tema değiştirebilir!");
    return;
  }
  
  themeIdx=(themeIdx+1)%themes.length;
  const t = themes[themeIdx];
  document.body.style.background = `linear-gradient(135deg,${t.bg},${t.gradient})`;
}

// Sayfa yüklendiğinde init çalıştır
window.addEventListener('DOMContentLoaded', init);
</script>
</head>
<body>
<div class="container">
  <div class="header"><h2>InstaChat+Music</h2></div>
  <div id="online-count">Online Kullanıcı: 0</div>
  <div class="user-list" id="user-list"></div>
  <div class="chat-container" id="chat-container"></div>
  <div class="input-area">
    <input type="text" id="message-input" placeholder="Mesajınızı yazın...">
    <button id="send-button">Gönder</button>
  </div>
  <div class="audio-player admin-feature">
    <input type="text" id="song-link" placeholder="Şarkı direct link girin">
    <button onclick="playSong()" class="theme-button">Başlat</button>
    <button onclick="document.getElementById('main-player').pause()" class="theme-button">Durdur</button>
    <audio id="main-player" controls></audio>
    <button onclick="changeTheme()" class="theme-button">Tema Değiştir</button>
  </div>
</div>

<script>
function playSong(){
  const link = document.getElementById('song-link').value.trim();
  if(!link) return;
  const player = document.getElementById('main-player');
  player.src = link;
  player.play();
}
</script>
</body>
</html>
