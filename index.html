<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ki≈üisel M√ºzik K√ºt√ºphanesi</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family:'Segoe UI',sans-serif; background:#667eea; color:#fff; padding:24px; padding-bottom:160px; }
    .app { max-width:1200px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:18px 24px; border-radius:12px; margin-bottom:20px; }
    .sidebar { background:rgba(255,255,255,0.1); padding:12px; border-radius:12px; display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    .sidebar button { padding:10px; border:0; border-radius:8px; background:transparent; color:#fff; cursor:pointer; text-align:left; }
    .sidebar button.active { background:#f72585; }
    .card { background:rgba(0,0,0,0.2); border-radius:12px; padding:18px; margin-top:10px; }
    .controls { display:flex; gap:10px; margin-bottom:10px; }
    input,textarea,select { padding:8px; border-radius:6px; border:0; width:100%; margin-bottom:8px; }
    .btn { padding:6px 12px; border-radius:8px; border:0; cursor:pointer; margin-left:4px; }
    .btn.danger { background:#e63946; color:#fff; }
    .btn.play { background:#4361ee; color:#fff; }
    .btn.edit { background:#f8961e; color:#fff; }
    .song { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.2); }
    #player-bar { position:fixed; left:0; right:0; bottom:0; background:#000; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; }
    #now-playing-lyrics, #user-now-playing-lyrics { white-space:pre-wrap; margin-top:10px; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; }
    .edit-form { display:none; margin-top:10px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>üéµ M√ºzik K√ºt√ºphanesi</div>
    <div><span id="user-type"></span></div>
  </header>

  <!-- Admin Panel -->
  <div id="admin-panel" style="display:none;">
    <h2>Admin Paneli</h2>
    <div class="sidebar">
      <button id="btn-library" class="active">Kitaplƒ±k</button>
      <button id="btn-add-song">≈ûarkƒ± Ekle</button>
      <button id="btn-now-playing">≈ûu An √áalan</button>
    </div>

    <div id="library-section" class="card">
      <div class="controls">
        <input type="text" id="admin-search" placeholder="Ara...">
        <select id="admin-sort">
          <option value="id">En Yeni</option>
          <option value="name">Ada G√∂re</option>
          <option value="artist">Sanat√ßƒ±ya G√∂re</option>
        </select>
      </div>
      <ul id="songs-list"></ul>
    </div>

    <div id="add-song-section" class="card" style="display:none;">
      <input id="song-name" placeholder="≈ûarkƒ± adƒ±">
      <input id="song-artist" placeholder="Sanat√ßƒ±">
      <input id="song-url" placeholder="URL">
      <textarea id="song-lyrics" placeholder="≈ûarkƒ± s√∂zleri (opsiyonel)"></textarea>
      <button id="addSongBtn" class="btn">Ekle</button>
      <div id="admin-msg"></div>
    </div>

    <div id="now-playing-section" class="card" style="display:none;">
      <h3>≈ûu An √áalan</h3>
      <div id="now-playing-info">Hen√ºz ≈üarkƒ± se√ßilmedi</div>
      <div style="margin-top:10px;">
        <button id="prevBtn" class="btn">‚èÆ √ñnceki</button>
        <button id="toggleBtn" class="btn">‚èØ Ba≈ülat/Durdur</button>
        <button id="nextBtn" class="btn">‚è≠ Sonraki</button>
      </div>
      <div id="now-playing-lyrics">Hen√ºz ≈üarkƒ± se√ßilmedi</div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel" style="display:none;">
    <h2>Kullanƒ±cƒ± Paneli</h2>
    <div class="sidebar">
      <button id="user-btn-library" class="active">Kitaplƒ±k</button>
      <button id="user-btn-now-playing">≈ûu An √áalan</button>
    </div>

    <div id="user-library-section" class="card">
      <div class="controls">
        <input type="text" id="user-search" placeholder="Ara...">
        <select id="user-sort">
          <option value="id">En Yeni</option>
          <option value="name">Ada G√∂re</option>
          <option value="artist">Sanat√ßƒ±ya G√∂re</option>
        </select>
      </div>
      <ul id="user-songs-list"></ul>
    </div>

    <div id="user-now-playing-section" class="card" style="display:none;">
      <h3>≈ûu An √áalan</h3>
      <div id="user-now-playing-info">Hen√ºz ≈üarkƒ± se√ßilmedi</div>
      <div style="margin-top:10px;">
        <button id="uPrevBtn" class="btn">‚èÆ √ñnceki</button>
        <button id="uToggleBtn" class="btn">‚èØ Ba≈ülat/Durdur</button>
        <button id="uNextBtn" class="btn">‚è≠ Sonraki</button>
      </div>
      <div id="user-now-playing-lyrics">Hen√ºz ≈üarkƒ± se√ßilmedi</div>
    </div>
  </div>
</div>

<!-- Player -->
<div id="player-bar">
  <div id="player-info">Hen√ºz ≈üarkƒ± se√ßilmedi</div>
  <audio id="main-player" controls></audio>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://zzlrltqrzxjwmtpuvhsi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6bHJsdHFyenhqd210cHV2aHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzU1MTEsImV4cCI6MjA3MzExMTUxMX0.nEW-3ctSbAaQj-d-I01AzkvTM70QzoXBiZmHdC1Yv8g");
const ADMIN_IP="151.250.4.2";
let allSongs=[]; let currentIndex=-1;
const songsList=document.getElementById("songs-list");
const userSongsList=document.getElementById("user-songs-list");
const mainPlayer=document.getElementById("main-player");
const playerInfo=document.getElementById("player-info");
let sortField="id"; let searchTerm="";

// IP kontrol
(async()=>{
  const ip=(await (await fetch("https://api64.ipify.org?format=json")).json()).ip;
  if(ip===ADMIN_IP){document.getElementById("admin-panel").style.display="block"; document.getElementById("user-type").textContent="Admin"; setupAdminButtons();}
  else{document.getElementById("user-panel").style.display="block"; document.getElementById("user-type").textContent="Kullanƒ±cƒ±"; setupUserButtons();}
  loadSongs();
})();

// ≈ûarkƒ± listeleme
async function loadSongs(){
  const {data,error}=await supabase.from("Songs").select("*").order(sortField,{ascending:true});
  if(error){console.error(error);return;}
  allSongs=data;
  const filter=d=>d.name.toLowerCase().includes(searchTerm)||d.artist.toLowerCase().includes(searchTerm);
  renderList(songsList,data.filter(filter),true);
  renderList(userSongsList,data.filter(filter),false);
}
function renderList(list,data,isAdmin){
  list.innerHTML="";
  data.forEach((s,i)=>{
    const li=document.createElement("li"); li.className="song"; li.dataset.id=s.id;
    
    // D√ºzenleme formu
    const editForm = document.createElement("div");
    editForm.className = "edit-form";
    editForm.id = `edit-form-${s.id}`;
    editForm.innerHTML = `
      <input value="${s.name}" id="edit-name-${s.id}" placeholder="≈ûarkƒ± adƒ±">
      <input value="${s.artist}" id="edit-artist-${s.id}" placeholder="Sanat√ßƒ±">
      <input value="${s.url}" id="edit-url-${s.id}" placeholder="URL">
      <textarea id="edit-lyrics-${s.id}" placeholder="≈ûarkƒ± s√∂zleri">${s.lyrics || ''}</textarea>
      <button class="btn save-edit" data-id="${s.id}">Kaydet</button>
      <button class="btn cancel-edit" data-id="${s.id}">ƒ∞ptal</button>
    `;
    
    li.innerHTML=`<div><strong>${s.name}</strong> - ${s.artist}</div>
      <div>
        <button class="btn play" data-index="${i}">√áal</button>
        ${isAdmin?`<button class="btn edit" data-id="${s.id}">D√ºzenle</button><button class="btn danger" data-id="${s.id}">Sil</button>`:""}
      </div>`;
    
    if (isAdmin) {
      li.appendChild(editForm);
    }
    
    list.appendChild(li);
  });
  
  list.querySelectorAll(".play").forEach(b=>b.onclick=()=>playSong(parseInt(b.dataset.index)));
  if(isAdmin){
    list.querySelectorAll(".danger").forEach(b=>b.onclick=()=>deleteSong(b.dataset.id));
    list.querySelectorAll(".edit").forEach(b=>b.onclick=()=>toggleEditForm(b.dataset.id, true));
    list.querySelectorAll(".save-edit").forEach(b=>b.onclick=()=>saveSongEdit(b.dataset.id));
    list.querySelectorAll(".cancel-edit").forEach(b=>b.onclick=()=>toggleEditForm(b.dataset.id, false));
  }
}

// D√ºzenleme formunu g√∂ster/gizle
function toggleEditForm(id, show) {
  const form = document.getElementById(`edit-form-${id}`);
  if (form) {
    form.style.display = show ? 'block' : 'none';
  }
}

// ≈ûarkƒ± d√ºzenlemeyi kaydet
async function saveSongEdit(id) {
  const name = document.getElementById(`edit-name-${id}`).value.trim();
  const artist = document.getElementById(`edit-artist-${id}`).value.trim();
  const url = document.getElementById(`edit-url-${id}`).value.trim();
  const lyrics = document.getElementById(`edit-lyrics-${id}`).value.trim();

  if (!name || !artist || !url) {
    alert("L√ºtfen t√ºm alanlarƒ± doldurun.");
    return;
  }

  const { error } = await supabase
    .from("Songs")
    .update({ name, artist, url, lyrics })
    .eq("id", id);

  if (error) {
    alert("G√ºncelleme hatasƒ±: " + error.message);
  } else {
    alert("‚úÖ ≈ûarkƒ± ba≈üarƒ±yla g√ºncellendi");
    toggleEditForm(id, false);
    loadSongs(); // Listeyi yeniden y√ºkle
  }
}

// √áalma
function playSong(i){
  currentIndex=i;
  const s=allSongs[i]; if(!s) return;
  mainPlayer.src=s.url; mainPlayer.play();
  playerInfo.textContent=`${s.name} - ${s.artist}`;
  document.getElementById("now-playing-info").textContent=`${s.name} - ${s.artist}`;
  document.getElementById("user-now-playing-info").textContent=`${s.name} - ${s.artist}`;

  // ≈ûarkƒ± s√∂zleri
  const lyricsText = s.lyrics && s.lyrics.trim() ? s.lyrics : "Bu ≈üarkƒ±ya s√∂z eklenmemi≈ü.";
  document.getElementById("now-playing-lyrics").textContent=lyricsText;
  document.getElementById("user-now-playing-lyrics").textContent=lyricsText;
}

// √ñnceki/sonraki
function prevSong(){ if(currentIndex>0) playSong(currentIndex-1); }
function nextSong(){ if(currentIndex<allSongs.length-1) playSong(currentIndex+1); }
function togglePlay(){ if(mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); }

// ≈ûarkƒ± silme - D√úZELTƒ∞LMƒ∞≈û VERSƒ∞YON
async function deleteSong(id){
  if(!confirm("Bu ≈üarkƒ±yƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz.")) return;

  try {
    const { error } = await supabase.from("Songs").delete().eq("id", id);
    
    if(error){ 
      alert("Silme hatasƒ±: " + error.message);
      console.error(error);
    } else {
      // ≈ûarkƒ±yƒ± yerel listeden de kaldƒ±r
      allSongs = allSongs.filter(song => song.id !== id);
      
      // Listeleri yeniden y√ºkle
      await loadSongs();
      alert("‚úÖ ≈ûarkƒ± tamamen silindi");
      
      // Eƒüer silinen ≈üarkƒ± √ßalƒ±nƒ±yorsa, √ßalmayƒ± durdur
      if (currentIndex !== -1 && allSongs[currentIndex] && allSongs[currentIndex].id === id) {
        mainPlayer.pause();
        mainPlayer.src = "";
        playerInfo.textContent = "Hen√ºz ≈üarkƒ± se√ßilmedi";
        document.getElementById("now-playing-info").textContent = "Hen√ºz ≈üarkƒ± se√ßilmedi";
        document.getElementById("user-now-playing-info").textContent = "Hen√ºz ≈üarkƒ± se√ßilmedi";
        document.getElementById("now-playing-lyrics").textContent = "Hen√ºz ≈üarkƒ± se√ßilmedi";
        document.getElementById("user-now-playing-lyrics").textContent = "Hen√ºz ≈üarkƒ± se√ßilmedi";
        currentIndex = -1;
      }
    }
  } catch (err) {
    alert("Bir hata olu≈ütu: " + err.message);
    console.error(err);
  }
}

// ≈ûarkƒ± ekleme
async function addSong(){
  const name=document.getElementById("song-name").value.trim();
  const artist=document.getElementById("song-artist").value.trim();
  const url=document.getElementById("song-url").value.trim();
  const lyrics=document.getElementById("song-lyrics").value.trim();
  const msg=document.getElementById("admin-msg");
  if(!name||!artist||!url){msg.textContent="L√ºtfen t√ºm alanlarƒ± doldurun.";return;}
  const {error}=await supabase.from("Songs").insert([{name,artist,url,lyrics}]);
  if(error){ msg.textContent="Hata: "+error.message;}
  else{ 
    msg.textContent="‚úÖ Eklendi"; 
    document.getElementById("song-name").value = "";
    document.getElementById("song-artist").value = "";
    document.getElementById("song-url").value = "";
    document.getElementById("song-lyrics").value = "";
    loadSongs(); 
  }
}
document.getElementById("addSongBtn").onclick=addSong;

// Admin men√º
function setupAdminButtons(){
  const sections=["library-section","add-song-section","now-playing-section"];
  ["btn-library","btn-add-song","btn-now-playing"].forEach((id,i)=>{
    document.getElementById(id).onclick=()=>{
      sections.forEach((s,j)=>{document.getElementById(s).style.display=(i===j?"block":"none");});
      document.querySelectorAll("#admin-panel .sidebar button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };
  });
  document.getElementById("prevBtn").onclick=prevSong;
  document.getElementById("nextBtn").onclick=nextSong;
  document.getElementById("toggleBtn").onclick=togglePlay;
}
// User men√º
function setupUserButtons(){
  const sections=["user-library-section","user-now-playing-section"];
  ["user-btn-library","user-btn-now-playing"].forEach((id,i)=>{
    document.getElementById(id).onclick=()=>{
      sections.forEach((s,j)=>{document.getElementById(s).style.display=(i===j?"block":"none");});
      document.querySelectorAll("#user-panel .sidebar button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };
  });
  document.getElementById("uPrevBtn").onclick=prevSong;
  document.getElementById("uNextBtn").onclick=nextSong;
  document.getElementById("uToggleBtn").onclick=togglePlay;
}

// Arama & sƒ±ralama
document.getElementById("admin-search").oninput=e=>{searchTerm=e.target.value.toLowerCase();loadSongs();}
document.getElementById("user-search").oninput=e=>{searchTerm=e.target.value.toLowerCase();loadSongs();}
document.getElementById("admin-sort").onchange=e=>{sortField=e.target.value;loadSongs();}
document.getElementById("user-sort").onchange=e=>{sortField=e.target.value;loadSongs();}
</script>
</body>
</html>
