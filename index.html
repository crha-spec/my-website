<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiÅŸisel MÃ¼zik KÃ¼tÃ¼phanesi</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family:'Segoe UI',sans-serif; background:#667eea; color:#fff; padding:24px; padding-bottom:160px; }
    .app { max-width:1200px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.1); padding:18px 24px; border-radius:12px; margin-bottom:20px; }
    .sidebar { background:rgba(255,255,255,0.1); padding:12px; border-radius:12px; display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    .sidebar button { padding:10px; border:0; border-radius:8px; background:transparent; color:#fff; cursor:pointer; text-align:left; }
    .sidebar button.active { background:#f72585; }
    .card { background:rgba(0,0,0,0.2); border-radius:12px; padding:18px; margin-top:10px; }
    .controls { display:flex; gap:10px; margin-bottom:10px; }
    input,textarea,select { padding:8px; border-radius:6px; border:0; width:100%; margin-bottom:8px; }
    .btn { padding:6px 12px; border-radius:8px; border:0; cursor:pointer; margin-left:4px; }
    .btn.danger { background:#e63946; color:#fff; }
    .btn.play { background:#4361ee; color:#fff; }
    .btn.edit { background:#f8961e; color:#fff; }
    .btn.approve { background:#2a9d8f; color:#fff; }
    .btn.reject { background:#e76f51; color:#fff; }
    .song { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.2); flex-wrap:wrap; }
    #player-bar { position:fixed; left:0; right:0; bottom:0; background:#000; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; }
    #now-playing-lyrics, #user-now-playing-lyrics { white-space:pre-wrap; margin-top:10px; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>ğŸµ MÃ¼zik KÃ¼tÃ¼phanesi</div>
    <div><span id="user-type"></span></div>
  </header>

  <!-- Admin Panel -->
  <div id="admin-panel" style="display:none;">
    <h2>Admin Paneli</h2>
    <div class="sidebar">
      <button id="btn-library" class="active">KitaplÄ±k</button>
      <button id="btn-add-song">ÅarkÄ± Ekle</button>
      <button id="btn-requests">ÅarkÄ± Ä°stekleri</button>
      <button id="btn-now-playing">Åu An Ã‡alan</button>
    </div>

    <div id="library-section" class="card">
      <h3>KitaplÄ±k</h3>
      <div class="controls">
        <input type="text" id="admin-search" placeholder="Ara...">
        <select id="admin-sort">
          <option value="id">En Yeni</option>
          <option value="name">Ada GÃ¶re</option>
          <option value="artist">SanatÃ§Ä±ya GÃ¶re</option>
        </select>
      </div>
      <ul id="songs-list"></ul>
    </div>

    <div id="add-song-section" class="card" style="display:none;">
      <h3>ÅarkÄ± Ekle</h3>
      <input id="song-name" placeholder="ÅarkÄ± adÄ±">
      <input id="song-artist" placeholder="SanatÃ§Ä±">
      <input id="song-url" placeholder="URL">
      <textarea id="song-lyrics" placeholder="ÅarkÄ± sÃ¶zleri (opsiyonel)"></textarea>
      <input id="song-cover" placeholder="Kapak fotoÄŸrafÄ± URL (opsiyonel)">
      <button id="addSongBtn" class="btn">Ekle</button>
      <div id="admin-msg"></div>
    </div>

    <div id="requests-section" class="card" style="display:none;">
      <h3>ÅarkÄ± Ä°stekleri</h3>
      <ul id="requests-list"></ul>
    </div>

    <div id="now-playing-section" class="card" style="display:none;">
      <h3>Åu An Ã‡alan</h3>
      <div id="now-playing-info">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
      <div style="margin-top:10px;">
        <button id="prevBtn" class="btn">â® Ã–nceki</button>
        <button id="toggleBtn" class="btn">â¯ BaÅŸlat/Durdur</button>
        <button id="nextBtn" class="btn">â­ Sonraki</button>
      </div>
      <div id="now-playing-lyrics">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
    </div>
  </div>

  <!-- User Panel -->
  <div id="user-panel" style="display:none;">
    <h2>KullanÄ±cÄ± Paneli</h2>
    <div class="sidebar">
      <button id="user-btn-library" class="active">KitaplÄ±k</button>
      <button id="user-btn-request">ÅarkÄ± Ä°steÄŸi</button>
      <button id="user-btn-now-playing">Åu An Ã‡alan</button>
    </div>

    <div id="user-library-section" class="card">
      <h3>KitaplÄ±k</h3>
      <div class="controls">
        <input type="text" id="user-search" placeholder="Ara...">
        <select id="user-sort">
          <option value="id">En Yeni</option>
          <option value="name">Ada GÃ¶re</option>
          <option value="artist">SanatÃ§Ä±ya GÃ¶re</option>
        </select>
      </div>
      <ul id="user-songs-list"></ul>
    </div>

    <div id="user-request-section" class="card" style="display:none;">
      <h3>ÅarkÄ± Ä°steÄŸi GÃ¶nder</h3>
      <input id="req-name" placeholder="ÅarkÄ± adÄ±">
      <input id="req-artist" placeholder="SanatÃ§Ä±">
      <input id="req-url" placeholder="ÅarkÄ± URL (catbox.moe)">
      <textarea id="req-lyrics" placeholder="ÅarkÄ± sÃ¶zleri (opsiyonel)"></textarea>
      <input id="req-cover" placeholder="Kapak URL (opsiyonel)">
      <button id="sendRequestBtn" class="btn">Ä°stek GÃ¶nder</button>
      <div id="req-msg"></div>
    </div>

    <div id="user-now-playing-section" class="card" style="display:none;">
      <h3>Åu An Ã‡alan</h3>
      <div id="user-now-playing-info">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
      <div style="margin-top:10px;">
        <button id="uPrevBtn" class="btn">â® Ã–nceki</button>
        <button id="uToggleBtn" class="btn">â¯ BaÅŸlat/Durdur</button>
        <button id="uNextBtn" class="btn">â­ Sonraki</button>
      </div>
      <div id="user-now-playing-lyrics">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
    </div>
  </div>
</div>

<!-- Player -->
<div id="player-bar">
  <div id="player-info">HenÃ¼z ÅŸarkÄ± seÃ§ilmedi</div>
  <audio id="main-player" controls></audio>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://zzlrltqrzxjwmtpuvhsi.supabase.co", "YOUR_SUPABASE_ANON_KEY");
const ADMIN_IP="151.250.4.2";
let allSongs=[]; let currentIndex=-1;

// Elementler
const songsList=document.getElementById("songs-list");
const userSongsList=document.getElementById("user-songs-list");
const mainPlayer=document.getElementById("main-player");
const playerInfo=document.getElementById("player-info");

// Admin / User ayrÄ±mÄ±
(async()=>{
  const ip=(await (await fetch("https://api64.ipify.org?format=json")).json()).ip;
  if(ip===ADMIN_IP){
    let pass=prompt("Admin ÅŸifresini gir:");
    if(pass==="efkaza7634"){
      document.getElementById("admin-panel").style.display="block";
      document.getElementById("user-type").textContent="Admin";
      setupAdminButtons();
    } else {
      alert("âŒ YanlÄ±ÅŸ ÅŸifre!");
      document.getElementById("user-panel").style.display="block";
      document.getElementById("user-type").textContent="KullanÄ±cÄ±";
      setupUserButtons();
    }
  } else {
    document.getElementById("user-panel").style.display="block";
    document.getElementById("user-type").textContent="KullanÄ±cÄ±";
    setupUserButtons();
  }
  loadSongs();
  loadRequests();
})();

// ÅarkÄ± listeleme
async function loadSongs(){
  const {data,error}=await supabase.from("songs").select("*").order("id",{ascending:false});
  if(error) return console.error(error);
  allSongs=data;
  renderList(songsList,data,true);
  renderList(userSongsList,data,false);
}
function renderList(list,data,isAdmin){
  list.innerHTML="";
  data.forEach((s,i)=>{
    const li=document.createElement("li"); li.className="song";
    li.innerHTML=`<div><strong>${s.name}</strong> - ${s.artist}</div>
      <div>
        <button class="btn play" data-index="${i}">Ã‡al</button>
        ${isAdmin?`<button class="btn edit" data-id="${s.id}">DÃ¼zenle</button><button class="btn danger" data-id="${s.id}">Sil</button>`:""}
      </div>`;
    list.appendChild(li);
  });
  list.querySelectorAll(".play").forEach(b=>b.onclick=()=>playSong(parseInt(b.dataset.index)));
  if(isAdmin){
    list.querySelectorAll(".danger").forEach(b=>b.onclick=()=>deleteSong(b.dataset.id));
    list.querySelectorAll(".edit").forEach(b=>b.onclick=()=>editSong(b.dataset.id));
  }
}

// Ã‡alma
function playSong(i){
  currentIndex=i; const s=allSongs[i]; if(!s) return;
  mainPlayer.src=s.url; mainPlayer.play();
  playerInfo.textContent=`${s.name} - ${s.artist}`;
  document.getElementById("now-playing-info").textContent=playerInfo.textContent;
  document.getElementById("user-now-playing-info").textContent=playerInfo.textContent;
  document.getElementById("now-playing-lyrics").textContent=s.lyrics||"Bu ÅŸarkÄ±ya sÃ¶z eklenmemiÅŸ.";
  document.getElementById("user-now-playing-lyrics").textContent=s.lyrics||"Bu ÅŸarkÄ±ya sÃ¶z eklenmemiÅŸ.";
}

// Silme
async function deleteSong(id){
  if(!confirm("Silinsin mi?")) return;
  await supabase.from("songs").delete().eq("id",id);
  loadSongs();
}

// DÃ¼zenleme
async function editSong(id){
  const song=allSongs.find(s=>s.id==id); if(!song) return;
  const newName=prompt("ÅarkÄ± adÄ±:",song.name); if(!newName) return;
  const newArtist=prompt("SanatÃ§Ä±:",song.artist); if(!newArtist) return;
  const newUrl=prompt("URL:",song.url); if(!newUrl) return;
  const newLyrics=prompt("SÃ¶zler:",song.lyrics||"");
  const newCover=prompt("Kapak URL:",song.cover_url||"");
  await supabase.from("songs").update({name:newName,artist:newArtist,url:newUrl,lyrics:newLyrics,cover_url:newCover}).eq("id",id);
  loadSongs();
}

// ÅarkÄ± ekleme
document.getElementById("addSongBtn").onclick=async()=>{
  const name=document.getElementById("song-name").value.trim();
  const artist=document.getElementById("song-artist").value.trim();
  const url=document.getElementById("song-url").value.trim();
  const lyrics=document.getElementById("song-lyrics").value.trim();
  const cover_url=document.getElementById("song-cover").value.trim();
  await supabase.from("songs").insert([{name,artist,url,lyrics,cover_url}]);
  loadSongs();
};

// KullanÄ±cÄ± ÅŸarkÄ± isteÄŸi
document.getElementById("sendRequestBtn").onclick=async()=>{
  const name=document.getElementById("req-name").value.trim();
  const artist=document.getElementById("req-artist").value.trim();
  const file_url=document.getElementById("req-url").value.trim();
  const lyrics=document.getElementById("req-lyrics").value.trim();
  const cover_url=document.getElementById("req-cover").value.trim();
  const msg=document.getElementById("req-msg");
  if(!name||!artist||!file_url){msg.textContent="âŒ TÃ¼m alanlarÄ± doldurun";return;}
  const {error}=await supabase.from("songrequests").insert([{name,artist,file_url,lyrics,cover_url}]);
  if(error){ msg.textContent="âŒ Hata: "+error.message; }
  else{ msg.textContent="âœ… Ä°stek gÃ¶nderildi!"; loadRequests(); }
};

// Admin istekler
async function loadRequests(){
  const {data,error}=await supabase.from("songrequests").select("*").order("id",{ascending:false});
  if(error) return;
  const list=document.getElementById("requests-list"); list.innerHTML="";
  data.forEach(r=>{
    const li=document.createElement("li"); li.className="song";
    li.innerHTML=`<div><strong>${r.name}</strong> - ${r.artist}</div>
      <div>
        <audio controls src="${r.file_url}"></audio>
        <a href="${r.file_url}" download class="btn">Ä°ndir</a>
        <button class="btn approve">Onayla</button>
        <button class="btn reject">Reddet</button>
      </div>`;
    list.appendChild(li);
    li.querySelector(".approve").onclick=async()=>{
      const {error}=await supabase.rpc("approve_request",{req_id:r.id});
      if(error){alert("Onay hatasÄ±: "+error.message);return;}
      await loadSongs(); await loadRequests();
      const idx = allSongs.findIndex(s=>s.url===r.file_url && s.name===r.name);
      if(idx>=0) playSong(idx); else if(allSongs.length>0) playSong(0);
    };
    li.querySelector(".reject").onclick=async()=>{
      const {error}=await supabase.rpc("reject_request",{req_id:r.id});
      if(error){alert("Reddetme hatasÄ±: "+error.message);return;}
      await loadRequests();
    };
  });
}

// MenÃ¼ setup
function setupAdminButtons(){
  const sections=["library-section","add-song-section","requests-section","now-playing-section"];
["btn-library","btn-add-song","btn-requests","btn-now-playing"].forEach((id,i)=>{
    document.getElementById(id).onclick=()=>{
      sections.forEach((s,j)=>{
        document.getElementById(s).style.display=(i===j?"block":"none");
      });
      document.querySelectorAll("#admin-panel .sidebar button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };
  });
}

function setupUserButtons(){
  const sections=["user-library-section","user-request-section","user-now-playing-section"];
  ["user-btn-library","user-btn-request","user-btn-now-playing"].forEach((id,i)=>{
    document.getElementById(id).onclick=()=>{
      sections.forEach((s,j)=>{
        document.getElementById(s).style.display=(i===j?"block":"none");
      });
      document.querySelectorAll("#user-panel .sidebar button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };
  });
}

// Ã‡alar kontrolleri
document.getElementById("prevBtn").onclick=()=>{ if(currentIndex>0) playSong(currentIndex-1); };
document.getElementById("nextBtn").onclick=()=>{ if(currentIndex<allSongs.length-1) playSong(currentIndex+1); };
document.getElementById("toggleBtn").onclick=()=>{ if(mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); };
document.getElementById("uPrevBtn").onclick=()=>{ if(currentIndex>0) playSong(currentIndex-1); };
document.getElementById("uNextBtn").onclick=()=>{ if(currentIndex<allSongs.length-1) playSong(currentIndex+1); };
document.getElementById("uToggleBtn").onclick=()=>{ if(mainPlayer.paused) mainPlayer.play(); else mainPlayer.pause(); };
</script>
</body>
</html>
